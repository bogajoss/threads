import{a as xe}from"./rolldown-runtime-BaZ8gS7u.js";import{_ as ke,l as Se,v as Ie,w as Pe}from"./framework-3lkjbTvb.js";import{a as ze,r as Re}from"./query-CZHA9T67.js";import"./database-COznt_u0.js";import{At as Ae,Hn as Fe,Ht as De,In as Ue,Kn as Le,Ln as le,Mn as Te,Nn as We,Nt as Oe,Qt as He,Rt as Me,Ut as $e,Wn as Ee,Yn as qe,an as Ve,wn as Ke,xn as Ge}from"./ui-libs-oBja7Jpd.js";import"./media-libs-C98UjHPF.js";import{Dt as Je,Fn as ie,G as oe,In as z,J as ce,K as de,Mt as Qe,Nt as Ye,Ot as Be,Pn as Xe,Ut as R,Y as Ze,bn as _e,cn as et,dn as tt,in as ue,j as st,jt as at,ln as rt,nn as he,pn as nt,q as N,rn as me,yt as lt}from"./index-ZH7yetGe.js";import{n as A,t as it}from"./actionsheet-CMjDrj2l.js";import{t as ot}from"./useAutoResizeTextArea-Cy81bKnl.js";import{t as ct}from"./CircularProgress-D6LSDhdS.js";var r=xe(Pe(),1),e=xe(Se(),1),dt=()=>{const g=Ie(),F=ke(),{currentUser:o}=tt(),v=o?.isPro?2500:500,{addPost:pe}=et(),{addToast:u}=rt(),fe=ze(),h=F.state?.isStory||!1,d=o?`create-post-draft:${o.id}:${h?"story":"post"}`:null,w=(0,r.useRef)(!1),[c,V]=(0,r.useState)(""),[b,K]=(0,r.useState)(""),[m,C]=(0,r.useState)([]),[G,J]=(0,r.useState)({}),[k,Q]=(0,r.useState)({}),[Y,B]=(0,r.useState)({}),[D,U]=(0,r.useState)(!1),[x,L]=(0,r.useState)(null),{data:S=[]}=Re({queryKey:["user-communities",o?.id],queryFn:()=>_e(o.id),enabled:!!o?.id}),y=r.useMemo(()=>S.filter(t=>!t.isPrivate||t.myRole==="admin"),[S]);(0,r.useEffect)(()=>{if(S.length>0&&!x){const t=F.state?.initialCommunity,s=d?sessionStorage.getItem(d):null;let a=null;try{s&&(a=JSON.parse(s).selectedCommunityId)}catch{}const n=t?.id||a;if(n){const l=y.find(i=>i.id===n);l?L(l):u("You don't have permission to post in that community.","error")}}},[S,y,x,F.state?.initialCommunity,d,u]);const[p,X]=(0,r.useState)("anyone"),[ge,T]=(0,r.useState)(!1),[W,I]=(0,r.useState)(""),[O,H]=(0,r.useState)(null),[Z,M]=(0,r.useState)(null),[_,ee]=(0,r.useState)(null),[be,j]=(0,r.useState)(!1),je=ot(c,44,400),te=(0,r.useRef)(null),se=(0,r.useRef)(null);(0,r.useEffect)(()=>{o||g("/login")},[o,g]),(0,r.useEffect)(()=>{if(!d||w.current)return;const t=sessionStorage.getItem(d);if(!t){w.current=!0;return}try{const s=JSON.parse(t);V(s.postContent||""),K(s.hashtags||""),X(s.replySetting||"anyone"),s.selectedCommunityId&&L({id:s.selectedCommunityId})}catch(s){console.error("Failed to restore create post draft",s),sessionStorage.removeItem(d)}finally{w.current=!0}},[d]),(0,r.useEffect)(()=>{if(!d||!w.current)return;const t={postContent:c,hashtags:b,replySetting:p,selectedCommunityId:x?.id||null};if(!t.postContent.trim()&&!t.hashtags.trim()&&!t.selectedCommunityId&&t.replySetting==="anyone"){sessionStorage.removeItem(d);return}sessionStorage.setItem(d,JSON.stringify(t))},[d,b,c,p,x?.id]);const ve=async t=>{if(!t.target.files)return;const s=Array.from(t.target.files).map(a=>({id:Math.random().toString(36).substring(2,11),file:a}));C(a=>[...a,...s]);for(const a of s)if(a.file.type.startsWith("video/"))try{const{thumbnail:n,duration:l}=await ie(a.file),i=URL.createObjectURL(n);J(f=>({...f,[a.id]:i})),B(f=>({...f,[a.id]:l}))}catch(n){console.error("Thumbnail generation failed",n)}},ye=async t=>{const s=t.clipboardData.files;if(s&&s.length>0){const a=Array.from(s).filter(n=>n.type.startsWith("image/")||n.type.startsWith("video/"));if(a.length>0){t.preventDefault();const n=a.map(l=>({id:Math.random().toString(36).substring(2,11),file:l}));C(l=>[...l,...n]);for(const l of n)if(l.file.type.startsWith("video/"))try{const{thumbnail:i,duration:f}=await ie(l.file),E=URL.createObjectURL(i);J(q=>({...q,[l.id]:E})),B(q=>({...q,[l.id]:f}))}catch(i){console.error("Thumbnail generation failed",i)}u(`Added ${n.length} image(s) from clipboard!`,"success")}}},Ne=t=>{if(!t.target.files||!_)return;const s=t.target.files[0];Q(a=>({...a,[_]:s})),ee(null)},we=t=>{C(s=>s.filter(a=>a.id!==t)),Q(s=>{const a={...s};return delete a[t],a})},ae=()=>{if(W.trim()){const t=W.trim().replace(/^#/,"");K(s=>s?s.includes(t)?s:`${s}, ${t}`:t),I(""),T(!1),u(`Hashtag #${t} added!`)}},Ce=t=>{const s=new File([t],`cropped-${Date.now()}.jpg`,{type:"image/jpeg"});Z&&C(a=>a.map(n=>n.id===Z?{...n,file:s}:n)),H(null),M(null)},re=async(t=!1)=>{if(o&&!(!c.trim()&&m.length===0)&&!(c.length>v)){U(!0);try{const s=[];for(let l=0;l<m.length;l++){const i=m[l],f=k[i.id]||null,E=await Xe(i.file,"media",f);s.push(E)}let a=c;if(b.trim()){const l=b.split(",").map(i=>i.trim()).filter(i=>i.length>0).map(i=>i.startsWith("#")?i:`#${i}`).join(" ");a+=`

${l}`}let n=t?"reel":"text";if(!t&&s.length>0&&(n=s[0].type==="video"?"video":"image"),h){if(s.length===0){u("Please add media for your story.","error"),U(!1);return}await nt(o.id,s[0].url,s[0].type,c),fe.invalidateQueries({queryKey:["stories"]}),u("Story shared!")}else await pe({content:a,media:s,type:n,userId:o.id,communityId:x?.id||null}),u(t?"Reel published!":"Post published!");d&&sessionStorage.removeItem(d),g("/")}catch(s){console.error("Failed to create post:",s),u("Failed to publish content.","error")}finally{U(!1)}}};if(!o)return null;const P=!c.trim()&&m.length===0||D||c.length>v,$=v-c.length,ne=c.length>v-20;return(0,e.jsxs)("div",{className:"flex flex-col h-screen bg-[--background] text-[--foreground] md:rounded-xl",children:[(0,e.jsxs)("div",{className:"flex items-center justify-between px-6 py-4 bg-[--background]/90 backdrop-blur-xl z-20 border-b border-[--border] rounded-t-xl shrink-0",children:[(0,e.jsx)("button",{onClick:()=>g(-1),className:"text-[15px] font-medium text-neutral-500 hover:text-[--foreground] transition-colors",children:"Cancel"}),(0,e.jsx)("h1",{className:"text-[17px] font-bold tracking-tight",children:h?"Add to Story":"Create post"}),(0,e.jsx)("button",{onClick:()=>j(!0),className:"text-[--foreground] p-1.5 hover:bg-neutral-100 dark:hover:bg-neutral-800 rounded-full transition-all",children:(0,e.jsx)(Le,{size:22})})]}),(0,e.jsx)("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:(0,e.jsxs)("div",{className:"flex px-6 pt-6",children:[(0,e.jsx)("div",{className:"flex flex-col items-center mr-4 pt-1",children:(0,e.jsxs)(he,{className:"w-10 h-10 border-[3px] border-[--background] ring-1 ring-[--border]",children:[(0,e.jsx)(ue,{src:o.avatar,className:"object-cover"}),(0,e.jsx)(me,{children:o.name?.[0].toUpperCase()})]})}),(0,e.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,e.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,e.jsx)("span",{className:"font-bold text-[15px] tracking-tight hover:underline cursor-pointer",children:o.name}),!h&&y.length>0&&(0,e.jsxs)(oe,{onValueChange:t=>{L(y.find(s=>s.id===t)||null)},value:x?.id||"none",children:[(0,e.jsxs)(ce,{className:"h-7 px-3 py-0 border-none bg-neutral-100 dark:bg-neutral-900 text-[12px] font-bold rounded-full w-auto gap-1.5 focus:ring-0 hover:bg-neutral-200 dark:hover:bg-neutral-800 transition-colors",children:[!x&&(0,e.jsx)(Oe,{size:12,className:"text-neutral-500"}),(0,e.jsx)(Ze,{placeholder:"Anyone"})]}),(0,e.jsxs)(de,{align:"end",className:"bg-[--background] border-[--border] shadow-xl rounded-xl",children:[(0,e.jsx)(N,{value:"none",className:"text-xs font-medium py-2.5",children:(0,e.jsxs)("div",{className:"flex items-center gap-2",children:[(0,e.jsx)("div",{className:"w-5 h-5 rounded-full bg-neutral-100 dark:bg-neutral-800 flex items-center justify-center",children:(0,e.jsx)(le,{size:12,className:"text-neutral-500"})}),(0,e.jsx)("span",{children:"Public (Anyone)"})]})}),y.map(t=>(0,e.jsx)(N,{value:t.id,className:"text-xs font-medium py-2.5",children:(0,e.jsxs)("div",{className:"flex items-center gap-2",children:[(0,e.jsxs)(he,{className:"w-5 h-5",children:[(0,e.jsx)(ue,{src:t.avatar}),(0,e.jsx)(me,{className:"text-[8px]",children:t.name?.[0].toUpperCase()})]}),(0,e.jsx)("span",{children:t.name})]})},t.id))]})]})]}),(0,e.jsxs)("div",{className:"relative",children:[(0,e.jsx)("textarea",{ref:je,placeholder:h?"Add a caption... (optional)":"What's new?",value:c,onChange:t=>V(t.target.value),onPaste:ye,className:z("w-full bg-transparent text-[--foreground] placeholder-neutral-500 outline-none resize-none text-[16px] leading-relaxed min-h-[44px] mb-1 transition-colors",$<0&&"text-rose-500")}),c.length>0&&(0,e.jsxs)("div",{className:"absolute right-0 bottom-2 flex items-center gap-3",children:[(0,e.jsx)(ct,{current:c.length,max:v,size:22,strokeWidth:2.5,isWarning:ne}),ne&&(0,e.jsx)("span",{className:z("text-[11px] font-bold",$<0?"text-rose-500":"text-neutral-500"),children:$})]})]}),m.length>0&&(0,e.jsxs)("div",{className:"flex overflow-x-auto gap-3.5 mb-5 mt-2 pb-1 scrollbar-hide snap-x",children:[m.map(t=>(0,e.jsxs)("div",{className:"relative shrink-0 w-[260px] h-[340px] rounded-2xl overflow-hidden border border-[--border] bg-neutral-100 dark:bg-neutral-900 snap-start shadow-md group",children:[t.file.type.startsWith("video/")?(0,e.jsxs)(e.Fragment,{children:[k[t.id]||G[t.id]?(0,e.jsx)("img",{src:k[t.id]?URL.createObjectURL(k[t.id]):G[t.id],className:"w-full h-full object-cover",alt:"Video thumbnail"}):(0,e.jsx)("video",{src:URL.createObjectURL(t.file),className:"w-full h-full object-cover bg-zinc-900",muted:!0,playsInline:!0,"webkit-playsinline":"true"}),(0,e.jsx)("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent flex flex-col justify-end p-4 transition-all duration-300",children:(0,e.jsxs)("div",{className:"flex items-center justify-between",children:[(0,e.jsxs)("button",{type:"button",onClick:s=>{s.stopPropagation(),ee(t.id),te.current?.click()},className:"text-[11px] font-bold text-white bg-black/60 backdrop-blur-xl px-3 py-2 rounded-full flex items-center gap-2 hover:bg-black/80 transition-colors shadow-lg border border-white/10",children:[(0,e.jsx)(We,{size:14}),(0,e.jsx)("span",{children:"Change Cover"})]}),Y[t.id]&&(0,e.jsxs)("div",{className:"flex items-center gap-1.5 rounded-lg bg-black/60 px-2 py-1.5 text-[10px] font-bold text-white backdrop-blur-md border border-white/10 shadow-lg",children:[(0,e.jsx)(Ve,{size:10,className:"fill-white",strokeWidth:0}),(0,e.jsx)("span",{className:"tabular-nums tracking-wider",children:Y[t.id]})]})]})})]}):(0,e.jsx)("img",{src:URL.createObjectURL(t.file),alt:"preview",className:"w-full h-full object-cover"}),(0,e.jsxs)("div",{className:"absolute top-3.5 right-3.5 flex items-center gap-2 z-10",children:[!t.file.type.startsWith("video/")&&(0,e.jsx)("button",{onClick:()=>{H(URL.createObjectURL(t.file)),M(t.id)},className:"bg-black/50 backdrop-blur-lg text-white rounded-full p-2 hover:bg-[--primary] transition-all shadow-xl group-hover:scale-110 active:scale-90",title:"Crop Image",children:(0,e.jsx)(qe,{size:18})}),(0,e.jsx)("button",{onClick:()=>we(t.id),className:"bg-black/50 backdrop-blur-lg text-white rounded-full p-2 hover:bg-rose-500 transition-all shadow-xl group-hover:scale-110 active:scale-90",title:"Remove",children:(0,e.jsx)(Ae,{size:18})})]})]},t.id)),(0,e.jsx)("input",{type:"file",ref:te,className:"hidden",accept:"image/*",onChange:Ne})]}),(0,e.jsxs)("div",{className:"flex items-center gap-7 mt-3 text-neutral-400",children:[(0,e.jsx)("button",{onClick:()=>se.current?.click(),className:"hover:text-[--foreground] transition-all p-1 hover:scale-110 active:scale-90",title:"Add Image/Video",children:(0,e.jsx)(Te,{size:22,strokeWidth:2.2})}),!h&&(0,e.jsx)("button",{disabled:!0,className:"hover:text-[--foreground] transition-all p-1 opacity-30 cursor-not-allowed",title:"Poll (Coming Soon)",children:(0,e.jsx)($e,{size:22,strokeWidth:2.2})}),!h&&(0,e.jsxs)(Je,{open:ge,onOpenChange:t=>{T(t),t||I("")},children:[(0,e.jsx)(Ye,{asChild:!0,children:(0,e.jsx)("button",{className:"hover:text-[--foreground] transition-all p-1 hover:scale-110 active:scale-90",title:"Add Hashtag",children:(0,e.jsx)(Ue,{size:22,strokeWidth:2.2})})}),(0,e.jsxs)(Be,{className:"sm:max-w-[400px]",children:[(0,e.jsx)(at,{children:(0,e.jsx)(Qe,{children:"Add Hashtag"})}),(0,e.jsxs)("div",{className:"flex flex-col gap-4 py-4",children:[(0,e.jsx)("input",{type:"text",value:W,onChange:t=>I(t.target.value.replace(/^#/,"")),onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),ae())},placeholder:"e.g. technology, news, sports",className:"w-full rounded-xl border border-[--border] bg-[--background] px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-[--primary]",autoFocus:!0}),(0,e.jsxs)("div",{className:"flex gap-2",children:[(0,e.jsx)(R,{onClick:()=>{T(!1),I("")},variant:"secondary",className:"flex-1",children:"Cancel"}),(0,e.jsx)(R,{onClick:ae,className:"flex-1",children:"Add Hashtag"})]})]})]})]}),(0,e.jsx)("button",{className:"hover:text-[--foreground] transition-all p-1 opacity-30 cursor-not-allowed",title:"Location",children:(0,e.jsx)(Ge,{size:22,strokeWidth:2.2})})]}),b&&(0,e.jsx)("div",{className:"mt-4 flex flex-wrap gap-2.5",children:b.split(",").map((t,s)=>(0,e.jsxs)("span",{className:"text-[13px] font-bold text-blue-500 bg-blue-500/10 px-3 py-1 rounded-full border border-blue-500/20",children:["#",t.trim().replace(/^#/,"")]},s))})]})]})}),(0,e.jsxs)("div",{className:"flex items-center justify-between px-6 py-5 bg-[--background] border-t border-[--border] z-20 shrink-0",children:[(0,e.jsxs)(oe,{value:p,onValueChange:X,children:[(0,e.jsxs)(ce,{className:"border-none bg-transparent p-0 h-auto w-auto text-neutral-500 text-[14px] font-semibold hover:text-[--foreground] transition-colors gap-1.5 focus:ring-0",children:[p==="anyone"&&(0,e.jsx)(le,{size:14}),p==="following"&&(0,e.jsx)(Me,{size:14}),p==="mentioned"&&(0,e.jsx)(Ke,{size:14}),(0,e.jsxs)("span",{className:"capitalize",children:[p.replace("-"," ")," can reply"]})]}),(0,e.jsxs)(de,{align:"start",className:"bg-[--background] border-[--border] shadow-2xl rounded-2xl p-1.5",children:[(0,e.jsx)(N,{value:"anyone",className:"rounded-xl py-3 px-4 font-bold",children:"Anyone"}),(0,e.jsx)(N,{value:"following",className:"rounded-xl py-3 px-4 font-bold",children:"Profiles you follow"}),(0,e.jsx)(N,{value:"mentioned",className:"rounded-xl py-3 px-4 font-bold",children:"Mentioned only"})]})]}),(0,e.jsxs)("div",{className:"flex items-center gap-2",children:[!h&&m.some(t=>t.file.type.startsWith("video/"))&&(0,e.jsx)(R,{onClick:()=>re(!0),disabled:P,loading:D,variant:"secondary",className:z("min-w-[90px] h-11 shadow-xl transition-all active:scale-95 text-[15px] border-zinc-200 dark:border-zinc-800 font-bold",P&&"opacity-50"),children:"Reel"}),!o?.isPro&&c.length>500?(0,e.jsx)(st,{label:"Post",hoverLabel:"Go Pro!",onClick:()=>{g("/pro"),u("Pro users get 2500 character limit!","info")},className:"min-w-[120px] h-11"}):(0,e.jsx)(R,{onClick:()=>re(!1),disabled:P,loading:D,className:z("min-w-[90px] h-11 shadow-xl transition-all active:scale-95 text-[15px]",P?"bg-neutral-100 text-neutral-400 dark:bg-neutral-900 dark:text-neutral-600 shadow-none":"shadow-[--primary]/20 bg-black text-white dark:bg-white dark:text-black"),children:h?"Share Story":"Post"})]})]}),(0,e.jsx)("input",{type:"file",ref:se,onChange:ve,multiple:!0,className:"hidden",accept:"image/*,video/*"}),O&&(0,e.jsx)(lt,{src:O,isOpen:!!O,onClose:()=>{H(null),M(null)},onCropComplete:Ce}),(0,e.jsxs)(it,{isOpen:be,onClose:()=>j(!1),title:"Post Options",children:[(0,e.jsx)(A,{icon:(0,e.jsx)(Fe,{size:20}),onClick:()=>{u("Draft saved (Simulated)"),j(!1)},children:"Save as draft"}),(0,e.jsx)(A,{icon:(0,e.jsx)(He,{size:20}),onClick:()=>{u("Settings coming soon"),j(!1)},children:"Post settings"}),(0,e.jsx)(A,{icon:(0,e.jsx)(Ee,{size:20}),onClick:()=>{u("Visibility settings coming soon"),j(!1)},children:"Who can see this"}),(0,e.jsx)("div",{className:"h-px bg-[--border] my-1 mx-6"}),(0,e.jsx)(A,{variant:"destructive",icon:(0,e.jsx)(De,{size:20}),onClick:()=>{confirm("Discard this post?")&&g(-1),j(!1)},children:"Discard post"})]})]})},yt=dt;export{yt as default};
