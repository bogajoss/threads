import{a as ne}from"./rolldown-runtime-BaZ8gS7u.js";import{T as re,b as ie,s as Z,v as le,x as ce,y as G}from"./framework-DIDnLsp9.js";import{a as oe,n as te,r as I,t as U}from"./query-DNidMcz3.js";import{Bt as ue,Ct as de,Et as fe,Ft as me,Ht as ge,It as he,Jt as ae,Lt as ye,Mt as pe,Ot as Pe,Pt as ve,Rt as we,St as Ce,Tt as Me,Ut as be,Wt as Se,Xt as X,Zt as se,bt as Fe,ft as Le,gt as Y,ht as _e,i as ke,jt as qe,mt as $e,pt as ee,wt as De,xt as Ne,yt as Re,zt as Qe}from"./index-DONeHNx1.js";var xe=Z(),q=ne(re(),1);const at=(e,s,i,o)=>{const t=(0,xe.c)(92),a=oe();let n;t[0]!==s?(n=s||{comments:0,likes:0,mirrors:0,reposts:0},t[0]=s,t[1]=n):n=t[1];const[y,l]=(0,q.useState)(n);let S,r;t[2]!==s?(S=()=>{s&&l(h=>({...h,...s}))},r=[s],t[2]=s,t[3]=S,t[4]=r):(S=t[3],r=t[4]),(0,q.useEffect)(S,r);const m=i?.id;let p;t[5]!==e||t[6]!==m?(p=["post",e,"liked",m],t[5]=e,t[6]=m,t[7]=p):p=t[7];let P;t[8]!==i?.id||t[9]!==e?(P=()=>qe(e,i?.id),t[8]=i?.id,t[9]=e,t[10]=P):P=t[10];let u;t[11]!==i||t[12]!==e?(u=!!i&&X(e)&&X(i.id),t[11]=i,t[12]=e,t[13]=u):u=t[13];let g;t[14]!==p||t[15]!==P||t[16]!==u?(g={queryKey:p,queryFn:P,enabled:u,staleTime:6e5},t[14]=p,t[15]=P,t[16]=u,t[17]=g):g=t[17];const{data:L}=I(g),_=L===void 0?!1:L,v=i?.id;let C;t[18]!==e||t[19]!==v?(C=["post",e,"reposted",v],t[18]=e,t[19]=v,t[20]=C):C=t[20];let b;t[21]!==i?.id||t[22]!==e?(b=()=>pe(e,i?.id),t[21]=i?.id,t[22]=e,t[23]=b):b=t[23];let F;t[24]!==i||t[25]!==e?(F=!!i&&X(e)&&X(i.id),t[24]=i,t[25]=e,t[26]=F):F=t[26];let d;t[27]!==C||t[28]!==b||t[29]!==F?(d={queryKey:C,queryFn:b,enabled:F,staleTime:6e5},t[27]=C,t[28]=b,t[29]=F,t[30]=d):d=t[30];const{data:w}=I(d),$=w===void 0?!1:w;let M;t[31]!==i?.id||t[32]!==e?(M=()=>Qe(e,i?.id),t[31]=i?.id,t[32]=e,t[33]=M):M=t[33];let N;t[34]!==i?.id||t[35]!==e||t[36]!==a?(N=async()=>{await a.cancelQueries({queryKey:["post",e,"liked",i?.id]});const h=a.getQueryData(["post",e,"liked",i?.id]);return a.setQueryData(["post",e,"liked",i?.id],!h),l(R=>({...R,likes:h?(R.likes||0)-1:(R.likes||0)+1})),{previousLiked:h}},t[34]=i?.id,t[35]=e,t[36]=a,t[37]=N):N=t[37];let c;t[38]!==i?.id||t[39]!==e||t[40]!==a||t[41]!==o?(c=(h,R,K)=>{K?.previousLiked!==void 0&&(a.setQueryData(["post",e,"liked",i?.id],K.previousLiked),l(V=>({...V,likes:K.previousLiked?(V.likes||0)+1:(V.likes||0)-1}))),o("Failed to update like","error")},t[38]=i?.id,t[39]=e,t[40]=a,t[41]=o,t[42]=c):c=t[42];let D;t[43]!==i?.id||t[44]!==e||t[45]!==a?(D=()=>{a.invalidateQueries({queryKey:["post",e,"liked",i?.id]})},t[43]=i?.id,t[44]=e,t[45]=a,t[46]=D):D=t[46];let x;t[47]!==M||t[48]!==N||t[49]!==c||t[50]!==D?(x={mutationFn:M,onMutate:N,onError:c,onSettled:D},t[47]=M,t[48]=N,t[49]=c,t[50]=D,t[51]=x):x=t[51];const T=te(x);let k;t[52]!==i?.id||t[53]!==e?(k=()=>ue(e,i?.id),t[52]=i?.id,t[53]=e,t[54]=k):k=t[54];let f;t[55]!==i?.id||t[56]!==e||t[57]!==a?(f=async()=>{await a.cancelQueries({queryKey:["post",e,"reposted",i?.id]});const h=a.getQueryData(["post",e,"reposted",i?.id]);return a.setQueryData(["post",e,"reposted",i?.id],!h),l(R=>({...R,reposts:h?(R.reposts||0)-1:(R.reposts||0)+1,mirrors:h?(R.mirrors||0)-1:(R.mirrors||0)+1})),{previousReposted:h}},t[55]=i?.id,t[56]=e,t[57]=a,t[58]=f):f=t[58];let Q;t[59]!==i?.id||t[60]!==e||t[61]!==a||t[62]!==o?(Q=(h,R,K)=>{K?.previousReposted!==void 0&&(a.setQueryData(["post",e,"reposted",i?.id],K.previousReposted),l(V=>({...V,reposts:K.previousReposted?(V.reposts||0)+1:(V.reposts||0)-1,mirrors:K.previousReposted?(V.mirrors||0)+1:(V.mirrors||0)-1}))),o("Failed to update repost","error")},t[59]=i?.id,t[60]=e,t[61]=a,t[62]=o,t[63]=Q):Q=t[63];let A;t[64]!==i?.id||t[65]!==e||t[66]!==a?(A=()=>{a.invalidateQueries({queryKey:["post",e,"reposted",i?.id]})},t[64]=i?.id,t[65]=e,t[66]=a,t[67]=A):A=t[67];let E;t[68]!==o?(E=h=>{o(h?"Reposted!":"Removed repost")},t[68]=o,t[69]=E):E=t[69];let O;t[70]!==k||t[71]!==f||t[72]!==Q||t[73]!==A||t[74]!==E?(O={mutationFn:k,onMutate:f,onError:Q,onSettled:A,onSuccess:E},t[70]=k,t[71]=f,t[72]=Q,t[73]=A,t[74]=E,t[75]=O):O=t[75];const B=te(O);let z;t[76]!==i||t[77]!==T||t[78]!==e||t[79]!==o?(z=async h=>{if(h&&h.stopPropagation(),!i)return o("Please login to like!","error");!X(e)||!X(i.id)||T.mutate()},t[76]=i,t[77]=T,t[78]=e,t[79]=o,t[80]=z):z=t[80];const j=z;let H;t[81]!==i||t[82]!==e||t[83]!==B||t[84]!==o?(H=async h=>{if(h&&h.stopPropagation(),!i)return o("Please login to repost!","error");!X(e)||!X(i.id)||B.mutate()},t[81]=i,t[82]=e,t[83]=B,t[84]=o,t[85]=H):H=t[85];const W=H;let J;return t[86]!==j||t[87]!==W||t[88]!==_||t[89]!==$||t[90]!==y?(J={liked:_,reposted:$,localStats:y,setLocalStats:l,handleLike:j,handleRepost:W},t[86]=j,t[87]=W,t[88]=_,t[89]=$,t[90]=y,t[91]=J):J=t[91],J};var Te=Z();const nt=e=>{const s=(0,Te.c)(5);let i;s[0]!==e?(i=()=>ae(e),s[0]=e,s[1]=i):i=s[1];const[o,t]=(0,q.useState)(i);let a,n;return s[2]!==e?(a=()=>{if(!e)return;const y=setTimeout(()=>{t(ae(e))},0),l=setInterval(()=>{t(ae(e))},6e4);return()=>{clearTimeout(y),clearInterval(l)}},n=[e],s[2]=e,s[3]=a,s[4]=n):(a=s[3],n=s[4]),(0,q.useEffect)(a,n),o},rt=()=>{const{handle:e}=ie(),s=G(),{currentUser:i,getProfileByHandle:o}=Y(),{addToast:t}=ee(),{data:a,isLoading:n}=I({queryKey:["profile",e],queryFn:()=>o(e),enabled:!!e,staleTime:1e3*60*5}),[y,l]=(0,q.useState)("feed"),{data:S,fetchNextPage:r,hasNextPage:m,isFetchingNextPage:p,isLoading:P}=U({queryKey:["posts","user",a?.id],queryFn:({pageParam:f})=>he(a?.id,f,10),enabled:!!a?.id,initialPageParam:null,getNextPageParam:f=>{if(!(!f||f.length<10))return f[f.length-1].sort_timestamp||f[f.length-1].created_at}}),u=(0,q.useMemo)(()=>S?.pages.flatMap(f=>f)||[],[S]),[g,L]=(0,q.useState)(!1),[_,v]=(0,q.useState)("Followers"),[C,b]=(0,q.useState)([]),[F,d]=(0,q.useState)(!1),[w,$]=(0,q.useState)(!1),[M,N]=(0,q.useState)(!0),c=async(f,Q=!1)=>{const A=a?.id;if(A){Q?$(!0):(v(f),L(!0),d(!0),b([]));try{const E=Q&&C.length>0?C[C.length-1].followed_at:null,O=f==="Followers"?await ge(A,E,10):await be(A,E,10);O.length<10?N(!1):N(!0),b(Q?B=>[...B,...O]:O)}catch(E){console.error(`Failed to fetch ${f}:`,E),t(`Failed to load ${f}`)}finally{d(!1),$(!1)}}},D=(0,q.useMemo)(()=>y==="feed"?u.filter(f=>f.community_id===null&&f.parent_id===null):y==="media"?u.filter(f=>f.community_id===null&&f.parent_id===null&&(f.type==="video"||f.type==="image"||f.media&&f.media.length>0)):y==="collections"?[]:u,[u,y]);return{handle:e,profile:a,loading:n,userPosts:u,setUserPosts:()=>console.warn("setUserPosts is deprecated"),activeProfileTab:y,setActiveProfileTab:l,loadingPosts:P,isFetchingMorePosts:p,hasMorePosts:m,filteredPosts:D,isFollowModalOpen:g,setIsFollowModalOpen:L,followModalType:_,followListData:C,isListLoading:F,isFetchingMoreFollows:w,hasMoreFollows:M,openFollowModal:c,handlePostClick:f=>{s(`/post/${f}`)},handleUserClick:f=>{f!==e&&s(`/u/${f}`)},loadUserPosts:(f=!1)=>{r()},currentUser:i,addToast:t,navigate:s}};var Ee=Z();const lt=()=>{const e=(0,Ee.c)(74),{handle:s}=ie(),i=G(),{currentUser:o}=Y(),{addToast:t}=ee(),a=oe();let n,y;e[0]!==s?(n=["community",s],y=()=>Ne(s),e[0]=s,e[1]=n,e[2]=y):(n=e[1],y=e[2]);const l=!!s;let S;e[3]!==n||e[4]!==y||e[5]!==l?(S={queryKey:n,queryFn:y,enabled:l,staleTime:6e5},e[3]=n,e[4]=y,e[5]=l,e[6]=S):S=e[6];const{data:r,isLoading:m}=I(S),p=r?.id,P=o?.id;let u;e[7]!==p||e[8]!==P?(u=["community",p,"membership",P],e[7]=p,e[8]=P,e[9]=u):u=e[9];let g;e[10]!==r?.id||e[11]!==o?.id?(g=()=>Re(r?.id,o?.id),e[10]=r?.id,e[11]=o?.id,e[12]=g):g=e[12];const L=!!r?.id&&!!o?.id;let _;e[13]!==u||e[14]!==g||e[15]!==L?(_={queryKey:u,queryFn:g,enabled:L,staleTime:3e5},e[13]=u,e[14]=g,e[15]=L,e[16]=_):_=e[16];const{data:v}=I(_),C=!!v,b=v?.role||null,F=r?.id;let d;e[17]!==F?(d=["posts","community",F],e[17]=F,e[18]=d):d=e[18];let w;e[19]!==r?.id?(w=h=>{const{pageParam:R}=h;return Ce(r?.id,R,10)},e[19]=r?.id,e[20]=w):w=e[20];const $=!!r?.id;let M;e[21]!==d||e[22]!==w||e[23]!==$?(M={queryKey:d,queryFn:w,enabled:$,initialPageParam:null,getNextPageParam:Ke},e[21]=d,e[22]=w,e[23]=$,e[24]=M):M=e[24];const{data:N,fetchNextPage:c,hasNextPage:D,isFetchingNextPage:x,isLoading:T}=U(M);let k;e[25]!==N?.pages?(k=N?.pages.flatMap(Ae)||[],e[25]=N?.pages,e[26]=k):k=e[26];const f=k;let Q;e[27]!==r?.id||e[28]!==o?.id?(Q=()=>de(r?.id,o?.id),e[27]=r?.id,e[28]=o?.id,e[29]=Q):Q=e[29];let A;e[30]!==r?.id||e[31]!==o?.id||e[32]!==s||e[33]!==a?(A=async()=>{await a.cancelQueries({queryKey:["community",r?.id,"membership",o?.id]}),await a.cancelQueries({queryKey:["community",s]});const h=a.getQueryData(["community",r?.id,"membership",o?.id]),R=a.getQueryData(["community",s]);return a.setQueryData(["community",r?.id,"membership",o?.id],h?null:{role:"member"}),a.setQueryData(["community",s],K=>K&&{...K,membersCount:h?K.membersCount-1:K.membersCount+1}),{previousMembership:h,previousCommunity:R}},e[30]=r?.id,e[31]=o?.id,e[32]=s,e[33]=a,e[34]=A):A=e[34];let E;e[35]!==t||e[36]!==r?.id||e[37]!==o?.id||e[38]!==s||e[39]!==a?(E=(h,R,K)=>{K?.previousMembership!==void 0&&a.setQueryData(["community",r?.id,"membership",o?.id],K.previousMembership),K?.previousCommunity&&a.setQueryData(["community",s],K.previousCommunity),t("Failed to update membership","error")},e[35]=t,e[36]=r?.id,e[37]=o?.id,e[38]=s,e[39]=a,e[40]=E):E=e[40];let O;e[41]!==r?.id||e[42]!==o?.id||e[43]!==s||e[44]!==a?(O=()=>{a.invalidateQueries({queryKey:["community",r?.id,"membership",o?.id]}),a.invalidateQueries({queryKey:["community",s]})},e[41]=r?.id,e[42]=o?.id,e[43]=s,e[44]=a,e[45]=O):O=e[45];let B;e[46]!==t||e[47]!==r?(B=h=>{r&&t(h?`Joined ${r.name}`:`Left ${r.name}`)},e[46]=t,e[47]=r,e[48]=B):B=e[48];let z;e[49]!==Q||e[50]!==A||e[51]!==E||e[52]!==O||e[53]!==B?(z={mutationFn:Q,onMutate:A,onError:E,onSettled:O,onSuccess:B},e[49]=Q,e[50]=A,e[51]=E,e[52]=O,e[53]=B,e[54]=z):z=e[54];const j=te(z);let H;e[55]!==t||e[56]!==o||e[57]!==j?(H=async()=>{if(!o)return t("Please login to join communities","error");j.mutate()},e[55]=t,e[56]=o,e[57]=j,e[58]=H):H=e[58];const W=H;let J;return e[59]!==t||e[60]!==r||e[61]!==f||e[62]!==o||e[63]!==c||e[64]!==W||e[65]!==D||e[66]!==x||e[67]!==C||e[68]!==j.isPending||e[69]!==m||e[70]!==T||e[71]!==i||e[72]!==b?(J={community:r,loading:m,isMember:C,userRole:b,isJoining:j.isPending,communityPosts:f,loadingPosts:T,isFetchingMorePosts:x,hasMorePosts:D,handleJoinToggle:W,loadCommunityPosts:c,currentUser:o,addToast:t,navigate:i},e[59]=t,e[60]=r,e[61]=f,e[62]=o,e[63]=c,e[64]=W,e[65]=D,e[66]=x,e[67]=C,e[68]=j.isPending,e[69]=m,e[70]=T,e[71]=i,e[72]=b,e[73]=J):J=e[73],J};function Ke(e){if(!(!e||e.length<10))return e[e.length-1].sort_timestamp}function Ae(e){return e}const ct=()=>{const{currentUser:e}=Y(),s=G(),i=le(),o=new URLSearchParams(i.search),t=o.get("q")||"",a=o.get("tab")||(t?"posts":"communities"),[n,y]=(0,q.useState)(t),[l,S]=(0,q.useState)(a),[r,m]=(0,q.useState)(!1);(0,q.useEffect)(()=>{t!==n&&(y(t),t&&S("posts"))},[t]);const{data:p,fetchNextPage:P,hasNextPage:u,isFetchingNextPage:g,isLoading:L}=U({queryKey:["explore","communities"],queryFn:({pageParam:c})=>Fe(c,10),initialPageParam:null,getNextPageParam:c=>{if(!(!c||c.length<10))return c[c.length-1].createdAt}}),_=(0,q.useMemo)(()=>p?.pages.flatMap(c=>c)||[],[p]),{data:v,fetchNextPage:C,hasNextPage:b,isFetchingNextPage:F,isLoading:d}=U({queryKey:["explore","posts",n],queryFn:({pageParam:c})=>n?we(n,c,10,!0):ve(c,10),initialPageParam:null,getNextPageParam:c=>{if(!(!c||c.length<10))return c[c.length-1].sort_timestamp||c[c.length-1].sortTimestamp}}),w=(0,q.useMemo)(()=>v?.pages.flatMap(c=>c)||[],[v]),$=(0,q.useMemo)(()=>{let c=_;return n&&(c=c.filter(D=>D.name?.toLowerCase().includes(n.toLowerCase())||D.handle?.toLowerCase().includes(n.toLowerCase()))),c},[_,n]);return{currentUser:e,searchQuery:n,setSearchQuery:c=>{y(c)},activeTab:l,setActiveTab:S,isCreateModalOpen:r,setIsCreateModalOpen:m,communitiesData:_,isCommunitiesLoading:L,isFetchingMoreCommunities:g,hasMoreCommunities:u,postsData:w,isPostsLoading:d,isFetchingMorePosts:F,hasMorePosts:b,filteredCommunities:$,handleCommunityClick:c=>{s(`/c/${c}`)},loadCommunities:P,loadPosts:C,navigate:s}};var Oe=Z();const ut=()=>{const e=(0,Oe.c)(21),{currentUser:s}=Y(),{posts:i,loading:o,hasMore:t,isFetchingNextPage:a,fetchNextPage:n}=Le(),{addToast:y}=ee(),l=G();let S;e[0]===Symbol.for("react.memo_cache_sentinel")?(S={queryKey:["stories"],queryFn:De},e[0]=S):S=e[0];const{data:r,isLoading:m}=I(S);let p;e[1]!==r?(p=r===void 0?[]:r,e[1]=r,e[2]=p):p=e[2];const P=p;let u;if(e[3]!==P){const d={};P.forEach(w=>{if(!w.user)return;const $=w.user.id;d[$]||(d[$]={user:w.user,stories:[]}),d[$].stories.push(w)}),u=Object.values(d),e[3]=P,e[4]=u}else u=e[4];const g=u,L=i;let _;e[5]!==l?(_=d=>{l(`/post/${d}`)},e[5]=l,e[6]=_):_=e[6];const v=_;let C;e[7]!==l?(C=d=>{l(`/u/${d}`)},e[7]=l,e[8]=C):C=e[8];const b=C;let F;return e[9]!==y||e[10]!==s||e[11]!==n||e[12]!==g||e[13]!==v||e[14]!==b||e[15]!==t||e[16]!==L||e[17]!==a||e[18]!==o||e[19]!==m?(F={currentUser:s,homePosts:L,groupedStories:g,isPostsLoading:o,isStoriesLoading:m,hasMore:t,isFetchingNextPage:a,fetchNextPage:n,addToast:y,handlePostClick:v,handleUserClick:b},e[9]=y,e[10]=s,e[11]=n,e[12]=g,e[13]=v,e[14]=b,e[15]=t,e[16]=L,e[17]=a,e[18]=o,e[19]=m,e[20]=F):F=e[20],F};var Be=Z();const dt=()=>{const e=(0,Be.c)(56),{id:s}=ie(),i=G(),{currentUser:o}=Y(),{onlineUsers:t}=_e(),a=oe(),[n,y]=(0,q.useState)("");let l;e[0]===Symbol.for("react.memo_cache_sentinel")?(l=[],e[0]=l):l=e[0];const[S,r]=(0,q.useState)(l),{conversations:m,isConvLoading:p,sendMessage:P,sendTypingStatus:u,typingStatus:g,markAsRead:L,formatMessages:_,conversationReactions:v,messages:C,isMsgLoading:b,fetchNextMessages:F,hasMoreMessages:d,isFetchingMoreMessages:w}=ke(o,s);let $;e:{if(!s||m.length===0){$=null;break e}let h;e[1]!==m||e[2]!==s?(h=m.find(R=>R.id===s)||null,e[1]=m,e[2]=s,e[3]=h):h=e[3],$=h}const M=$;let N,c;e[4]!==s||e[5]!==L?(N=()=>{s&&L(s)},c=[s,L],e[4]=s,e[5]=L,e[6]=N,e[7]=c):(N=e[6],c=e[7]),(0,q.useEffect)(N,c);let D;e[8]!==m||e[9]!==o?.id||e[10]!==n?(D=()=>{const h=setTimeout(async()=>{if(n.length>1){const R=await Se(n),K=m.map(je);r(R.filter(V=>V.id!==o?.id&&!K.includes(V.id)))}else r([])},300);return()=>clearTimeout(h)},e[8]=m,e[9]=o?.id,e[10]=n,e[11]=D):D=e[11];const x=o?.id;let T;e[12]!==m||e[13]!==n||e[14]!==x?(T=[n,m,x],e[12]=m,e[13]=n,e[14]=x,e[15]=T):T=e[15],(0,q.useEffect)(D,T);let k;e[16]!==o||e[17]!==i||e[18]!==a?(k=async h=>{if(o)try{const R=await Pe(o.id,h.id);a.invalidateQueries({queryKey:["conversations",o.id]}),y(""),i(`/messages/${R}`)}catch(R){console.error("Failed to start conversation:",R)}},e[16]=o,e[17]=i,e[18]=a,e[19]=k):k=e[19];const f=k;let Q;e[20]!==i?(Q=h=>{i(`/messages/${h.id}`)},e[20]=i,e[21]=Q):Q=e[21];const A=Q;let E;e[22]!==v||e[23]!==_||e[24]!==C?(E=_(C,v),e[22]=v,e[23]=_,e[24]=C,e[25]=E):E=e[25];const O=E;let B;if(e[26]!==m||e[27]!==n){let h;e[29]!==n?(h=R=>R.user?.name?.toLowerCase().includes(n.toLowerCase())||R.user?.handle?.toLowerCase().includes(n.toLowerCase())||R.lastMessage?.toLowerCase().includes(n.toLowerCase()),e[29]=n,e[30]=h):h=e[30],B=m.filter(h),e[26]=m,e[27]=n,e[28]=B}else B=e[28];const z=B,j=M&&g[M.id];let H;e[31]!==t||e[32]!==M?(H=M&&M.user?.id&&t.has(M.user.id),e[31]=t,e[32]=M,e[33]=H):H=e[33];const W=H;let J;return e[34]!==m||e[35]!==j||e[36]!==o||e[37]!==F||e[38]!==z||e[39]!==A||e[40]!==f||e[41]!==d||e[42]!==s||e[43]!==p||e[44]!==w||e[45]!==b||e[46]!==O||e[47]!==n||e[48]!==i||e[49]!==t||e[50]!==W||e[51]!==M||e[52]!==P||e[53]!==u||e[54]!==S?(J={id:s,currentUser:o,onlineUsers:t,msgSearchQuery:n,setMsgSearchQuery:y,userSearchResults:S,conversations:m,filteredConversations:z,selectedConversation:M,localMessages:O,isConvLoading:p,isMsgLoading:b,currentIsTyping:j,otherUserIsOnline:W,handleStartConversation:f,handleSelectConversation:A,sendMessage:P,sendTypingStatus:u,navigate:i,fetchNextMessages:F,hasMoreMessages:d,isFetchingMoreMessages:w},e[34]=m,e[35]=j,e[36]=o,e[37]=F,e[38]=z,e[39]=A,e[40]=f,e[41]=d,e[42]=s,e[43]=p,e[44]=w,e[45]=b,e[46]=O,e[47]=n,e[48]=i,e[49]=t,e[50]=W,e[51]=M,e[52]=P,e[53]=u,e[54]=S,e[55]=J):J=e[55],J};function je(e){return e.user?.id}var He=Z();const ft=()=>{const e=(0,He.c)(47),{currentUser:s}=Y(),i=G(),o=oe(),t=s?.id;let a;e[0]!==t?(a=["notifications",t],e[0]=t,e[1]=a):a=e[1];let n;e[2]!==s?.id?(n=k=>{const{pageParam:f}=k;return Me(s?.id,f,10)},e[2]=s?.id,e[3]=n):n=e[3];const y=!!s?.id;let l;e[4]!==a||e[5]!==n||e[6]!==y?(l={queryKey:a,queryFn:n,enabled:y,initialPageParam:null,getNextPageParam:Je},e[4]=a,e[5]=n,e[6]=y,e[7]=l):l=e[7];const{data:S,fetchNextPage:r,hasNextPage:m,isFetchingNextPage:p,isLoading:P}=U(l);let u;e[8]!==S?.pages?(u=S?.pages.flatMap(ze)||[],e[8]=S?.pages,e[9]=u):u=e[9];const g=u;let L;e[10]!==s||e[11]!==o?(L=()=>{if(!s?.id)return;const k=se.channel(`user_notifications:${s.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`recipient_id=eq.${s.id}`},()=>{o.invalidateQueries({queryKey:["notifications",s.id]})}).subscribe();return()=>{se.removeChannel(k)}},e[10]=s,e[11]=o,e[12]=L):L=e[12];const _=s?.id;let v;e[13]!==o||e[14]!==_?(v=[_,o],e[13]=o,e[14]=_,e[15]=v):v=e[15],(0,q.useEffect)(L,v);let C;e[16]!==s?(C=()=>s?fe(s.id):Promise.resolve(),e[16]=s,e[17]=C):C=e[17];let b,F,d;e[18]!==s?.id||e[19]!==o?(b=async()=>{await o.cancelQueries({queryKey:["notifications",s?.id]});const k=o.getQueryData(["notifications",s?.id]);return o.setQueryData(["notifications",s?.id],Xe),{previousNotifications:k}},F=(k,f,Q)=>{Q?.previousNotifications&&o.setQueryData(["notifications",s?.id],Q.previousNotifications)},d=()=>{o.invalidateQueries({queryKey:["notifications",s?.id]})},e[18]=s?.id,e[19]=o,e[20]=b,e[21]=F,e[22]=d):(b=e[20],F=e[21],d=e[22]);let w;e[23]!==b||e[24]!==F||e[25]!==d||e[26]!==C?(w={mutationFn:C,onMutate:b,onError:F,onSettled:d},e[23]=b,e[24]=F,e[25]=d,e[26]=C,e[27]=w):w=e[27];const $=te(w);let M;e[28]!==i?(M=k=>{k.type==="follow"?i(`/u/${k.user}`):k.post_id&&i(`/post/${k.post_id}`)},e[28]=i,e[29]=M):M=e[29];const N=M;let c;e[30]!==s?.id||e[31]!==$||e[32]!==g?(c=()=>{s?.id&&g.some(Ze)&&$.mutate()},e[30]=s?.id,e[31]=$,e[32]=g,e[33]=c):c=e[33];const D=s?.id;let x;e[34]!==$||e[35]!==g.length||e[36]!==D?(x=[D,g.length,$],e[34]=$,e[35]=g.length,e[36]=D,e[37]=x):x=e[37],(0,q.useEffect)(c,x);let T;return e[38]!==s||e[39]!==r||e[40]!==N||e[41]!==m||e[42]!==p||e[43]!==P||e[44]!==i||e[45]!==g?(T={currentUser:s,notifications:g,isLoading:P,isFetchingMore:p,hasMore:m,loadNotifications:r,handleNotificationClick:N,navigate:i},e[38]=s,e[39]=r,e[40]=N,e[41]=m,e[42]=p,e[43]=P,e[44]=i,e[45]=g,e[46]=T):T=e[46],T};function Je(e){if(!(!e||e.length<10))return e[e.length-1].created_at}function ze(e){return e}function Ve(e){return{...e,is_read:!0}}function We(e){return e.map(Ve)}function Xe(e){return e&&{...e,pages:e.pages.map(We)}}function Ze(e){return!e.is_read}var Ge=Z();const mt=()=>{const e=(0,Ge.c)(20),{id:s}=ie(),i=G(),{currentUser:o}=Y(),{addToast:t}=ee();let a,n;e[0]!==s?(a=["post",s],n=async()=>{if(!s||!X(s))throw new Error("Invalid post ID");return me(s)},e[0]=s,e[1]=a,e[2]=n):(a=e[1],n=e[2]);const y=!!s;let l;e[3]!==a||e[4]!==n||e[5]!==y?(l={queryKey:a,queryFn:n,enabled:y,retry:!1},e[3]=a,e[4]=n,e[5]=y,e[6]=l):l=e[6];const{data:S,isLoading:r,isError:m}=I(l);let p;e[7]!==i?(p=_=>{i(`/u/${_}`)},e[7]=i,e[8]=p):p=e[8];const P=p;let u;e[9]!==i?(u=()=>{i(-1)},e[9]=i,e[10]=u):u=e[10];const g=u;let L;return e[11]!==t||e[12]!==o||e[13]!==g||e[14]!==P||e[15]!==m||e[16]!==r||e[17]!==i||e[18]!==S?(L={post:S,isLoading:r,isError:m,currentUser:o,addToast:t,navigate:i,handleUserClick:P,handleDelete:g},e[11]=t,e[12]=o,e[13]=g,e[14]=P,e[15]=m,e[16]=r,e[17]=i,e[18]=S,e[19]=L):L=e[19],L};var Ye=Z();const gt=()=>{const e=(0,Ye.c)(31),s=G(),[i]=ce();let o;e[0]!==i?(o=i.get("id"),e[0]=i,e[1]=o):o=e[1];const t=o,a=(0,q.useRef)(null),[n,y]=(0,q.useState)(null),[l,S]=(0,q.useState)(!0);let r;e[2]===Symbol.for("react.memo_cache_sentinel")?(r=["reels"],e[2]=r):r=e[2];let m;e[3]===Symbol.for("react.memo_cache_sentinel")?(m={queryKey:r,queryFn:Ie,initialPageParam:null,getNextPageParam:Ue},e[3]=m):m=e[3];const{data:p,fetchNextPage:P,hasNextPage:u,isFetchingNextPage:g,isLoading:L}=U(m);let _;e[4]!==p?.pages?(_=p?.pages.flatMap(et)||[],e[4]=p?.pages,e[5]=_):_=e[5];const v=_;let C,b;e[6]!==n||e[7]!==v||e[8]!==t?(C=()=>{v.length>0&&(t&&v.find(D=>D.id===t)?(y(t),setTimeout(()=>{document.querySelector(`[data-id="${t}"]`)?.scrollIntoView({behavior:"instant"})},100)):n||y(v[0].id))},b=[v,t,n],e[6]=n,e[7]=v,e[8]=t,e[9]=C,e[10]=b):(C=e[9],b=e[10]),(0,q.useEffect)(C,b);let F,d;e[11]!==v.length?(F=()=>{if(v.length===0)return;const D={root:a.current,threshold:.6},x=k=>{k.forEach(f=>{f.isIntersecting&&y(f.target.dataset.id)})},T=new IntersectionObserver(x,D);return setTimeout(()=>{document.querySelectorAll(".reel-item").forEach(k=>T.observe(k))},100),()=>T.disconnect()},d=[v.length],e[11]=v.length,e[12]=F,e[13]=d):(F=e[12],d=e[13]),(0,q.useEffect)(F,d);let w;e[14]!==l?(w=()=>{S(!l)},e[14]=l,e[15]=w):w=e[15];const $=w;let M,N;e[16]!==P||e[17]!==u||e[18]!==g?(N=()=>{const D=()=>{if(!a.current||g||!u)return;const{scrollTop:T,scrollHeight:k,clientHeight:f}=a.current;T+f>=k-800&&P()},x=a.current;if(x)return x.addEventListener("scroll",D),()=>x.removeEventListener("scroll",D)},M=[g,u,P],e[16]=P,e[17]=u,e[18]=g,e[19]=M,e[20]=N):(M=e[19],N=e[20]),(0,q.useEffect)(N,M);let c;return e[21]!==n||e[22]!==P||e[23]!==u||e[24]!==g||e[25]!==L||e[26]!==l||e[27]!==s||e[28]!==v||e[29]!==$?(c={reels:v,loading:L,loadingMore:g,activeReelId:n,hasMore:u,isMuted:l,containerRef:a,navigate:s,toggleMute:$,loadReels:P},e[21]=n,e[22]=P,e[23]=u,e[24]=g,e[25]=L,e[26]=l,e[27]=s,e[28]=v,e[29]=$,e[30]=c):c=e[30],c};function Ie(e){const{pageParam:s}=e;return ye(s,10)}function Ue(e){if(!(!e||e.length<10))return e[e.length-1].sort_timestamp||e[e.length-1].created_at}function et(e){return e}const ht=()=>{const{currentUser:e,logout:s}=Y(),{darkMode:i,toggleDarkMode:o,fontSize:t,setFontSize:a,dataSaver:n,setDataSaver:y}=$e(),{addToast:l}=ee(),[S,r]=(0,q.useState)(!1),[m,p]=(0,q.useState)({newPassword:"",confirmPassword:""}),[P,u]=(0,q.useState)(!1),g=async()=>{try{await s(),l("Logged out successfully")}catch(d){console.error("Logout error:",d),l("Failed to logout")}};return{currentUser:e,darkMode:i,toggleDarkMode:o,fontSize:t,setFontSize:a,dataSaver:n,setDataSaver:y,isChangingPassword:S,setIsChangingPassword:r,passwordData:m,setPasswordData:p,loading:P,handleLogout:g,handlePasswordChange:async d=>{if(d.preventDefault(),m.newPassword!==m.confirmPassword){l("Passwords do not match","error");return}if(m.newPassword.length<6){l("Password must be at least 6 characters","error");return}u(!0);try{const{error:w}=await se.auth.updateUser({password:m.newPassword});if(w)throw w;l("Password updated successfully!"),r(!1),p({newPassword:"",confirmPassword:""})}catch(w){console.error("Password update error:",w),l(w.message||"Failed to update password","error")}finally{u(!1)}},handlePasswordReset:async()=>{if(e?.email){u(!0);try{const{error:d}=await se.auth.resetPasswordForEmail(e.email,{redirectTo:`${window.location.origin}/settings?type=recovery`});if(d)throw d;l("Password reset email sent!")}catch(d){console.error("Reset password error:",d),l(d.message||"Failed to send reset email","error")}finally{u(!1)}}},handleClearCache:()=>{["seenStories","font-size","data-saver","theme"].forEach(d=>localStorage.removeItem(d)),l("Cache cleared! Reloading..."),setTimeout(()=>window.location.reload(),1500)},handleDownloadData:async()=>{if(e){u(!0);try{const d={user:{id:e.id,handle:e.handle,name:e.name,email:e.email},exportDate:new Date().toISOString(),note:"This is a mock export of your Sysm data."},w=new Blob([JSON.stringify(d,null,2)],{type:"application/json"}),$=URL.createObjectURL(w),M=document.createElement("a");M.href=$,M.download=`sysm-data-${e.handle}.json`,M.click(),URL.revokeObjectURL($),l("Data export started!")}catch{l("Failed to export data","error")}finally{u(!1)}}},handleDeleteAccount:()=>{window.confirm("Are you absolutely sure? This will permanently delete your account and all associated data. This action is irreversible.")&&(l("Account deletion request submitted. Logging out..."),setTimeout(g,2e3))},handleReportBug:()=>{window.prompt("Please describe the bug you found:")&&l("Bug reported! Thank you for your feedback.")}}};export{dt as a,lt as c,at as d,ft as i,rt as l,gt as n,ut as o,mt as r,ct as s,ht as t,nt as u};
