import{o as ne}from"./rolldown-runtime-CIzSbf4l.js";import{_ as be,l as je,v as ye,w as ve}from"./framework-i0QTTZ5z.js";import{a as Ce,r as we}from"./query-D9AYMyAs.js";import"./database-OCX2jLsI.js";import{An as Ne,At as ke,Ht as Se,Nn as Ie,Nt as Pe,Pn as Ae,Qt as ze,Rt as Fe,Sn as Re,Un as Te,Ut as De,Vn as Ue,kn as We,yn as Le,zn as He}from"./ui-libs-CBFZd3CP.js";import"./media-libs-CSO2-zwb.js";import{Dt as Oe,Fn as S,Mt as Me,Nt as Ee,Ot as $e,Pn as Ve,U as qe,Ut as I,at as j,bn as Ke,cn as Qe,dn as Ge,in as Be,it as se,jt as Je,ln as Xe,nn as Ye,ot as ae,pn as Ze,rn as _e,rt as re,st as et,yt as tt}from"./index-BhYIW-gb.js";import{n as P,t as st}from"./actionsheet-CKKHWCjx.js";import{t as at}from"./useAutoResizeTextArea-DE28iMYP.js";import{t as rt}from"./CircularProgress-BYtJUz0u.js";var n=ne(ve(),1),e=ne(je(),1),nt=()=>{const p=ye(),L=be(),{currentUser:o}=Ge(),b=o?.isPro?2500:500,{addPost:oe}=Qe(),{addToast:d}=Xe(),le=Ce(),ie=L.state?.initialCommunity,m=L.state?.isStory||!1,u=o?`create-post-draft:${o.id}:${m?"story":"post"}`:null,y=(0,n.useRef)(!1),[l,H]=(0,n.useState)(""),[f,O]=(0,n.useState)(""),[h,v]=(0,n.useState)([]),[M,E]=(0,n.useState)({}),[C,$]=(0,n.useState)({}),[A,z]=(0,n.useState)(!1),[w,V]=(0,n.useState)(ie||null),[x,q]=(0,n.useState)("anyone"),[ce,F]=(0,n.useState)(!1),[R,N]=(0,n.useState)(""),[T,K]=(0,n.useState)(null),[Q,G]=(0,n.useState)(null),[B,J]=(0,n.useState)(null),[de,g]=(0,n.useState)(!1),ue=at(l,44,400),X=(0,n.useRef)(null),Y=(0,n.useRef)(null),{data:D=[]}=we({queryKey:["user-communities",o?.id],queryFn:()=>Ke(o.id),enabled:!!o?.id});(0,n.useEffect)(()=>{o||p("/login")},[o,p]),(0,n.useEffect)(()=>{if(!u||y.current)return;const t=sessionStorage.getItem(u);if(!t){y.current=!0;return}try{const s=JSON.parse(t);H(s.postContent||""),O(s.hashtags||""),q(s.replySetting||"anyone"),s.selectedCommunityId&&V({id:s.selectedCommunityId})}catch(s){console.error("Failed to restore create post draft",s),sessionStorage.removeItem(u)}finally{y.current=!0}},[u]),(0,n.useEffect)(()=>{if(!u||!y.current)return;const t={postContent:l,hashtags:f,replySetting:x,selectedCommunityId:w?.id||null};if(!t.postContent.trim()&&!t.hashtags.trim()&&!t.selectedCommunityId&&t.replySetting==="anyone"){sessionStorage.removeItem(u);return}sessionStorage.setItem(u,JSON.stringify(t))},[u,f,l,x,w?.id]);const Z=t=>new Promise(s=>{const a=document.createElement("video");a.preload="auto",a.src=URL.createObjectURL(t),a.muted=!0,a.playsInline=!0,a.onloadeddata=()=>{a.currentTime=Math.min(1,a.duration/2)},a.onseeked=()=>{setTimeout(()=>{try{const r=document.createElement("canvas");r.width=a.videoWidth,r.height=a.videoHeight,r.getContext("2d")?.drawImage(a,0,0,r.width,r.height),s(r.toDataURL("image/jpeg",.7))}catch(r){console.error("Error capturing thumbnail:",r),s("")}finally{a.remove()}},150)},a.onerror=()=>{s("")}}),me=async t=>{if(!t.target.files)return;const s=Array.from(t.target.files).map(a=>({id:Math.random().toString(36).substring(2,11),file:a}));v(a=>[...a,...s]);for(const a of s)if(a.file.type.startsWith("video/"))try{const r=await Z(a.file);r&&E(i=>({...i,[a.id]:r}))}catch(r){console.error("Thumbnail generation failed",r)}},he=async t=>{const s=t.clipboardData.files;if(s&&s.length>0){const a=Array.from(s).filter(r=>r.type.startsWith("image/")||r.type.startsWith("video/"));if(a.length>0){t.preventDefault();const r=a.map(i=>({id:Math.random().toString(36).substring(2,11),file:i}));v(i=>[...i,...r]);for(const i of r)if(i.file.type.startsWith("video/"))try{const c=await Z(i.file);c&&E(W=>({...W,[i.id]:c}))}catch(c){console.error("Thumbnail generation failed",c)}d(`Added ${r.length} image(s) from clipboard!`,"success")}}},xe=t=>{if(!t.target.files||!B)return;const s=t.target.files[0];$(a=>({...a,[B]:s})),J(null)},pe=t=>{v(s=>s.filter(a=>a.id!==t)),$(s=>{const a={...s};return delete a[t],a})},_=()=>{if(R.trim()){const t=R.trim().replace(/^#/,"");O(s=>s?s.includes(t)?s:`${s}, ${t}`:t),N(""),F(!1),d(`Hashtag #${t} added!`)}},fe=t=>{const s=new File([t],`cropped-${Date.now()}.jpg`,{type:"image/jpeg"});Q&&v(a=>a.map(r=>r.id===Q?{...r,file:s}:r)),K(null),G(null)},ee=async(t=!1)=>{if(o&&!(!l.trim()&&h.length===0)&&!(l.length>b)){z(!0);try{const s=[];for(let i=0;i<h.length;i++){const c=h[i],W=C[c.id]||null,ge=await Ve(c.file,"media",W);s.push(ge)}let a=l;if(f.trim()){const i=f.split(",").map(c=>c.trim()).filter(c=>c.length>0).map(c=>c.startsWith("#")?c:`#${c}`).join(" ");a+=`

${i}`}let r=t?"reel":"text";if(!t&&s.length>0&&(r=s[0].type==="video"?"video":"image"),m){if(s.length===0){d("Please add media for your story.","error"),z(!1);return}await Ze(o.id,s[0].url,s[0].type,l),le.invalidateQueries({queryKey:["stories"]}),d("Story shared!")}else await oe({content:a,media:s,type:r,userId:o.id,communityId:w?.id||null}),d(t?"Reel published!":"Post published!");u&&sessionStorage.removeItem(u),p("/feed")}catch(s){console.error("Failed to create post:",s),d("Failed to publish content.","error")}finally{z(!1)}}};if(!o)return null;const k=!l.trim()&&h.length===0||A||l.length>b,U=b-l.length,te=l.length>b-20;return(0,e.jsxs)("div",{className:"flex flex-col min-h-screen bg-[--background] text-[--foreground] md:rounded-xl",children:[(0,e.jsxs)("div",{className:"flex items-center justify-between px-6 py-4 sticky top-0 bg-[--background]/90 backdrop-blur-xl z-20 border-b border-[--border] rounded-t-xl",children:[(0,e.jsx)("button",{onClick:()=>p(-1),className:"text-[15px] font-medium text-neutral-500 hover:text-[--foreground] transition-colors",children:"Cancel"}),(0,e.jsx)("h1",{className:"text-[17px] font-bold tracking-tight",children:m?"Add to Story":"Create post"}),(0,e.jsx)("button",{onClick:()=>g(!0),className:"text-[--foreground] p-1.5 hover:bg-neutral-100 dark:hover:bg-neutral-800 rounded-full transition-all",children:(0,e.jsx)(Te,{size:22})})]}),(0,e.jsx)("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:(0,e.jsxs)("div",{className:"flex px-6 pt-6 pb-20",children:[(0,e.jsx)("div",{className:"flex flex-col items-center mr-4 pt-1",children:(0,e.jsxs)(Ye,{className:"w-10 h-10 border-[3px] border-[--background] ring-1 ring-[--border]",children:[(0,e.jsx)(Be,{src:o.avatar,className:"object-cover"}),(0,e.jsx)(_e,{children:o.name?.[0].toUpperCase()})]})}),(0,e.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,e.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,e.jsx)("span",{className:"font-bold text-[15px] tracking-tight hover:underline cursor-pointer",children:o.name}),!m&&D.length>0&&(0,e.jsxs)(re,{onValueChange:t=>{V(D.find(s=>s.id===t)||null)},value:w?.id||"none",children:[(0,e.jsxs)(ae,{className:"h-7 px-3 py-0 border-none bg-neutral-100 dark:bg-neutral-900 text-[12px] font-bold rounded-full w-auto gap-1.5 focus:ring-0 hover:bg-neutral-200 dark:hover:bg-neutral-800 transition-colors",children:[(0,e.jsx)(Pe,{size:12,className:"text-neutral-500"}),(0,e.jsx)(et,{placeholder:"Anyone"})]}),(0,e.jsxs)(se,{align:"end",className:"bg-[--background] border-[--border] shadow-xl rounded-xl",children:[(0,e.jsx)(j,{value:"none",className:"text-xs font-medium py-2.5",children:"Public (Anyone)"}),D.map(t=>(0,e.jsx)(j,{value:t.id,className:"text-xs font-medium py-2.5",children:t.name},t.id))]})]})]}),(0,e.jsxs)("div",{className:"relative",children:[(0,e.jsx)("textarea",{ref:ue,placeholder:m?"Add a caption... (optional)":"What's new?",value:l,onChange:t=>H(t.target.value),onPaste:he,className:S("w-full bg-transparent text-[--foreground] placeholder-neutral-500 outline-none resize-none text-[16px] leading-relaxed min-h-[44px] mb-1 transition-colors",U<0&&"text-rose-500")}),l.length>0&&(0,e.jsxs)("div",{className:"absolute right-0 bottom-2 flex items-center gap-3",children:[(0,e.jsx)(rt,{current:l.length,max:b,size:22,strokeWidth:2.5,isWarning:te}),te&&(0,e.jsx)("span",{className:S("text-[11px] font-bold",U<0?"text-rose-500":"text-neutral-500"),children:U})]})]}),h.length>0&&(0,e.jsxs)("div",{className:"flex overflow-x-auto gap-3.5 mb-5 mt-2 pb-1 scrollbar-hide snap-x",children:[h.map(t=>(0,e.jsxs)("div",{className:"relative shrink-0 w-[260px] h-[340px] rounded-2xl overflow-hidden border border-[--border] bg-neutral-100 dark:bg-neutral-900 snap-start shadow-md group",children:[t.file.type.startsWith("video/")?(0,e.jsxs)(e.Fragment,{children:[C[t.id]||M[t.id]?(0,e.jsx)("img",{src:C[t.id]?URL.createObjectURL(C[t.id]):M[t.id],className:"w-full h-full object-cover",alt:"Video thumbnail"}):(0,e.jsx)("video",{src:URL.createObjectURL(t.file),className:"w-full h-full object-cover",muted:!0,playsInline:!0}),(0,e.jsx)("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent flex flex-col justify-end p-4 transition-all duration-300",children:(0,e.jsx)("div",{className:"flex items-center justify-start",children:(0,e.jsxs)("button",{type:"button",onClick:s=>{s.stopPropagation(),J(t.id),X.current?.click()},className:"text-[11px] font-bold text-white bg-black/60 backdrop-blur-xl px-3 py-2 rounded-full flex items-center gap-2 hover:bg-black/80 transition-colors shadow-lg border border-white/10",children:[(0,e.jsx)(Ne,{size:14}),(0,e.jsx)("span",{children:"Change Cover"})]})})})]}):(0,e.jsx)("img",{src:URL.createObjectURL(t.file),alt:"preview",className:"w-full h-full object-cover"}),(0,e.jsx)("button",{onClick:()=>pe(t.id),className:"absolute top-3.5 right-3.5 bg-black/50 backdrop-blur-lg text-white rounded-full p-2 hover:bg-rose-500 transition-all z-10 shadow-xl group-hover:scale-110 active:scale-90",children:(0,e.jsx)(ke,{size:18})})]},t.id)),(0,e.jsx)("input",{type:"file",ref:X,className:"hidden",accept:"image/*",onChange:xe})]}),(0,e.jsxs)("div",{className:"flex items-center gap-7 mt-3 text-neutral-400",children:[(0,e.jsx)("button",{onClick:()=>Y.current?.click(),className:"hover:text-[--foreground] transition-all p-1 hover:scale-110 active:scale-90",title:"Add Image/Video",children:(0,e.jsx)(We,{size:22,strokeWidth:2.2})}),!m&&(0,e.jsx)("button",{disabled:!0,className:"hover:text-[--foreground] transition-all p-1 opacity-30 cursor-not-allowed",title:"Poll (Coming Soon)",children:(0,e.jsx)(De,{size:22,strokeWidth:2.2})}),!m&&(0,e.jsxs)(Oe,{open:ce,onOpenChange:t=>{F(t),t||N("")},children:[(0,e.jsx)(Ee,{asChild:!0,children:(0,e.jsx)("button",{className:"hover:text-[--foreground] transition-all p-1 hover:scale-110 active:scale-90",title:"Add Hashtag",children:(0,e.jsx)(Ie,{size:22,strokeWidth:2.2})})}),(0,e.jsxs)($e,{className:"sm:max-w-[400px]",children:[(0,e.jsx)(Je,{children:(0,e.jsx)(Me,{children:"Add Hashtag"})}),(0,e.jsxs)("div",{className:"flex flex-col gap-4 py-4",children:[(0,e.jsx)("input",{type:"text",value:R,onChange:t=>N(t.target.value.replace(/^#/,"")),onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),_())},placeholder:"e.g. technology, news, sports",className:"w-full rounded-xl border border-[--border] bg-[--background] px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-[--primary]",autoFocus:!0}),(0,e.jsxs)("div",{className:"flex gap-2",children:[(0,e.jsx)(I,{onClick:()=>{F(!1),N("")},variant:"secondary",className:"flex-1",children:"Cancel"}),(0,e.jsx)(I,{onClick:_,className:"flex-1",children:"Add Hashtag"})]})]})]})]}),(0,e.jsx)("button",{className:"hover:text-[--foreground] transition-all p-1 opacity-30 cursor-not-allowed",title:"Location",children:(0,e.jsx)(Le,{size:22,strokeWidth:2.2})})]}),f&&(0,e.jsx)("div",{className:"mt-4 flex flex-wrap gap-2.5",children:f.split(",").map((t,s)=>(0,e.jsxs)("span",{className:"text-[13px] font-bold text-blue-500 bg-blue-500/10 px-3 py-1 rounded-full border border-blue-500/20",children:["#",t.trim().replace(/^#/,"")]},s))})]})]})}),(0,e.jsxs)("div",{className:"flex items-center justify-between px-6 py-5 bg-[--background] border-t border-[--border] sticky bottom-0 z-20",children:[(0,e.jsxs)(re,{value:x,onValueChange:q,children:[(0,e.jsxs)(ae,{className:"border-none bg-transparent p-0 h-auto w-auto text-neutral-500 text-[14px] font-semibold hover:text-[--foreground] transition-colors gap-1.5 focus:ring-0",children:[x==="anyone"&&(0,e.jsx)(Ae,{size:14}),x==="following"&&(0,e.jsx)(Fe,{size:14}),x==="mentioned"&&(0,e.jsx)(Re,{size:14}),(0,e.jsxs)("span",{className:"capitalize",children:[x.replace("-"," ")," can reply"]})]}),(0,e.jsxs)(se,{align:"start",className:"bg-[--background] border-[--border] shadow-2xl rounded-2xl p-1.5",children:[(0,e.jsx)(j,{value:"anyone",className:"rounded-xl py-3 px-4 font-bold",children:"Anyone"}),(0,e.jsx)(j,{value:"following",className:"rounded-xl py-3 px-4 font-bold",children:"Profiles you follow"}),(0,e.jsx)(j,{value:"mentioned",className:"rounded-xl py-3 px-4 font-bold",children:"Mentioned only"})]})]}),(0,e.jsxs)("div",{className:"flex items-center gap-2",children:[!m&&h.some(t=>t.file.type.startsWith("video/"))&&(0,e.jsx)(I,{onClick:()=>ee(!0),disabled:k,loading:A,variant:"secondary",className:S("min-w-[90px] h-11 shadow-xl transition-all active:scale-95 text-[15px] border-zinc-200 dark:border-zinc-800 font-bold",k&&"opacity-50"),children:"Reel"}),!o?.isPro&&l.length>500?(0,e.jsx)(qe,{label:"Post",hoverLabel:"Go Pro!",onClick:()=>{p("/pro"),d("Pro users get 2500 character limit!","info")},className:"min-w-[120px] h-11"}):(0,e.jsx)(I,{onClick:()=>ee(!1),disabled:k,loading:A,className:S("min-w-[90px] h-11 shadow-xl transition-all active:scale-95 text-[15px]",k?"bg-neutral-100 text-neutral-400 dark:bg-neutral-900 dark:text-neutral-600 shadow-none":"shadow-[--primary]/20 bg-black text-white dark:bg-white dark:text-black"),children:m?"Share Story":"Post"})]})]}),(0,e.jsx)("input",{type:"file",ref:Y,onChange:me,multiple:!0,className:"hidden",accept:"image/*,video/*"}),T&&(0,e.jsx)(tt,{src:T,isOpen:!!T,onClose:()=>{K(null),G(null)},onCropComplete:fe}),(0,e.jsxs)(st,{isOpen:de,onClose:()=>g(!1),title:"Post Options",children:[(0,e.jsx)(P,{icon:(0,e.jsx)(He,{size:20}),onClick:()=>{d("Draft saved (Simulated)"),g(!1)},children:"Save as draft"}),(0,e.jsx)(P,{icon:(0,e.jsx)(ze,{size:20}),onClick:()=>{d("Settings coming soon"),g(!1)},children:"Post settings"}),(0,e.jsx)(P,{icon:(0,e.jsx)(Ue,{size:20}),onClick:()=>{d("Visibility settings coming soon"),g(!1)},children:"Who can see this"}),(0,e.jsx)("div",{className:"h-px bg-[--border] my-1 mx-6"}),(0,e.jsx)(P,{variant:"destructive",icon:(0,e.jsx)(Se,{size:20}),onClick:()=>{confirm("Discard this post?")&&p(-1),g(!1)},children:"Discard post"})]})]})},ft=nt;export{ft as default};
