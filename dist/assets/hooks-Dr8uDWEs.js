import{a as re}from"./rolldown-runtime-BaZ8gS7u.js";import{E as le,S as ce,b as X,c as G,x as oe,y as ue}from"./framework-CsA6nn9m.js";import{a as ee,n as se,r as I,t as U}from"./query-QyXblnmD.js";import{At as de,Bt as fe,Ct as me,Dt as ge,Et as he,Ht as ye,Jt as pe,Lt as Pe,Nt as ve,Ot as we,Pt as be,Rt as Me,St as Ce,Tt as Se,Ut as _e,Wt as Re,Yt as Le,_t as Fe,en as ne,gt as te,ht as ke,nn as Y,qt as qe,rn as ie,s as $e,vt as De,wt as Ne,xt as Qe,yt as Z,zt as Te}from"./index-CbgKo8b3.js";var xe=G(),_=re(le(),1);const ut=(e,s,i,o)=>{const t=(0,xe.c)(92),n=ee();let a;t[0]!==s?(a=s||{comments:0,likes:0,mirrors:0,reposts:0},t[0]=s,t[1]=a):a=t[1];const[h,c]=(0,_.useState)(a);let w,r;t[2]!==s?(w=()=>{s&&c(D=>({...D,...s}))},r=[s],t[2]=s,t[3]=w,t[4]=r):(w=t[3],r=t[4]),(0,_.useEffect)(w,r);const l=i?.id;let b;t[5]!==e||t[6]!==l?(b=["post",e,"liked",l],t[5]=e,t[6]=l,t[7]=b):b=t[7];let v;t[8]!==i?.id||t[9]!==e?(v=()=>ve(e,i?.id),t[8]=i?.id,t[9]=e,t[10]=v):v=t[10];let m;t[11]!==i||t[12]!==e?(m=!!i&&Y(e)&&Y(i.id),t[11]=i,t[12]=e,t[13]=m):m=t[13];let g;t[14]!==b||t[15]!==v||t[16]!==m?(g={queryKey:b,queryFn:v,enabled:m,staleTime:6e5},t[14]=b,t[15]=v,t[16]=m,t[17]=g):g=t[17];const{data:k}=I(g),M=k===void 0?!1:k,P=i?.id;let y;t[18]!==e||t[19]!==P?(y=["post",e,"reposted",P],t[18]=e,t[19]=P,t[20]=y):y=t[20];let C;t[21]!==i?.id||t[22]!==e?(C=()=>be(e,i?.id),t[21]=i?.id,t[22]=e,t[23]=C):C=t[23];let S;t[24]!==i||t[25]!==e?(S=!!i&&Y(e)&&Y(i.id),t[24]=i,t[25]=e,t[26]=S):S=t[26];let u;t[27]!==y||t[28]!==C||t[29]!==S?(u={queryKey:y,queryFn:C,enabled:S,staleTime:6e5},t[27]=y,t[28]=C,t[29]=S,t[30]=u):u=t[30];const{data:p}=I(u),L=p===void 0?!1:p;let q;t[31]!==i?.id||t[32]!==e?(q=()=>_e(e,i?.id),t[31]=i?.id,t[32]=e,t[33]=q):q=t[33];let F;t[34]!==i?.id||t[35]!==e||t[36]!==n?(F=async()=>{await n.cancelQueries({queryKey:["post",e,"liked",i?.id]});const D=n.getQueryData(["post",e,"liked",i?.id]);return n.setQueryData(["post",e,"liked",i?.id],!D),c(Q=>({...Q,likes:D?(Q.likes||0)-1:(Q.likes||0)+1})),{previousLiked:D}},t[34]=i?.id,t[35]=e,t[36]=n,t[37]=F):F=t[37];let d;t[38]!==i?.id||t[39]!==e||t[40]!==n||t[41]!==o?(d=(D,Q,T)=>{T?.previousLiked!==void 0&&(n.setQueryData(["post",e,"liked",i?.id],T.previousLiked),c(W=>({...W,likes:T.previousLiked?(W.likes||0)+1:(W.likes||0)-1}))),o("Failed to update like","error")},t[38]=i?.id,t[39]=e,t[40]=n,t[41]=o,t[42]=d):d=t[42];let $;t[43]!==i?.id||t[44]!==e||t[45]!==n?($=()=>{n.invalidateQueries({queryKey:["post",e,"liked",i?.id]})},t[43]=i?.id,t[44]=e,t[45]=n,t[46]=$):$=t[46];let x;t[47]!==q||t[48]!==F||t[49]!==d||t[50]!==$?(x={mutationFn:q,onMutate:F,onError:d,onSettled:$},t[47]=q,t[48]=F,t[49]=d,t[50]=$,t[51]=x):x=t[51];const K=se(x);let R;t[52]!==i?.id||t[53]!==e?(R=()=>Re(e,i?.id),t[52]=i?.id,t[53]=e,t[54]=R):R=t[54];let f;t[55]!==i?.id||t[56]!==e||t[57]!==n?(f=async()=>{await n.cancelQueries({queryKey:["post",e,"reposted",i?.id]});const D=n.getQueryData(["post",e,"reposted",i?.id]);return n.setQueryData(["post",e,"reposted",i?.id],!D),c(Q=>({...Q,reposts:D?(Q.reposts||0)-1:(Q.reposts||0)+1,mirrors:D?(Q.mirrors||0)-1:(Q.mirrors||0)+1})),{previousReposted:D}},t[55]=i?.id,t[56]=e,t[57]=n,t[58]=f):f=t[58];let N;t[59]!==i?.id||t[60]!==e||t[61]!==n||t[62]!==o?(N=(D,Q,T)=>{T?.previousReposted!==void 0&&(n.setQueryData(["post",e,"reposted",i?.id],T.previousReposted),c(W=>({...W,reposts:T.previousReposted?(W.reposts||0)+1:(W.reposts||0)-1,mirrors:T.previousReposted?(W.mirrors||0)+1:(W.mirrors||0)-1}))),o("Failed to update repost","error")},t[59]=i?.id,t[60]=e,t[61]=n,t[62]=o,t[63]=N):N=t[63];let E;t[64]!==i?.id||t[65]!==e||t[66]!==n?(E=()=>{n.invalidateQueries({queryKey:["post",e,"reposted",i?.id]})},t[64]=i?.id,t[65]=e,t[66]=n,t[67]=E):E=t[67];let A;t[68]!==o?(A=D=>{o(D?"Reposted!":"Removed repost")},t[68]=o,t[69]=A):A=t[69];let O;t[70]!==R||t[71]!==f||t[72]!==N||t[73]!==E||t[74]!==A?(O={mutationFn:R,onMutate:f,onError:N,onSettled:E,onSuccess:A},t[70]=R,t[71]=f,t[72]=N,t[73]=E,t[74]=A,t[75]=O):O=t[75];const B=se(O);let j;t[76]!==i||t[77]!==K||t[78]!==e||t[79]!==o?(j=async D=>{if(D&&D.stopPropagation(),!i)return o("Please login to like!","error");!Y(e)||!Y(i.id)||K.mutate()},t[76]=i,t[77]=K,t[78]=e,t[79]=o,t[80]=j):j=t[80];const H=j;let z;t[81]!==i||t[82]!==e||t[83]!==B||t[84]!==o?(z=async D=>{if(D&&D.stopPropagation(),!i)return o("Please login to repost!","error");!Y(e)||!Y(i.id)||B.mutate()},t[81]=i,t[82]=e,t[83]=B,t[84]=o,t[85]=z):z=t[85];const V=z;let J;return t[86]!==H||t[87]!==V||t[88]!==M||t[89]!==L||t[90]!==h?(J={liked:M,reposted:L,localStats:h,setLocalStats:c,handleLike:H,handleRepost:V},t[86]=H,t[87]=V,t[88]=M,t[89]=L,t[90]=h,t[91]=J):J=t[91],J};var Ee=G();const dt=e=>{const s=(0,Ee.c)(5);let i;s[0]!==e?(i=()=>ne(e),s[0]=e,s[1]=i):i=s[1];const[o,t]=(0,_.useState)(i);let n,a;return s[2]!==e?(n=()=>{if(!e)return;const h=setTimeout(()=>{t(ne(e))},0),c=setInterval(()=>{t(ne(e))},6e4);return()=>{clearTimeout(h),clearInterval(c)}},a=[e],s[2]=e,s[3]=n,s[4]=a):(n=s[3],a=s[4]),(0,_.useEffect)(n,a),o};var Ke=G();const ft=()=>{const e=(0,Ke.c)(27),[s,i]=(0,_.useState)(!1),[o,t]=(0,_.useState)(!1),[n,a]=(0,_.useState)(0),[h,c]=(0,_.useState)(null),[w,r]=(0,_.useState)(null),l=(0,_.useRef)(null),b=(0,_.useRef)(null);let v;e[0]===Symbol.for("react.memo_cache_sentinel")?(v=[],e[0]=v):v=e[0];const m=(0,_.useRef)(v);let g;e[1]===Symbol.for("react.memo_cache_sentinel")?(g=()=>{b.current=window.setInterval(()=>{a(Ae)},1e3)},e[1]=g):g=e[1];const k=g;let M;e[2]===Symbol.for("react.memo_cache_sentinel")?(M=()=>{b.current&&(clearInterval(b.current),b.current=null)},e[2]=M):M=e[2];const P=M;let y;e[3]===Symbol.for("react.memo_cache_sentinel")?(y=async()=>{try{const f=await navigator.mediaDevices.getUserMedia({audio:!0}),N=new MediaRecorder(f);l.current=N,m.current=[],N.ondataavailable=E=>{E.data.size>0&&m.current.push(E.data)},N.onstop=()=>{const E=new Blob(m.current,{type:"audio/webm;codecs=opus"}),A=URL.createObjectURL(E);c(E),r(A),f.getTracks().forEach(Oe)},N.start(),i(!0),t(!1),a(0),k()}catch(f){const N=f;throw console.error("Error accessing microphone:",N),N}},e[3]=y):y=e[3];const C=y;let S;e[4]!==s?(S=()=>{l.current&&s&&(l.current.stop(),i(!1),t(!1),P())},e[4]=s,e[5]=S):S=e[5];const u=S;let p;e[6]!==o||e[7]!==s?(p=()=>{l.current&&s&&!o&&(l.current.pause(),t(!0),P())},e[6]=o,e[7]=s,e[8]=p):p=e[8];const L=p;let q;e[9]!==o||e[10]!==s?(q=()=>{l.current&&s&&o&&(l.current.resume(),t(!1),k())},e[9]=o,e[10]=s,e[11]=q):q=e[11];const F=q;let d;e[12]!==s?(d=()=>{l.current&&s&&(l.current.stop(),l.current.onstop=null,i(!1),t(!1),P(),a(0),l.current.stream&&l.current.stream.getTracks().forEach(Be))},e[12]=s,e[13]=d):d=e[13];const $=d;let x;e[14]!==w?(x=()=>{w&&URL.revokeObjectURL(w),c(null),r(null),a(0)},e[14]=w,e[15]=x):x=e[15];const K=x;let R;return e[16]!==h||e[17]!==w||e[18]!==$||e[19]!==K||e[20]!==o||e[21]!==s||e[22]!==L||e[23]!==n||e[24]!==F||e[25]!==u?(R={isRecording:s,isPaused:o,recordingTime:n,startRecording:C,stopRecording:u,pauseRecording:L,resumeRecording:F,cancelRecording:$,audioBlob:h,audioUrl:w,clearAudio:K},e[16]=h,e[17]=w,e[18]=$,e[19]=K,e[20]=o,e[21]=s,e[22]=L,e[23]=n,e[24]=F,e[25]=u,e[26]=R):R=e[26],R};function Ae(e){return e+1}function Oe(e){return e.stop()}function Be(e){return e.stop()}const mt=()=>{const{handle:e}=oe(),s=X(),{currentUser:i,getProfileByHandle:o}=Z(),{addToast:t}=te(),{data:n,isLoading:a}=I({queryKey:["profile",e],queryFn:()=>o(e),enabled:!!e,staleTime:1e3*60*5}),[h,c]=(0,_.useState)("feed"),{data:w,fetchNextPage:r,hasNextPage:l,isFetchingNextPage:b,isLoading:v}=U({queryKey:["posts","user",n?.id],queryFn:({pageParam:f})=>Te(n?.id,f,10),enabled:!!n?.id,initialPageParam:null,getNextPageParam:f=>{if(!(!f||f.length<10))return f[f.length-1].sort_timestamp||f[f.length-1].created_at}}),m=(0,_.useMemo)(()=>w?.pages.flatMap(f=>f)||[],[w]),[g,k]=(0,_.useState)(!1),[M,P]=(0,_.useState)("Followers"),[y,C]=(0,_.useState)([]),[S,u]=(0,_.useState)(!1),[p,L]=(0,_.useState)(!1),[q,F]=(0,_.useState)(!0),d=async(f,N=!1)=>{const E=n?.id;if(E){N?L(!0):(P(f),k(!0),u(!0),C([]));try{const A=N&&y.length>0?y[y.length-1].followed_at:null,O=f==="Followers"?await qe(E,A,10):await pe(E,A,10);O.length<10?F(!1):F(!0),C(N?B=>[...B,...O]:O)}catch(A){console.error(`Failed to fetch ${f}:`,A),t(`Failed to load ${f}`)}finally{u(!1),L(!1)}}},$=(0,_.useMemo)(()=>h==="feed"?m.filter(f=>f.community_id===null&&f.parent_id===null):h==="media"?m.filter(f=>f.community_id===null&&f.parent_id===null&&(f.type==="video"||f.type==="image"||f.media&&f.media.length>0)):h==="collections"?[]:m,[m,h]);return{handle:e,profile:n,loading:a,userPosts:m,setUserPosts:()=>console.warn("setUserPosts is deprecated"),activeProfileTab:h,setActiveProfileTab:c,loadingPosts:v,isFetchingMorePosts:b,hasMorePosts:l,filteredPosts:$,isFollowModalOpen:g,setIsFollowModalOpen:k,followModalType:M,followListData:y,isListLoading:S,isFetchingMoreFollows:p,hasMoreFollows:q,openFollowModal:d,handlePostClick:f=>{s(`/post/${f}`)},handleUserClick:f=>{f!==e&&s(`/u/${f}`)},loadUserPosts:(f=!1)=>{r()},currentUser:i,addToast:t,navigate:s}};var je=G();const gt=()=>{const e=(0,je.c)(74),{handle:s}=oe(),i=X(),{currentUser:o}=Z(),{addToast:t}=te(),n=ee();let a,h;e[0]!==s?(a=["community",s],h=()=>me(s),e[0]=s,e[1]=a,e[2]=h):(a=e[1],h=e[2]);const c=!!s;let w;e[3]!==a||e[4]!==h||e[5]!==c?(w={queryKey:a,queryFn:h,enabled:c,staleTime:6e5},e[3]=a,e[4]=h,e[5]=c,e[6]=w):w=e[6];const{data:r,isLoading:l}=I(w),b=r?.id,v=o?.id;let m;e[7]!==b||e[8]!==v?(m=["community",b,"membership",v],e[7]=b,e[8]=v,e[9]=m):m=e[9];let g;e[10]!==r?.id||e[11]!==o?.id?(g=()=>Qe(r?.id,o?.id),e[10]=r?.id,e[11]=o?.id,e[12]=g):g=e[12];const k=!!r?.id&&!!o?.id;let M;e[13]!==m||e[14]!==g||e[15]!==k?(M={queryKey:m,queryFn:g,enabled:k,staleTime:3e5},e[13]=m,e[14]=g,e[15]=k,e[16]=M):M=e[16];const{data:P}=I(M),y=!!P,C=P?.role||null,S=r?.id;let u;e[17]!==S?(u=["posts","community",S],e[17]=S,e[18]=u):u=e[18];let p;e[19]!==r?.id?(p=D=>{const{pageParam:Q}=D;return Ne(r?.id,Q,10)},e[19]=r?.id,e[20]=p):p=e[20];const L=!!r?.id;let q;e[21]!==u||e[22]!==p||e[23]!==L?(q={queryKey:u,queryFn:p,enabled:L,initialPageParam:null,getNextPageParam:He},e[21]=u,e[22]=p,e[23]=L,e[24]=q):q=e[24];const{data:F,fetchNextPage:d,hasNextPage:$,isFetchingNextPage:x,isLoading:K}=U(q);let R;e[25]!==F?.pages?(R=F?.pages.flatMap(ze)||[],e[25]=F?.pages,e[26]=R):R=e[26];const f=R;let N;e[27]!==r?.id||e[28]!==o?.id?(N=()=>Se(r?.id,o?.id),e[27]=r?.id,e[28]=o?.id,e[29]=N):N=e[29];let E;e[30]!==r?.id||e[31]!==o?.id||e[32]!==s||e[33]!==n?(E=async()=>{await n.cancelQueries({queryKey:["community",r?.id,"membership",o?.id]}),await n.cancelQueries({queryKey:["community",s]});const D=n.getQueryData(["community",r?.id,"membership",o?.id]),Q=n.getQueryData(["community",s]);return n.setQueryData(["community",r?.id,"membership",o?.id],D?null:{role:"member"}),n.setQueryData(["community",s],T=>T&&{...T,membersCount:D?T.membersCount-1:T.membersCount+1}),{previousMembership:D,previousCommunity:Q}},e[30]=r?.id,e[31]=o?.id,e[32]=s,e[33]=n,e[34]=E):E=e[34];let A;e[35]!==t||e[36]!==r?.id||e[37]!==o?.id||e[38]!==s||e[39]!==n?(A=(D,Q,T)=>{T?.previousMembership!==void 0&&n.setQueryData(["community",r?.id,"membership",o?.id],T.previousMembership),T?.previousCommunity&&n.setQueryData(["community",s],T.previousCommunity),t("Failed to update membership","error")},e[35]=t,e[36]=r?.id,e[37]=o?.id,e[38]=s,e[39]=n,e[40]=A):A=e[40];let O;e[41]!==r?.id||e[42]!==o?.id||e[43]!==s||e[44]!==n?(O=()=>{n.invalidateQueries({queryKey:["community",r?.id,"membership",o?.id]}),n.invalidateQueries({queryKey:["community",s]})},e[41]=r?.id,e[42]=o?.id,e[43]=s,e[44]=n,e[45]=O):O=e[45];let B;e[46]!==t||e[47]!==r?(B=D=>{r&&t(D?`Joined ${r.name}`:`Left ${r.name}`)},e[46]=t,e[47]=r,e[48]=B):B=e[48];let j;e[49]!==N||e[50]!==E||e[51]!==A||e[52]!==O||e[53]!==B?(j={mutationFn:N,onMutate:E,onError:A,onSettled:O,onSuccess:B},e[49]=N,e[50]=E,e[51]=A,e[52]=O,e[53]=B,e[54]=j):j=e[54];const H=se(j);let z;e[55]!==t||e[56]!==o||e[57]!==H?(z=async()=>{if(!o)return t("Please login to join communities","error");H.mutate()},e[55]=t,e[56]=o,e[57]=H,e[58]=z):z=e[58];const V=z;let J;return e[59]!==t||e[60]!==r||e[61]!==f||e[62]!==o||e[63]!==d||e[64]!==V||e[65]!==$||e[66]!==x||e[67]!==y||e[68]!==H.isPending||e[69]!==l||e[70]!==K||e[71]!==i||e[72]!==C?(J={community:r,loading:l,isMember:y,userRole:C,isJoining:H.isPending,communityPosts:f,loadingPosts:K,isFetchingMorePosts:x,hasMorePosts:$,handleJoinToggle:V,loadCommunityPosts:d,currentUser:o,addToast:t,navigate:i},e[59]=t,e[60]=r,e[61]=f,e[62]=o,e[63]=d,e[64]=V,e[65]=$,e[66]=x,e[67]=y,e[68]=H.isPending,e[69]=l,e[70]=K,e[71]=i,e[72]=C,e[73]=J):J=e[73],J};function He(e){if(!(!e||e.length<10))return e[e.length-1].sort_timestamp}function ze(e){return e}const ht=()=>{const{currentUser:e}=Z(),s=X(),i=ue(),o=new URLSearchParams(i.search),t=o.get("q")||"",n=o.get("tab")||(t?"posts":"communities"),[a,h]=(0,_.useState)(t),[c,w]=(0,_.useState)(n),[r,l]=(0,_.useState)(!1);(0,_.useEffect)(()=>{t!==a&&(h(t),t&&w("posts"))},[t]);const{data:b,fetchNextPage:v,hasNextPage:m,isFetchingNextPage:g,isLoading:k}=U({queryKey:["explore","communities"],queryFn:({pageParam:d})=>Ce(d,10),initialPageParam:null,getNextPageParam:d=>{if(!(!d||d.length<10))return d[d.length-1].createdAt}}),M=(0,_.useMemo)(()=>b?.pages.flatMap(d=>d)||[],[b]),{data:P,fetchNextPage:y,hasNextPage:C,isFetchingNextPage:S,isLoading:u}=U({queryKey:["explore","posts",a],queryFn:({pageParam:d})=>a?ye(a,d,10,!0):Pe(d,10),initialPageParam:null,getNextPageParam:d=>{if(!(!d||d.length<10))return d[d.length-1].sort_timestamp||d[d.length-1].sortTimestamp}}),p=(0,_.useMemo)(()=>P?.pages.flatMap(d=>d)||[],[P]),L=(0,_.useMemo)(()=>{let d=M;return a&&(d=d.filter($=>$.name?.toLowerCase().includes(a.toLowerCase())||$.handle?.toLowerCase().includes(a.toLowerCase()))),d},[M,a]);return{currentUser:e,searchQuery:a,setSearchQuery:d=>{h(d)},activeTab:c,setActiveTab:w,isCreateModalOpen:r,setIsCreateModalOpen:l,communitiesData:M,isCommunitiesLoading:k,isFetchingMoreCommunities:g,hasMoreCommunities:m,postsData:p,isPostsLoading:u,isFetchingMorePosts:S,hasMorePosts:C,filteredCommunities:L,handleCommunityClick:d=>{s(`/c/${d}`)},loadCommunities:v,loadPosts:y,navigate:s}};var Je=G();const yt=()=>{const e=(0,Je.c)(21),{currentUser:s}=Z(),{posts:i,loading:o,hasMore:t,isFetchingNextPage:n,fetchNextPage:a}=ke(),{addToast:h}=te(),c=X();let w;e[0]===Symbol.for("react.memo_cache_sentinel")?(w={queryKey:["stories"],queryFn:he},e[0]=w):w=e[0];const{data:r,isLoading:l}=I(w);let b;e[1]!==r?(b=r===void 0?[]:r,e[1]=r,e[2]=b):b=e[2];const v=b;let m;if(e[3]!==v){const u={};v.forEach(p=>{if(!p.user)return;const L=p.user.id;u[L]||(u[L]={user:p.user,stories:[]}),u[L].stories.push(p)}),m=Object.values(u),e[3]=v,e[4]=m}else m=e[4];const g=m,k=i;let M;e[5]!==c?(M=u=>{c(`/post/${u}`)},e[5]=c,e[6]=M):M=e[6];const P=M;let y;e[7]!==c?(y=u=>{c(`/u/${u}`)},e[7]=c,e[8]=y):y=e[8];const C=y;let S;return e[9]!==h||e[10]!==s||e[11]!==a||e[12]!==g||e[13]!==P||e[14]!==C||e[15]!==t||e[16]!==k||e[17]!==n||e[18]!==o||e[19]!==l?(S={currentUser:s,homePosts:k,groupedStories:g,isPostsLoading:o,isStoriesLoading:l,hasMore:t,isFetchingNextPage:n,fetchNextPage:a,addToast:h,handlePostClick:P,handleUserClick:C},e[9]=h,e[10]=s,e[11]=a,e[12]=g,e[13]=P,e[14]=C,e[15]=t,e[16]=k,e[17]=n,e[18]=o,e[19]=l,e[20]=S):S=e[20],S};var Ve=G();const pt=()=>{const e=(0,Ve.c)(57),{id:s}=oe(),i=X(),{currentUser:o}=Z(),{onlineUsers:t}=De(),n=ee(),[a,h]=(0,_.useState)("");let c;e[0]===Symbol.for("react.memo_cache_sentinel")?(c=[],e[0]=c):c=e[0];const[w,r]=(0,_.useState)(c),{conversations:l,isConvLoading:b,sendMessage:v,sendTypingStatus:m,typingStatus:g,markAsRead:k,formatMessages:M,onDeleteMessage:P,conversationReactions:y,messages:C,isMsgLoading:S,fetchNextMessages:u,hasMoreMessages:p,isFetchingMoreMessages:L}=$e(o,s);let q;e:{if(!s||l.length===0){q=null;break e}let Q;e[1]!==l||e[2]!==s?(Q=l.find(T=>T.id===s)||null,e[1]=l,e[2]=s,e[3]=Q):Q=e[3],q=Q}const F=q;let d,$;e[4]!==s||e[5]!==k?(d=()=>{s&&k(s)},$=[s,k],e[4]=s,e[5]=k,e[6]=d,e[7]=$):(d=e[6],$=e[7]),(0,_.useEffect)(d,$);let x;e[8]!==l||e[9]!==o?.id||e[10]!==a?(x=()=>{const Q=setTimeout(async()=>{if(a.length>1){const T=await Le(a),W=l.map(We);r(T.filter(ae=>ae.id!==o?.id&&!W.includes(ae.id)))}else r([])},300);return()=>clearTimeout(Q)},e[8]=l,e[9]=o?.id,e[10]=a,e[11]=x):x=e[11];const K=o?.id;let R;e[12]!==l||e[13]!==a||e[14]!==K?(R=[a,l,K],e[12]=l,e[13]=a,e[14]=K,e[15]=R):R=e[15],(0,_.useEffect)(x,R);let f;e[16]!==o||e[17]!==i||e[18]!==n?(f=async Q=>{if(o)try{const T=await de(o.id,Q.id);n.invalidateQueries({queryKey:["conversations",o.id]}),h(""),i(`/messages/${T}`)}catch(T){console.error("Failed to start conversation:",T)}},e[16]=o,e[17]=i,e[18]=n,e[19]=f):f=e[19];const N=f;let E;e[20]!==i?(E=Q=>{i(`/messages/${Q.id}`)},e[20]=i,e[21]=E):E=e[21];const A=E;let O;e[22]!==y||e[23]!==M||e[24]!==C?(O=M(C,y),e[22]=y,e[23]=M,e[24]=C,e[25]=O):O=e[25];const B=O;let j;if(e[26]!==l||e[27]!==a){let Q;e[29]!==a?(Q=T=>T.user?.name?.toLowerCase().includes(a.toLowerCase())||T.user?.handle?.toLowerCase().includes(a.toLowerCase())||T.lastMessage?.toLowerCase().includes(a.toLowerCase()),e[29]=a,e[30]=Q):Q=e[30],j=l.filter(Q),e[26]=l,e[27]=a,e[28]=j}else j=e[28];const H=j,z=F&&g[F.id];let V;e[31]!==t||e[32]!==F?(V=F&&F.user?.id&&t.has(F.user.id),e[31]=t,e[32]=F,e[33]=V):V=e[33];const J=V;let D;return e[34]!==l||e[35]!==z||e[36]!==o||e[37]!==u||e[38]!==H||e[39]!==A||e[40]!==N||e[41]!==p||e[42]!==s||e[43]!==b||e[44]!==L||e[45]!==S||e[46]!==B||e[47]!==a||e[48]!==i||e[49]!==P||e[50]!==t||e[51]!==J||e[52]!==F||e[53]!==v||e[54]!==m||e[55]!==w?(D={id:s,currentUser:o,onlineUsers:t,msgSearchQuery:a,setMsgSearchQuery:h,userSearchResults:w,conversations:l,filteredConversations:H,selectedConversation:F,localMessages:B,isConvLoading:b,isMsgLoading:S,currentIsTyping:z,otherUserIsOnline:J,handleStartConversation:N,handleSelectConversation:A,sendMessage:v,onDeleteMessage:P,sendTypingStatus:m,navigate:i,fetchNextMessages:u,hasMoreMessages:p,isFetchingMoreMessages:L},e[34]=l,e[35]=z,e[36]=o,e[37]=u,e[38]=H,e[39]=A,e[40]=N,e[41]=p,e[42]=s,e[43]=b,e[44]=L,e[45]=S,e[46]=B,e[47]=a,e[48]=i,e[49]=P,e[50]=t,e[51]=J,e[52]=F,e[53]=v,e[54]=m,e[55]=w,e[56]=D):D=e[56],D};function We(e){return e.user?.id}var Ye=G();const Pt=()=>{const e=(0,Ye.c)(47),{currentUser:s}=Z(),i=X(),o=ee(),t=s?.id;let n;e[0]!==t?(n=["notifications",t],e[0]=t,e[1]=n):n=e[1];let a;e[2]!==s?.id?(a=R=>{const{pageParam:f}=R;return ge(s?.id,f,10)},e[2]=s?.id,e[3]=a):a=e[3];const h=!!s?.id;let c;e[4]!==n||e[5]!==a||e[6]!==h?(c={queryKey:n,queryFn:a,enabled:h,initialPageParam:null,getNextPageParam:Ge},e[4]=n,e[5]=a,e[6]=h,e[7]=c):c=e[7];const{data:w,fetchNextPage:r,hasNextPage:l,isFetchingNextPage:b,isLoading:v}=U(c);let m;e[8]!==w?.pages?(m=w?.pages.flatMap(Xe)||[],e[8]=w?.pages,e[9]=m):m=e[9];const g=m;let k;e[10]!==s||e[11]!==o?(k=()=>{if(!s?.id)return;const R=ie.channel(`user_notifications:${s.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`recipient_id=eq.${s.id}`},()=>{o.invalidateQueries({queryKey:["notifications",s.id]})}).subscribe();return()=>{ie.removeChannel(R)}},e[10]=s,e[11]=o,e[12]=k):k=e[12];const M=s?.id;let P;e[13]!==o||e[14]!==M?(P=[M,o],e[13]=o,e[14]=M,e[15]=P):P=e[15],(0,_.useEffect)(k,P);let y;e[16]!==s?(y=()=>s?we(s.id):Promise.resolve(),e[16]=s,e[17]=y):y=e[17];let C,S,u;e[18]!==s?.id||e[19]!==o?(C=async()=>{await o.cancelQueries({queryKey:["notifications",s?.id]});const R=o.getQueryData(["notifications",s?.id]);return o.setQueryData(["notifications",s?.id],Ue),{previousNotifications:R}},S=(R,f,N)=>{N?.previousNotifications&&o.setQueryData(["notifications",s?.id],N.previousNotifications)},u=()=>{o.invalidateQueries({queryKey:["notifications",s?.id]})},e[18]=s?.id,e[19]=o,e[20]=C,e[21]=S,e[22]=u):(C=e[20],S=e[21],u=e[22]);let p;e[23]!==C||e[24]!==S||e[25]!==u||e[26]!==y?(p={mutationFn:y,onMutate:C,onError:S,onSettled:u},e[23]=C,e[24]=S,e[25]=u,e[26]=y,e[27]=p):p=e[27];const L=se(p);let q;e[28]!==i?(q=R=>{R.type==="follow"?i(`/u/${R.user}`):R.post_id&&i(`/post/${R.post_id}`)},e[28]=i,e[29]=q):q=e[29];const F=q;let d;e[30]!==s?.id||e[31]!==L||e[32]!==g?(d=()=>{s?.id&&g.some(et)&&L.mutate()},e[30]=s?.id,e[31]=L,e[32]=g,e[33]=d):d=e[33];const $=s?.id;let x;e[34]!==L||e[35]!==g.length||e[36]!==$?(x=[$,g.length,L],e[34]=L,e[35]=g.length,e[36]=$,e[37]=x):x=e[37],(0,_.useEffect)(d,x);let K;return e[38]!==s||e[39]!==r||e[40]!==F||e[41]!==l||e[42]!==b||e[43]!==v||e[44]!==i||e[45]!==g?(K={currentUser:s,notifications:g,isLoading:v,isFetchingMore:b,hasMore:l,loadNotifications:r,handleNotificationClick:F,navigate:i},e[38]=s,e[39]=r,e[40]=F,e[41]=l,e[42]=b,e[43]=v,e[44]=i,e[45]=g,e[46]=K):K=e[46],K};function Ge(e){if(!(!e||e.length<10))return e[e.length-1].created_at}function Xe(e){return e}function Ze(e){return{...e,is_read:!0}}function Ie(e){return e.map(Ze)}function Ue(e){return e&&{...e,pages:e.pages.map(Ie)}}function et(e){return!e.is_read}var tt=G();const vt=()=>{const e=(0,tt.c)(23),{id:s}=oe(),i=X(),{currentUser:o}=Z(),{addToast:t}=te(),n=ee();let a,h;e[0]!==s?(a=["post",s],h=async()=>{if(!s||!Y(s))throw new Error("Invalid post ID");return Me(s)},e[0]=s,e[1]=a,e[2]=h):(a=e[1],h=e[2]);const c=!!s;let w;e[3]!==a||e[4]!==h||e[5]!==c?(w={queryKey:a,queryFn:h,enabled:c,retry:!1},e[3]=a,e[4]=h,e[5]=c,e[6]=w):w=e[6];const{data:r,isLoading:l,isError:b}=I(w);let v;e[7]!==i?(v=C=>{i(`/u/${C}`)},e[7]=i,e[8]=v):v=e[8];const m=v;let g;e[9]!==i?(g=()=>{i(-1)},e[9]=i,e[10]=g):g=e[10];const k=g;let M;e[11]!==n?(M=(C,S,u)=>{n.setQueryData(["post",C],p=>p&&{...p,content:S,media:u})},e[11]=n,e[12]=M):M=e[12];const P=M;let y;return e[13]!==t||e[14]!==o||e[15]!==k||e[16]!==P||e[17]!==m||e[18]!==b||e[19]!==l||e[20]!==i||e[21]!==r?(y={post:r,isLoading:l,isError:b,currentUser:o,addToast:t,navigate:i,handleUserClick:m,handleDelete:k,handleUpdate:P},e[13]=t,e[14]=o,e[15]=k,e[16]=P,e[17]=m,e[18]=b,e[19]=l,e[20]=i,e[21]=r,e[22]=y):y=e[22],y};var st=G();const wt=()=>{const e=(0,st.c)(31),s=X(),[i]=ce();let o;e[0]!==i?(o=i.get("id"),e[0]=i,e[1]=o):o=e[1];const t=o,n=(0,_.useRef)(null),[a,h]=(0,_.useState)(null),[c,w]=(0,_.useState)(!0);let r;e[2]===Symbol.for("react.memo_cache_sentinel")?(r=["reels"],e[2]=r):r=e[2];let l;e[3]===Symbol.for("react.memo_cache_sentinel")?(l={queryKey:r,queryFn:it,initialPageParam:null,getNextPageParam:ot},e[3]=l):l=e[3];const{data:b,fetchNextPage:v,hasNextPage:m,isFetchingNextPage:g,isLoading:k}=U(l);let M;e[4]!==b?.pages?(M=b?.pages.flatMap(nt)||[],e[4]=b?.pages,e[5]=M):M=e[5];const P=M;let y,C;e[6]!==a||e[7]!==P||e[8]!==t?(y=()=>{P.length>0&&(t&&P.find($=>$.id===t)?(h(t),setTimeout(()=>{document.querySelector(`[data-id="${t}"]`)?.scrollIntoView({behavior:"instant"})},100)):a||h(P[0].id))},C=[P,t,a],e[6]=a,e[7]=P,e[8]=t,e[9]=y,e[10]=C):(y=e[9],C=e[10]),(0,_.useEffect)(y,C);let S,u;e[11]!==P.length?(S=()=>{if(P.length===0)return;const $={root:n.current,threshold:.6},x=R=>{R.forEach(f=>{f.isIntersecting&&h(f.target.dataset.id)})},K=new IntersectionObserver(x,$);return setTimeout(()=>{document.querySelectorAll(".reel-item").forEach(R=>K.observe(R))},100),()=>K.disconnect()},u=[P.length],e[11]=P.length,e[12]=S,e[13]=u):(S=e[12],u=e[13]),(0,_.useEffect)(S,u);let p;e[14]!==c?(p=()=>{w(!c)},e[14]=c,e[15]=p):p=e[15];const L=p;let q,F;e[16]!==v||e[17]!==m||e[18]!==g?(F=()=>{const $=()=>{if(!n.current||g||!m)return;const{scrollTop:K,scrollHeight:R,clientHeight:f}=n.current;K+f>=R-800&&v()},x=n.current;if(x)return x.addEventListener("scroll",$),()=>x.removeEventListener("scroll",$)},q=[g,m,v],e[16]=v,e[17]=m,e[18]=g,e[19]=q,e[20]=F):(q=e[19],F=e[20]),(0,_.useEffect)(F,q);let d;return e[21]!==a||e[22]!==v||e[23]!==m||e[24]!==g||e[25]!==k||e[26]!==c||e[27]!==s||e[28]!==P||e[29]!==L?(d={reels:P,loading:k,loadingMore:g,activeReelId:a,hasMore:m,isMuted:c,containerRef:n,navigate:s,toggleMute:L,loadReels:v},e[21]=a,e[22]=v,e[23]=m,e[24]=g,e[25]=k,e[26]=c,e[27]=s,e[28]=P,e[29]=L,e[30]=d):d=e[30],d};function it(e){const{pageParam:s}=e;return fe(s,10)}function ot(e){if(!(!e||e.length<10))return e[e.length-1].sort_timestamp||e[e.length-1].created_at}function nt(e){return e}const bt=()=>{const{currentUser:e,logout:s}=Z(),{darkMode:i,toggleDarkMode:o,fontSize:t,setFontSize:n,dataSaver:a,setDataSaver:h}=Fe(),{addToast:c}=te(),[w,r]=(0,_.useState)(!1),[l,b]=(0,_.useState)({newPassword:"",confirmPassword:""}),[v,m]=(0,_.useState)(!1),g=async()=>{try{await s(),c("Logged out successfully")}catch(u){console.error("Logout error:",u),c("Failed to logout")}};return{currentUser:e,darkMode:i,toggleDarkMode:o,fontSize:t,setFontSize:n,dataSaver:a,setDataSaver:h,isChangingPassword:w,setIsChangingPassword:r,passwordData:l,setPasswordData:b,loading:v,handleLogout:g,handlePasswordChange:async u=>{if(u.preventDefault(),l.newPassword!==l.confirmPassword){c("Passwords do not match","error");return}if(l.newPassword.length<6){c("Password must be at least 6 characters","error");return}m(!0);try{const{error:p}=await ie.auth.updateUser({password:l.newPassword});if(p)throw p;c("Password updated successfully!"),r(!1),b({newPassword:"",confirmPassword:""})}catch(p){console.error("Password update error:",p),c(p.message||"Failed to update password","error")}finally{m(!1)}},handlePasswordReset:async()=>{if(e?.email){m(!0);try{const{error:u}=await ie.auth.resetPasswordForEmail(e.email,{redirectTo:`${window.location.origin}/settings?type=recovery`});if(u)throw u;c("Password reset email sent!")}catch(u){console.error("Reset password error:",u),c(u.message||"Failed to send reset email","error")}finally{m(!1)}}},handleClearCache:()=>{["seenStories","font-size","data-saver","theme"].forEach(u=>localStorage.removeItem(u)),c("Cache cleared! Reloading..."),setTimeout(()=>window.location.reload(),1500)},handleDownloadData:async()=>{if(e){m(!0);try{const u={user:{id:e.id,handle:e.handle,name:e.name,email:e.email},exportDate:new Date().toISOString(),note:"This is a mock export of your Sysm data."},p=new Blob([JSON.stringify(u,null,2)],{type:"application/json"}),L=URL.createObjectURL(p),q=document.createElement("a");q.href=L,q.download=`sysm-data-${e.handle}.json`,q.click(),URL.revokeObjectURL(L),c("Data export started!")}catch{c("Failed to export data","error")}finally{m(!1)}}},handleDeleteAccount:()=>{window.confirm("Are you absolutely sure? This will permanently delete your account and all associated data. This action is irreversible.")&&(c("Account deletion request submitted. Logging out..."),setTimeout(g,2e3))},handleReportBug:()=>{window.prompt("Please describe the bug you found:")&&c("Bug reported! Thank you for your feedback.")}}};export{pt as a,gt as c,dt as d,ut as f,Pt as i,mt as l,wt as n,yt as o,vt as r,ht as s,bt as t,ft as u};
