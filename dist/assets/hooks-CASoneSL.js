import{n as le}from"./rolldown-runtime-2JzG8er9.js";import{b as Z,s as ee,t as ce,v as ue,w as fe,y as V}from"./framework-pMVb9Z5_.js";import{i as de,n as ne,t as me}from"./query-CYcBlx0y.js";import{At as he,Bt as re,Dt as ge,Et as ye,Lt as oe,Mt as Se,Nt as Ce,Ot as Pe,Pt as pe,St as we,Tt as Me,_t as ke,dt as Fe,et as Le,ft as Re,gt as be,ht as ve,it as te,kt as Ee,mt as _e,ot as Ie,pt as Te,rt as $e,st as W,ut as De,vt as qe,wt as Ae,xt as Ue,yt as Ne,zt as G}from"./index-B8YHG8Ph.js";var t=le(fe(),1);const ze=(e,a,s,i)=>{const[r,c]=(0,t.useState)(!1),[o,h]=(0,t.useState)(!1),[g,m]=(0,t.useState)(a||{comments:0,likes:0,mirrors:0});return(0,t.useEffect)(()=>{s&&e&&G(e)&&G(s.id)&&(Ue(e,s.id).then(c).catch(()=>c(!1)),we(e,s.id).then(h).catch(()=>h(!1)))},[e,s]),{liked:r,reposted:o,localStats:g,setLocalStats:m,handleLike:async f=>{if(f&&f.stopPropagation(),!s)return i("Please login to like!","error");if(!G(e)||!G(s.id)){const u=!r;c(u),m(n=>({...n,likes:u?(n.likes||0)+1:(n.likes||0)-1}));return}try{const u=await Ee(e,s.id);c(u),m(n=>({...n,likes:u?(n.likes||0)+1:(n.likes||0)-1}))}catch(u){console.error("Failed to toggle like:",u)}},handleRepost:async f=>{if(f&&f.stopPropagation(),!s)return i("Please login to repost!","error");if(!G(e)||!G(s.id)){const u=!o;h(u),m(n=>({...n,mirrors:u?(n.mirrors||0)+1:(n.mirrors||0)-1}));return}try{const u=await he(e,s.id);h(u),m(n=>({...n,mirrors:u?(n.mirrors||0)+1:(n.mirrors||0)-1})),i(u?"Reposted!":"Removed repost")}catch(u){console.error("Failed to toggle repost:",u),i("Failed to update repost","error")}}}};var He=ee();const Ge=e=>{const a=(0,He.c)(5);let s;a[0]!==e?(s=()=>oe(e),a[0]=e,a[1]=s):s=a[1];const[i,r]=(0,t.useState)(s);let c,o;return a[2]!==e?(c=()=>{if(!e)return;const h=setTimeout(()=>{r(oe(e))},0),g=setInterval(()=>{r(oe(e))},6e4);return()=>{clearTimeout(h),clearInterval(g)}},o=[e],a[2]=e,a[3]=c,a[4]=o):(c=a[3],o=a[4]),(0,t.useEffect)(c,o),i},We=()=>{const{handle:e}=Z(),a=V(),{profiles:s,currentUser:i,getProfileByHandle:r}=W(),{addToast:c}=te(),[o,h]=(0,t.useState)(s[e?.toLowerCase()]),[g,m]=(0,t.useState)(!o),[y,l]=(0,t.useState)([]),[f,u]=(0,t.useState)("feed"),[n,S]=(0,t.useState)(!0),[R,d]=(0,t.useState)(!1),[w,k]=(0,t.useState)(!0),b=(0,t.useRef)(y);(0,t.useEffect)(()=>{b.current=y},[y]);const[C,_]=(0,t.useState)(!1),[T,$]=(0,t.useState)("Followers"),[F,P]=(0,t.useState)([]),[M,I]=(0,t.useState)(!1),[D,x]=(0,t.useState)(!1),[J,H]=(0,t.useState)(!0),B=(0,t.useRef)(F);(0,t.useEffect)(()=>{B.current=F},[F]);const K=(0,t.useCallback)(async(p,E=!1)=>{if(p){E?d(!0):S(!0);try{const N=b.current,A=await ye(p,E&&N.length>0?N[N.length-1].created_at:null,10);A.length<10?k(!1):k(!0),l(E?j=>[...j,...A]:A)}catch(N){console.error("Failed to fetch user posts:",N)}finally{S(!1),d(!1)}}},[]),v=async(p,E=!1)=>{const N=o?.id;if(N){E?x(!0):($(p),_(!0),I(!0),P([]));try{const A=B.current,j=E&&A.length>0?A[A.length-1].followed_at:null,z=p==="Followers"?await Se(N,j,10):await Ce(N,j,10);z.length<10?H(!1):H(!0),P(E?X=>[...X,...z]:z)}catch(A){console.error(`Failed to fetch ${p}:`,A),c(`Failed to load ${p}`)}finally{I(!1),x(!1)}}};(0,t.useEffect)(()=>{(async()=>{let E=s[e?.toLowerCase()];E?h(E):(m(!0),E=await r(e),h(E),m(!1)),E?.id&&K(E.id)})()},[e,s,r,K]);const L=(0,t.useMemo)(()=>f==="feed"?y.filter(p=>p.community_id===null&&p.parent_id===null):f==="media"?y.filter(p=>p.community_id===null&&p.parent_id===null&&(p.type==="video"||p.type==="image"||p.media&&p.media.length>0)):f==="collections"?[]:y,[y,f]);return{handle:e,profile:o,loading:g,userPosts:y,setUserPosts:l,activeProfileTab:f,setActiveProfileTab:u,loadingPosts:n,isFetchingMorePosts:R,hasMorePosts:w,filteredPosts:L,isFollowModalOpen:C,setIsFollowModalOpen:_,followModalType:T,followListData:F,isListLoading:M,isFetchingMoreFollows:D,hasMoreFollows:J,openFollowModal:v,handlePostClick:p=>{a(`/post/${p}`)},handleUserClick:p=>{p!==e&&a(`/u/${p}`)},loadUserPosts:K,currentUser:i,addToast:c,navigate:a}},Xe=()=>{const{handle:e}=Z(),a=V(),{currentUser:s}=W(),{addToast:i}=te(),[r,c]=(0,t.useState)(null),[o,h]=(0,t.useState)(!0),[g,m]=(0,t.useState)(!1),[y,l]=(0,t.useState)(null),[f,u]=(0,t.useState)(!1),[n,S]=(0,t.useState)([]),[R,d]=(0,t.useState)(!0),[w,k]=(0,t.useState)(!1),[b,C]=(0,t.useState)(!0),_=(0,t.useRef)(n);(0,t.useEffect)(()=>{_.current=n},[n]);const T=(0,t.useCallback)(async(F,P=!1)=>{if(F){P?k(!0):d(!0);try{const M=_.current,I=await Te(F,P&&M.length>0?M[M.length-1].sort_timestamp:null,10);I.length<10?C(!1):C(!0),S(P?D=>[...D,...I]:I)}catch(M){console.error("Failed to fetch community posts:",M)}finally{d(!1),k(!1)}}},[]);return(0,t.useEffect)(()=>{(async()=>{h(!0);try{const P=await Re(e);if(c(P),P?.id&&(T(P.id),s)){const M=await De(P.id,s.id);m(!!M),l(M?.role||null)}}catch{}finally{h(!1)}})()},[e,s,T]),{community:r,loading:o,isMember:g,userRole:y,isJoining:f,communityPosts:n,loadingPosts:R,isFetchingMorePosts:w,hasMorePosts:b,handleJoinToggle:async()=>{if(!s)return i("Please login to join communities","error");u(!0);try{const F=await _e(r.id,s.id);m(F),l(F?"member":null),c(P=>({...P,membersCount:F?P.membersCount+1:P.membersCount-1})),i(F?`Joined ${r.name}`:`Left ${r.name}`)}catch{i("Failed to update membership","error")}finally{u(!1)}},loadCommunityPosts:T,currentUser:s,addToast:i,navigate:a}},Ye=()=>{const{currentUser:e}=W(),a=V(),s=ue(),i=new URLSearchParams(s.search),r=i.get("q")||"",c=i.get("tab")||(r?"posts":"communities"),[o,h]=(0,t.useState)(r),[g,m]=(0,t.useState)(c),[y,l]=(0,t.useState)(!1),[f,u]=(0,t.useState)([]),[n,S]=(0,t.useState)(!0),[R,d]=(0,t.useState)(!1),[w,k]=(0,t.useState)(!0),b=(0,t.useRef)(f),[C,_]=(0,t.useState)([]),[T,$]=(0,t.useState)(!1),[F,P]=(0,t.useState)(!1),[M,I]=(0,t.useState)(!0),D=(0,t.useRef)(C);(0,t.useEffect)(()=>{b.current=f},[f]),(0,t.useEffect)(()=>{D.current=C},[C]),(0,t.useEffect)(()=>{r!==o&&(h(r),r&&m("posts"))},[r]);const x=(0,t.useCallback)(async(v=!1)=>{v?d(!0):S(!0);try{const L=b.current,O=await Fe(v&&L.length>0?L[L.length-1].createdAt:null,10);O.length<10?k(!1):k(!0),u(v?U=>[...U,...O]:O)}catch(L){console.error("Failed to fetch communities:",L)}finally{S(!1),d(!1)}},[]),J=(0,t.useCallback)(async(v=!1)=>{v?P(!0):$(!0);try{const L=D.current,O=v&&L.length>0?L[L.length-1].sort_timestamp||L[L.length-1].sortTimestamp:null;let U;o?U=await Pe(o,O,10,!0):U=await Ae(O,10),U.length<10?I(!1):I(!0),_(v?p=>[...p,...U]:U)}catch(L){console.error("Failed to load posts:",L)}finally{$(!1),P(!1)}},[o]);(0,t.useEffect)(()=>{x()},[x]),(0,t.useEffect)(()=>{J()},[o,J]);const H=(0,t.useMemo)(()=>{let v=f;return o&&(v=v.filter(L=>L.name?.toLowerCase().includes(o.toLowerCase())||L.handle?.toLowerCase().includes(o.toLowerCase()))),v},[f,o]);return{currentUser:e,searchQuery:o,setSearchQuery:v=>{h(v)},activeTab:g,setActiveTab:m,isCreateModalOpen:y,setIsCreateModalOpen:l,communitiesData:f,isCommunitiesLoading:n,isFetchingMoreCommunities:R,hasMoreCommunities:w,postsData:C,isPostsLoading:T,isFetchingMorePosts:F,hasMorePosts:M,filteredCommunities:H,handleCommunityClick:v=>{a(`/c/${v}`)},loadCommunities:x,loadPosts:J,navigate:a}};var Oe=ee();const Ze=()=>{const e=(0,Oe.c)(28),{currentUser:a}=W(),{posts:s,loading:i,hasMore:r,isFetchingNextPage:c,fetchNextPage:o}=$e(),{addToast:h}=te(),g=V();let m;e[0]===Symbol.for("react.memo_cache_sentinel")?(m={threshold:.1},e[0]=m):m=e[0];const{ref:y,inView:l}=ce(m);let f,u;e[1]!==o||e[2]!==r||e[3]!==l||e[4]!==c?(f=()=>{l&&r&&!c&&o()},u=[l,r,c,o],e[1]=o,e[2]=r,e[3]=l,e[4]=c,e[5]=f,e[6]=u):(f=e[5],u=e[6]),(0,t.useEffect)(f,u);let n;e[7]===Symbol.for("react.memo_cache_sentinel")?(n={queryKey:["stories"],queryFn:ve},e[7]=n):n=e[7];const{data:S,isLoading:R}=ne(n);let d;e[8]!==S?(d=S===void 0?[]:S,e[8]=S,e[9]=d):d=e[9];const w=d;let k;if(e[10]!==w){const M={};w.forEach(I=>{if(!I.user)return;const D=I.user.id;M[D]||(M[D]={user:I.user,stories:[]}),M[D].stories.push(I)}),k=Object.values(M),e[10]=w,e[11]=k}else k=e[11];const b=k,C=s;let _;e[12]!==g?(_=M=>{g(`/post/${M}`)},e[12]=g,e[13]=_):_=e[13];const T=_;let $;e[14]!==g?($=M=>{g(`/u/${M}`)},e[14]=g,e[15]=$):$=e[15];const F=$;let P;return e[16]!==h||e[17]!==a||e[18]!==b||e[19]!==T||e[20]!==F||e[21]!==r||e[22]!==C||e[23]!==c||e[24]!==i||e[25]!==R||e[26]!==y?(P={currentUser:a,homePosts:C,groupedStories:b,isPostsLoading:i,isStoriesLoading:R,hasMore:r,isFetchingNextPage:c,addToast:h,ref:y,handlePostClick:T,handleUserClick:F},e[16]=h,e[17]=a,e[18]=b,e[19]=T,e[20]=F,e[21]=r,e[22]=C,e[23]=c,e[24]=i,e[25]=R,e[26]=y,e[27]=P):P=e[27],P};var Qe=ee();const et=()=>{const e=(0,Qe.c)(64),{id:a}=Z(),s=V(),{currentUser:i}=W(),{onlineUsers:r}=Ie(),c=de(),[o,h]=(0,t.useState)("");let g;e[0]===Symbol.for("react.memo_cache_sentinel")?(g=[],e[0]=g):g=e[0];const[m,y]=(0,t.useState)(g),{conversations:l,isConvLoading:f,sendMessage:u,sendTypingStatus:n,typingStatus:S,markAsRead:R,formatMessages:d,onToggleReaction:w,allReactions:k}=Le(i);let b;e:{if(!a||l.length===0){b=null;break e}let q;e[1]!==l||e[2]!==a?(q=l.find(Q=>Q.id===a)||null,e[1]=l,e[2]=a,e[3]=q):q=e[3],b=q}const C=b;let _,T;e[4]!==a||e[5]!==R?(_=()=>{a&&R(a)},T=[a,R],e[4]=a,e[5]=R,e[6]=_,e[7]=T):(_=e[6],T=e[7]),(0,t.useEffect)(_,T);let $;e[8]!==l||e[9]!==i?.id||e[10]!==o?($=()=>{const q=setTimeout(async()=>{if(o.length>1){const Q=await pe(o),ae=l.map(xe);y(Q.filter(ie=>ie.id!==i?.id&&!ae.includes(ie.id)))}else y([])},300);return()=>clearTimeout(q)},e[8]=l,e[9]=i?.id,e[10]=o,e[11]=$):$=e[11];const F=i?.id;let P;e[12]!==l||e[13]!==o||e[14]!==F?(P=[o,l,F],e[12]=l,e[13]=o,e[14]=F,e[15]=P):P=e[15],(0,t.useEffect)($,P);let M;e[16]!==i||e[17]!==s||e[18]!==c?(M=async q=>{try{const Q=await Ne(i.id,q.id);c.invalidateQueries({queryKey:["conversations",i.id]}),h(""),s(`/messages/${Q}`)}catch(Q){console.error("Failed to start conversation:",Q)}},e[16]=i,e[17]=s,e[18]=c,e[19]=M):M=e[19];const I=M;let D;e[20]!==s?(D=q=>{s(`/messages/${q.id}`)},e[20]=s,e[21]=D):D=e[21];const x=D,J=C?.id;let H;e[22]!==J?(H=["messages",J],e[22]=J,e[23]=H):H=e[23];let B;e[24]!==C?.id?(B=()=>qe(C?.id),e[24]=C?.id,e[25]=B):B=e[25];const K=!!C?.id;let v;e[26]!==H||e[27]!==B||e[28]!==K?(v={queryKey:H,queryFn:B,enabled:K},e[26]=H,e[27]=B,e[28]=K,e[29]=v):v=e[29];const{data:L,isLoading:O}=ne(v);let U;e[30]!==L?(U=L===void 0?[]:L,e[30]=L,e[31]=U):U=e[31];const p=U;let E;e[32]!==k||e[33]!==p||e[34]!==d?(E=d(p,k),e[32]=k,e[33]=p,e[34]=d,e[35]=E):E=e[35];const N=E;let A;if(e[36]!==l||e[37]!==o){let q;e[39]!==o?(q=Q=>Q.user?.name?.toLowerCase().includes(o.toLowerCase())||Q.user?.handle?.toLowerCase().includes(o.toLowerCase())||Q.lastMessage?.toLowerCase().includes(o.toLowerCase()),e[39]=o,e[40]=q):q=e[40],A=l.filter(q),e[36]=l,e[37]=o,e[38]=A}else A=e[38];const j=A,z=C&&S[C.id];let X;e[41]!==r||e[42]!==C?(X=C&&r.has(C.user?.id),e[41]=r,e[42]=C,e[43]=X):X=e[43];const se=X;let Y;return e[44]!==l||e[45]!==z||e[46]!==i||e[47]!==j||e[48]!==x||e[49]!==I||e[50]!==a||e[51]!==f||e[52]!==O||e[53]!==N||e[54]!==o||e[55]!==s||e[56]!==w||e[57]!==r||e[58]!==se||e[59]!==C||e[60]!==u||e[61]!==n||e[62]!==m?(Y={id:a,currentUser:i,onlineUsers:r,msgSearchQuery:o,setMsgSearchQuery:h,userSearchResults:m,conversations:l,filteredConversations:j,selectedConversation:C,localMessages:N,isConvLoading:f,isMsgLoading:O,currentIsTyping:z,otherUserIsOnline:se,handleStartConversation:I,handleSelectConversation:x,sendMessage:u,sendTypingStatus:n,onToggleReaction:w,navigate:s},e[44]=l,e[45]=z,e[46]=i,e[47]=j,e[48]=x,e[49]=I,e[50]=a,e[51]=f,e[52]=O,e[53]=N,e[54]=o,e[55]=s,e[56]=w,e[57]=r,e[58]=se,e[59]=C,e[60]=u,e[61]=n,e[62]=m,e[63]=Y):Y=e[63],Y};function xe(e){return e.user?.id}const tt=()=>{const{currentUser:e}=W(),a=V(),[s,i]=(0,t.useState)([]),[r,c]=(0,t.useState)(!0),[o,h]=(0,t.useState)(!1),[g,m]=(0,t.useState)(!0),y=(0,t.useRef)(s);(0,t.useEffect)(()=>{y.current=s},[s]);const l=(0,t.useCallback)(async(n=!1)=>{if(e?.id){n?h(!0):c(!0);try{const S=y.current,R=n&&S.length>0?S[S.length-1].created_at:null,d=await be(e.id,R,10);d.length<10?m(!1):m(!0),i(n?w=>[...w,...d]:d)}catch(S){console.error("Failed to fetch notifications:",S)}finally{c(!1),h(!1)}}},[e?.id]);(0,t.useEffect)(()=>{l()},[l]),(0,t.useEffect)(()=>{if(!e?.id)return;const n=re.channel(`user_notifications:${e.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`recipient_id=eq.${e.id}`},()=>{l()}).subscribe();return()=>re.removeChannel(n)},[e?.id,l]);const f=me({mutationFn:()=>ke(e.id),onSuccess:()=>{i(n=>n.map(S=>({...S,is_read:!0})))}}),u=n=>{n.type==="follow"?a(`/u/${n.user}`):n.post_id&&a(`/post/${n.post_id}`)};return(0,t.useEffect)(()=>{e?.id&&s.some(n=>!n.is_read)&&f.mutate()},[e?.id,s,f]),{currentUser:e,notifications:s,isLoading:r,isFetchingMore:o,hasMore:g,loadNotifications:l,handleNotificationClick:u,navigate:a}};var Be=ee();const st=()=>{const e=(0,Be.c)(20),{id:a}=Z(),s=V(),{currentUser:i}=W(),{addToast:r}=te();let c,o;e[0]!==a?(c=["post",a],o=async()=>{if(!G(a))throw new Error("Invalid post ID");return Me(a)},e[0]=a,e[1]=c,e[2]=o):(c=e[1],o=e[2]);const h=!!a;let g;e[3]!==c||e[4]!==o||e[5]!==h?(g={queryKey:c,queryFn:o,enabled:h,retry:!1},e[3]=c,e[4]=o,e[5]=h,e[6]=g):g=e[6];const{data:m,isLoading:y,isError:l}=ne(g);let f;e[7]!==s?(f=d=>{s(`/u/${d}`)},e[7]=s,e[8]=f):f=e[8];const u=f;let n;e[9]!==s?(n=()=>{s(-1)},e[9]=s,e[10]=n):n=e[10];const S=n;let R;return e[11]!==r||e[12]!==i||e[13]!==S||e[14]!==u||e[15]!==l||e[16]!==y||e[17]!==s||e[18]!==m?(R={post:m,isLoading:y,isError:l,currentUser:i,addToast:r,navigate:s,handleUserClick:u,handleDelete:S},e[11]=r,e[12]=i,e[13]=S,e[14]=u,e[15]=l,e[16]=y,e[17]=s,e[18]=m,e[19]=R):R=e[19],R},ot=()=>{const e=V(),a=(0,t.useRef)(null),[s,i]=(0,t.useState)([]),[r,c]=(0,t.useState)(!0),[o,h]=(0,t.useState)(!1),[g,m]=(0,t.useState)(null),[y,l]=(0,t.useState)(!0),[f,u]=(0,t.useState)(!0),n=(0,t.useCallback)(async(d=null)=>{try{const w=await ge(d);w.length<10&&l(!1),d?i(k=>[...k,...w]):(i(w),w.length>0&&!g&&m(w[0].id))}catch(w){console.error("Error fetching reels:",w)}finally{c(!1),h(!1)}},[g]);(0,t.useEffect)(()=>{n()},[n]);const S=(0,t.useCallback)(()=>{if(!a.current||o||!y)return;const{scrollTop:d,scrollHeight:w,clientHeight:k}=a.current;if(d+k>=w-800){h(!0);const b=s[s.length-1];n(b?.sort_timestamp||b?.created_at)}},[s,o,y,n]);return(0,t.useEffect)(()=>{const d=a.current;if(d)return d.addEventListener("scroll",S),()=>d.removeEventListener("scroll",S)},[S]),(0,t.useEffect)(()=>{if(s.length===0)return;const d={root:a.current,threshold:.6},w=b=>{b.forEach(C=>{C.isIntersecting&&m(C.target.dataset.id)})},k=new IntersectionObserver(w,d);return document.querySelectorAll(".reel-item").forEach(b=>k.observe(b)),()=>k.disconnect()},[s]),{reels:s,loading:r,loadingMore:o,activeReelId:g,hasMore:y,isMuted:f,containerRef:a,navigate:e,toggleMute:()=>{u(!f)},loadReels:n}};export{Ze as a,We as c,et as i,Ge as l,st as n,Ye as o,tt as r,Xe as s,ot as t,ze as u};
