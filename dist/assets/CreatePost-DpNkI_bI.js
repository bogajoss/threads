import{a as Y}from"./rolldown-runtime-BaZ8gS7u.js";import{c as pe,s as ge}from"./animations-DZuN0xpW.js";import{_ as fe,g as be}from"./framework-YRQI4BOE.js";import{a as je,r as ve}from"./query-O_8RQZTX.js";import"./database-Bh-Nv8Zy.js";import{$t as ye,At as we,Fn as Ne,Gn as Ce,In as ke,Mn as Se,Pt as Pe,Un as Ae,Ut as ze,Vn as Fe,Wt as Ie,jn as Te,wn as De,xn as Re,zt as We}from"./ui-libs-dHBs5Tk6.js";import"./media-libs-CqtNZWFg.js";import{$t as Le,An as Ue,Dt as He,H as Me,Mt as Oe,Nt as $e,Ot as Ee,Qt as Ve,Zt as qe,an as Ge,at as X,gn as Qe,in as Ke,it as f,jn as F,jt as Be,ln as Xe,nt as Z,ot as Ze,rt as J,sn as Je,tn as I,yt as Ye}from"./index-CELpo5IH.js";import{n as w,t as _e}from"./actionsheet-Bek1Os7c.js";import{t as et}from"./useAutoResizeTextArea-n5XCjvX4.js";import{t as tt}from"./CircularProgress-D3aWv6b6.js";var l=Y(pe(),1),e=Y(ge(),1),st=()=>{const u=fe(),T=be(),{currentUser:o}=Je(),p=o?.isPro?2500:500,{addPost:_}=Ke(),{addToast:c}=Ge(),ee=je(),te=T.state?.initialCommunity,d=T.state?.isStory||!1,[i,se]=(0,l.useState)(""),[b,ae]=(0,l.useState)(""),[h,j]=(0,l.useState)([]),[D,R]=(0,l.useState)({}),[v,W]=(0,l.useState)({}),[L,N]=(0,l.useState)(!1),[U,ne]=(0,l.useState)(te||null),[g,re]=(0,l.useState)("anyone"),[le,C]=(0,l.useState)(!1),[k,y]=(0,l.useState)(""),[S,H]=(0,l.useState)(null),[M,O]=(0,l.useState)(null),[$,E]=(0,l.useState)(null),[oe,m]=(0,l.useState)(!1),ie=et(i,44,400),V=(0,l.useRef)(null),q=(0,l.useRef)(null),{data:P=[]}=ve({queryKey:["user-communities",o?.id],queryFn:()=>Qe(o.id),enabled:!!o?.id});(0,l.useEffect)(()=>{o||u("/login")},[o,u]);const G=t=>new Promise(a=>{const s=document.createElement("video");s.preload="auto",s.src=URL.createObjectURL(t),s.muted=!0,s.playsInline=!0,s.onloadeddata=()=>{s.currentTime=Math.min(1,s.duration/2)},s.onseeked=()=>{setTimeout(()=>{try{const n=document.createElement("canvas");n.width=s.videoWidth,n.height=s.videoHeight,n.getContext("2d")?.drawImage(s,0,0,n.width,n.height),a(n.toDataURL("image/jpeg",.7))}catch(n){console.error("Error capturing thumbnail:",n),a("")}finally{s.remove()}},150)},s.onerror=()=>{a("")}}),ce=async t=>{if(!t.target.files)return;const a=Array.from(t.target.files).map(s=>({id:Math.random().toString(36).substring(2,11),file:s}));j(s=>[...s,...a]);for(const s of a)if(s.file.type.startsWith("video/"))try{const n=await G(s.file);n&&R(r=>({...r,[s.id]:n}))}catch(n){console.error("Thumbnail generation failed",n)}},de=async t=>{const a=t.clipboardData.files;if(a&&a.length>0){const s=Array.from(a).filter(n=>n.type.startsWith("image/")||n.type.startsWith("video/"));if(s.length>0){t.preventDefault();const n=s.map(r=>({id:Math.random().toString(36).substring(2,11),file:r}));j(r=>[...r,...n]);for(const r of n)if(r.file.type.startsWith("video/"))try{const x=await G(r.file);x&&R(z=>({...z,[r.id]:x}))}catch(x){console.error("Thumbnail generation failed",x)}c(`Added ${n.length} image(s) from clipboard!`,"success")}}},ue=t=>{if(!t.target.files||!$)return;const a=t.target.files[0];W(s=>({...s,[$]:a})),E(null)},he=t=>{j(a=>a.filter(s=>s.id!==t)),W(a=>{const s={...a};return delete s[t],s})},Q=()=>{if(k.trim()){const t=k.trim().replace(/^#/,"");ae(a=>a?a.includes(t)?a:`${a}, ${t}`:t),y(""),C(!1),c(`Hashtag #${t} added!`)}},me=t=>{const a=new File([t],`cropped-${Date.now()}.jpg`,{type:"image/jpeg"});M&&j(s=>s.map(n=>n.id===M?{...n,file:a}:n)),H(null),O(null)},xe=async()=>{if(o&&!(!i.trim()&&h.length===0)&&!(i.length>p)){N(!0);try{const t=[];for(let n=0;n<h.length;n++){const r=h[n],x=v[r.id]||null,z=await Ue(r.file,"media",x);t.push(z)}let a=i;if(b.trim()){const n=b.split(",").map(r=>r.trim()).filter(r=>r.length>0).map(r=>r.startsWith("#")?r:`#${r}`).join(" ");a+=`

${n}`}let s="text";if(t.length>0&&(s=t[0].type==="video"?"video":"image"),d){if(t.length===0){c("Please add media for your story.","error"),N(!1);return}await Xe(o.id,t[0].url,t[0].type,i),ee.invalidateQueries({queryKey:["stories"]}),c("Story shared!")}else await _({content:a,media:t,type:s,userId:o.id,communityId:U?.id||null}),c("Post published!");u("/feed")}catch(t){console.error("Failed to create post:",t),c("Failed to publish content.","error")}finally{N(!1)}}};if(!o)return null;const K=!i.trim()&&h.length===0||L||i.length>p,A=p-i.length,B=i.length>p-20;return(0,e.jsxs)("div",{className:"flex flex-col min-h-screen bg-[--background] text-[--foreground] md:rounded-xl",children:[(0,e.jsxs)("div",{className:"flex items-center justify-between px-6 py-4 sticky top-0 bg-[--background]/90 backdrop-blur-xl z-20 border-b border-[--border] rounded-t-xl",children:[(0,e.jsx)("button",{onClick:()=>u(-1),className:"text-[15px] font-medium text-neutral-500 hover:text-[--foreground] transition-colors",children:"Cancel"}),(0,e.jsx)("h1",{className:"text-[17px] font-bold tracking-tight",children:d?"Add to Story":"Create post"}),(0,e.jsx)("button",{onClick:()=>m(!0),className:"text-[--foreground] p-1.5 hover:bg-neutral-100 dark:hover:bg-neutral-800 rounded-full transition-all",children:(0,e.jsx)(Ce,{size:22})})]}),(0,e.jsx)("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:(0,e.jsxs)("div",{className:"flex px-6 pt-6 pb-20",children:[(0,e.jsx)("div",{className:"flex flex-col items-center mr-4 pt-1",children:(0,e.jsxs)(qe,{className:"w-10 h-10 border-[3px] border-[--background] ring-1 ring-[--border]",children:[(0,e.jsx)(Le,{src:o.avatar,className:"object-cover"}),(0,e.jsx)(Ve,{children:o.name?.[0].toUpperCase()})]})}),(0,e.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,e.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,e.jsx)("span",{className:"font-bold text-[15px] tracking-tight hover:underline cursor-pointer",children:o.name}),!d&&P.length>0&&(0,e.jsxs)(Z,{onValueChange:t=>{ne(P.find(a=>a.id===t)||null)},value:U?.id||"none",children:[(0,e.jsxs)(X,{className:"h-7 px-3 py-0 border-none bg-neutral-100 dark:bg-neutral-900 text-[12px] font-bold rounded-full w-auto gap-1.5 focus:ring-0 hover:bg-neutral-200 dark:hover:bg-neutral-800 transition-colors",children:[(0,e.jsx)(Pe,{size:12,className:"text-neutral-500"}),(0,e.jsx)(Ze,{placeholder:"Anyone"})]}),(0,e.jsxs)(J,{align:"end",className:"bg-[--background] border-[--border] shadow-xl rounded-xl",children:[(0,e.jsx)(f,{value:"none",className:"text-xs font-medium py-2.5",children:"Public (Anyone)"}),P.map(t=>(0,e.jsx)(f,{value:t.id,className:"text-xs font-medium py-2.5",children:t.name},t.id))]})]})]}),(0,e.jsxs)("div",{className:"relative",children:[(0,e.jsx)("textarea",{ref:ie,placeholder:d?"Add a caption... (optional)":"What's new?",value:i,onChange:t=>se(t.target.value),onPaste:de,className:F("w-full bg-transparent text-[--foreground] placeholder-neutral-500 outline-none resize-none text-[16px] leading-relaxed min-h-[44px] mb-1 transition-colors",A<0&&"text-rose-500")}),i.length>0&&(0,e.jsxs)("div",{className:"absolute right-0 bottom-2 flex items-center gap-3",children:[(0,e.jsx)(tt,{current:i.length,max:p,size:22,strokeWidth:2.5,isWarning:B}),B&&(0,e.jsx)("span",{className:F("text-[11px] font-bold",A<0?"text-rose-500":"text-neutral-500"),children:A})]})]}),h.length>0&&(0,e.jsxs)("div",{className:"flex overflow-x-auto gap-3.5 mb-5 mt-2 pb-1 scrollbar-hide snap-x",children:[h.map(t=>(0,e.jsxs)("div",{className:"relative shrink-0 w-[260px] h-[340px] rounded-2xl overflow-hidden border border-[--border] bg-neutral-100 dark:bg-neutral-900 snap-start shadow-md group",children:[t.file.type.startsWith("video/")?(0,e.jsxs)(e.Fragment,{children:[v[t.id]||D[t.id]?(0,e.jsx)("img",{src:v[t.id]?URL.createObjectURL(v[t.id]):D[t.id],className:"w-full h-full object-cover",alt:"Video thumbnail"}):(0,e.jsx)("video",{src:URL.createObjectURL(t.file),className:"w-full h-full object-cover",muted:!0,playsInline:!0}),(0,e.jsx)("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent flex flex-col justify-end p-4 transition-all duration-300",children:(0,e.jsx)("div",{className:"flex items-center justify-start",children:(0,e.jsxs)("button",{type:"button",onClick:a=>{a.stopPropagation(),E(t.id),V.current?.click()},className:"text-[11px] font-bold text-white bg-black/60 backdrop-blur-xl px-3 py-2 rounded-full flex items-center gap-2 hover:bg-black/80 transition-colors shadow-lg border border-white/10",children:[(0,e.jsx)(Se,{size:14}),(0,e.jsx)("span",{children:"Change Cover"})]})})})]}):(0,e.jsx)("img",{src:URL.createObjectURL(t.file),alt:"preview",className:"w-full h-full object-cover"}),(0,e.jsx)("button",{onClick:()=>he(t.id),className:"absolute top-3.5 right-3.5 bg-black/50 backdrop-blur-lg text-white rounded-full p-2 hover:bg-rose-500 transition-all z-10 shadow-xl group-hover:scale-110 active:scale-90",children:(0,e.jsx)(we,{size:18})})]},t.id)),(0,e.jsx)("input",{type:"file",ref:V,className:"hidden",accept:"image/*",onChange:ue})]}),(0,e.jsxs)("div",{className:"flex items-center gap-7 mt-3 text-neutral-400",children:[(0,e.jsx)("button",{onClick:()=>q.current?.click(),className:"hover:text-[--foreground] transition-all p-1 hover:scale-110 active:scale-90",title:"Add Image/Video",children:(0,e.jsx)(Te,{size:22,strokeWidth:2.2})}),!d&&(0,e.jsx)("button",{disabled:!0,className:"hover:text-[--foreground] transition-all p-1 opacity-30 cursor-not-allowed",title:"Poll (Coming Soon)",children:(0,e.jsx)(Ie,{size:22,strokeWidth:2.2})}),!d&&(0,e.jsxs)(He,{open:le,onOpenChange:t=>{C(t),t||y("")},children:[(0,e.jsx)($e,{asChild:!0,children:(0,e.jsx)("button",{className:"hover:text-[--foreground] transition-all p-1 hover:scale-110 active:scale-90",title:"Add Hashtag",children:(0,e.jsx)(Ne,{size:22,strokeWidth:2.2})})}),(0,e.jsxs)(Ee,{className:"sm:max-w-[400px]",children:[(0,e.jsx)(Be,{children:(0,e.jsx)(Oe,{children:"Add Hashtag"})}),(0,e.jsxs)("div",{className:"flex flex-col gap-4 py-4",children:[(0,e.jsx)("input",{type:"text",value:k,onChange:t=>y(t.target.value.replace(/^#/,"")),onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),Q())},placeholder:"e.g. technology, news, sports",className:"w-full rounded-xl border border-[--border] bg-[--background] px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-[--primary]",autoFocus:!0}),(0,e.jsxs)("div",{className:"flex gap-2",children:[(0,e.jsx)(I,{onClick:()=>{C(!1),y("")},variant:"secondary",className:"flex-1",children:"Cancel"}),(0,e.jsx)(I,{onClick:Q,className:"flex-1",children:"Add Hashtag"})]})]})]})]}),(0,e.jsx)("button",{className:"hover:text-[--foreground] transition-all p-1 opacity-30 cursor-not-allowed",title:"Location",children:(0,e.jsx)(Re,{size:22,strokeWidth:2.2})})]}),b&&(0,e.jsx)("div",{className:"mt-4 flex flex-wrap gap-2.5",children:b.split(",").map((t,a)=>(0,e.jsxs)("span",{className:"text-[13px] font-bold text-blue-500 bg-blue-500/10 px-3 py-1 rounded-full border border-blue-500/20",children:["#",t.trim().replace(/^#/,"")]},a))})]})]})}),(0,e.jsxs)("div",{className:"flex items-center justify-between px-6 py-5 bg-[--background] border-t border-[--border] sticky bottom-0 z-20",children:[(0,e.jsxs)(Z,{value:g,onValueChange:re,children:[(0,e.jsxs)(X,{className:"border-none bg-transparent p-0 h-auto w-auto text-neutral-500 text-[14px] font-semibold hover:text-[--foreground] transition-colors gap-1.5 focus:ring-0",children:[g==="anyone"&&(0,e.jsx)(ke,{size:14}),g==="following"&&(0,e.jsx)(We,{size:14}),g==="mentioned"&&(0,e.jsx)(De,{size:14}),(0,e.jsxs)("span",{className:"capitalize",children:[g.replace("-"," ")," can reply"]})]}),(0,e.jsxs)(J,{align:"start",className:"bg-[--background] border-[--border] shadow-2xl rounded-2xl p-1.5",children:[(0,e.jsx)(f,{value:"anyone",className:"rounded-xl py-3 px-4 font-bold",children:"Anyone"}),(0,e.jsx)(f,{value:"following",className:"rounded-xl py-3 px-4 font-bold",children:"Profiles you follow"}),(0,e.jsx)(f,{value:"mentioned",className:"rounded-xl py-3 px-4 font-bold",children:"Mentioned only"})]})]}),(0,e.jsx)("div",{className:"flex items-center gap-3",children:!o?.isPro&&i.length>500?(0,e.jsx)(Me,{label:"Post",hoverLabel:"Go Pro!",onClick:()=>{u("/pro"),c("Pro users get 2500 character limit!","info")},className:"min-w-[120px] h-11"}):(0,e.jsx)(I,{onClick:xe,disabled:K,loading:L,className:F("min-w-[90px] h-11 shadow-xl transition-all active:scale-95 text-[15px]",K?"bg-neutral-100 text-neutral-400 dark:bg-neutral-900 dark:text-neutral-600 shadow-none":"shadow-[--primary]/20 bg-black text-white dark:bg-white dark:text-black"),children:d?"Share Story":"Post"})})]}),(0,e.jsx)("input",{type:"file",ref:q,onChange:ce,multiple:!0,className:"hidden",accept:"image/*,video/*"}),S&&(0,e.jsx)(Ye,{src:S,isOpen:!!S,onClose:()=>{H(null),O(null)},onCropComplete:me}),(0,e.jsxs)(_e,{isOpen:oe,onClose:()=>m(!1),title:"Post Options",children:[(0,e.jsx)(w,{icon:(0,e.jsx)(Fe,{size:20}),onClick:()=>{c("Draft saved (Simulated)"),m(!1)},children:"Save as draft"}),(0,e.jsx)(w,{icon:(0,e.jsx)(ye,{size:20}),onClick:()=>{c("Settings coming soon"),m(!1)},children:"Post settings"}),(0,e.jsx)(w,{icon:(0,e.jsx)(Ae,{size:20}),onClick:()=>{c("Visibility settings coming soon"),m(!1)},children:"Who can see this"}),(0,e.jsx)("div",{className:"h-px bg-[--border] my-1 mx-6"}),(0,e.jsx)(w,{variant:"destructive",icon:(0,e.jsx)(ze,{size:20}),onClick:()=>{confirm("Discard this post?")&&u(-1),m(!1)},children:"Discard post"})]})]})},xt=st;export{xt as default};
