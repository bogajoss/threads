import{a as fe}from"./rolldown-runtime-BaZ8gS7u.js";import{E as de,S as me,b as se,c as X,x as re}from"./framework-CsA6nn9m.js";import{a as ie,n as te,r as ne,t as Z}from"./query-QyXblnmD.js";import{$t as ge,Bt as ye,Dt as he,Et as pe,Ft as _e,Gt as Pe,Ht as we,Jt as Me,Lt as be,Mt as Se,Nt as ve,Pt as $e,Rt as Re,St as I,Tt as qe,Ut as Te,Vt as Fe,Wt as De,Xt as Le,Yt as ke,Zt as Qe,_n as ee,bt as Ne,c as xe,cn as Ke,en as Ce,gn as U,jt as Ee,kt as Ae,ln as Oe,mn as le,on as Be,qt as je,sn as Je,tn as ze,vt as He,wt as Ve,xt as Ge,yt as ae,zt as We}from"./index-D-CoZiVy.js";var Xe=X(),E=fe(de(),1);const Ye=(e,i,s)=>{const t=(0,Xe.c)(16);let a,l;t[0]!==i||t[1]!==e?(a=["follows",i,e],l=o=>{const{pageParam:f}=o;return(i==="Followers"?Be:Je)(e,f,10)},t[0]=i,t[1]=e,t[2]=a,t[3]=l):(a=t[2],l=t[3]);const n=!!e&&s;let _;t[4]!==a||t[5]!==l||t[6]!==n?(_={queryKey:a,queryFn:l,initialPageParam:null,getNextPageParam:Ze,enabled:n},t[4]=a,t[5]=l,t[6]=n,t[7]=_):_=t[7];const{data:d,fetchNextPage:m,hasNextPage:y,isFetchingNextPage:c,isLoading:S}=Z(_);let b;t[8]!==d?.pages?(b=d?.pages.flatMap(Ue)||[],t[8]=d?.pages,t[9]=b):b=t[9];const p=b;let P;return t[10]!==m||t[11]!==p||t[12]!==y||t[13]!==c||t[14]!==S?(P={followList:p,fetchNextPage:m,hasNextPage:y,isFetchingNextPage:c,isLoading:S},t[10]=m,t[11]=p,t[12]=y,t[13]=c,t[14]=S,t[15]=P):P=t[15],P};function Ze(e){if(!(!e||e.length<10))return e[e.length-1].followed_at}function Ue(e){return e}const Ie=(e,i)=>{const s=ie(),{addToast:t}=ae(),a=(0,E.useCallback)((o=[],f=[])=>o.map(r=>({id:r.id,sender:r.sender_id===e?.id?"me":"them",senderAvatar:r.sender?.avatar,senderName:r.sender?.name,text:r.content||"",type:r.type||"text",media:r.media?Array.isArray(r.media)?r.media:[r.media]:[],isRead:r.is_read||!1,replyToId:r.reply_to_id,replyTo:r.reply_to?{id:r.reply_to.id,text:r.reply_to.content,senderName:r.reply_to.sender?.display_name||r.reply_to.sender?.username||"Unknown",sender:r.reply_to.sender?.id===e?.id?"me":"them"}:null,reactions:f.filter(h=>h.message_id===r.id),time:r.created_at?new Date(r.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"Just now",updatedAt:r.updated_at,isOptimistic:r.isOptimistic})),[e?.id]),{data:l,fetchNextPage:n,hasNextPage:_,isFetchingNextPage:d,isLoading:m,refetch:y}=Z({queryKey:["messages",i],queryFn:({pageParam:o})=>be(i,o,20),initialPageParam:null,getNextPageParam:o=>{if(!(!o||o.length<20))return o[o.length-1].created_at},enabled:!!i,refetchOnWindowFocus:!1}),{data:c=[]}=ne({queryKey:["reactions",i],queryFn:()=>Re(i),enabled:!!i,staleTime:1e3*60*5}),S=te({mutationFn:({convId:o,text:f,type:r="text",media:h=[],replyToId:g=null})=>Fe(o,e.id,f,r,h,g),onMutate:async o=>{await s.cancelQueries({queryKey:["messages",i]});const f=s.getQueryData(["messages",i]),r={id:`temp-${Date.now()}`,conversation_id:i,sender_id:e.id,content:o.text,type:o.type||"text",media:o.media||[],reply_to_id:o.replyToId,is_read:!1,created_at:new Date().toISOString(),isOptimistic:!0,sender:{id:e.id,username:e.handle,display_name:e.name,avatar_url:e.avatar}};return s.setQueryData(["messages",i],h=>{if(!h)return{pages:[[r]],pageParams:[null]};const g=[...h.pages];return g[0]=[r,...g[0]],{...h,pages:g}}),{previousMessages:f}},onError:(o,f,r)=>{s.setQueryData(["messages",i],r?.previousMessages),t("Failed to send message","error")},onSettled:()=>{s.invalidateQueries({queryKey:["messages",i]}),s.invalidateQueries({queryKey:["conversations",e.id]})}}),b=te({mutationFn:({messageId:o,content:f})=>_e(o,f),onMutate:async({messageId:o,content:f})=>{await s.cancelQueries({queryKey:["messages",i]});const r=s.getQueryData(["messages",i]);return s.setQueryData(["messages",i],h=>h&&{...h,pages:h.pages.map(g=>g.map(u=>u.id===o?{...u,content:f}:u))}),{previousMessages:r}},onSuccess:o=>{o&&(s.invalidateQueries({queryKey:["messages",i]}),s.invalidateQueries({queryKey:["conversations",e?.id]}))},onError:(o,f,r)=>{s.setQueryData(["messages",i],r?.previousMessages),t("Failed to edit message","error")}}),p=async(o,f)=>{if(!e?.id||!i)return;await s.cancelQueries({queryKey:["reactions",i]});const r=s.getQueryData(["reactions",i]),h=r?.find(g=>g.message_id===o&&g.user_id===e.id&&g.emoji===f);s.setQueryData(["reactions",i],(g=[])=>{if(h)return g.filter(w=>w.id!==h.id);const u={id:`temp-${Date.now()}`,message_id:o,user_id:e.id,emoji:f,created_at:new Date().toISOString()};return[...g,u]});try{await we(o,e.id,f),s.invalidateQueries({queryKey:["reactions",i]})}catch(g){console.error("Failed to toggle reaction:",g),s.setQueryData(["reactions",i],r),t("Failed to update reaction","error")}},P=te({mutationFn:o=>$e(o),onMutate:async o=>{await s.cancelQueries({queryKey:["messages",i]});const f=s.getQueryData(["messages",i]);return s.setQueryData(["messages",i],r=>r&&{...r,pages:r.pages.map(h=>h.filter(g=>g.id!==o))}),{previousMessages:f}},onSuccess:()=>{s.invalidateQueries({queryKey:["messages",i]}),s.invalidateQueries({queryKey:["conversations",e?.id]})},onError:(o,f,r)=>{s.setQueryData(["messages",i],r?.previousMessages),t("Failed to delete message","error")}});return{messages:(0,E.useMemo)(()=>[...l?.pages.flatMap(o=>o)||[]].reverse(),[l]),isMsgLoading:m,refetchMessages:y,fetchNextMessages:n,hasMoreMessages:_,isFetchingMoreMessages:d,sendMessage:(o,f,r,h,g)=>S.mutate({convId:o,text:f,type:r,media:h,replyToId:g}),editMessage:(o,f)=>b.mutate({messageId:o,content:f}),isSending:S.isPending,isEditing:b.isPending,onToggleReaction:p,onDeleteMessage:o=>P.mutate(o),conversationReactions:c,formatMessages:a}};var et=X();const tt=(e,i)=>{const s=(0,et.c)(21),t=ie();let a;s[0]===Symbol.for("react.memo_cache_sentinel")?(a={},s[0]=a):a=s[0];const[l,n]=(0,E.useState)(a),_=(0,E.useRef)(null);let d;s[1]===Symbol.for("react.memo_cache_sentinel")?(d={},s[1]=d):d=s[1];const m=(0,E.useRef)(d);let y;s[2]!==e||s[3]!==t?(y=async r=>{if(!(!e?.id||!r))try{await ye(r),t.invalidateQueries({queryKey:["unread_messages_count",e.id]}),t.invalidateQueries({queryKey:["conversations",e.id]})}catch(h){console.error("Failed to mark as read:",h)}},s[2]=e,s[3]=t,s[4]=y):y=s[4];const c=y;let S;s[5]!==i||s[6]!==e||s[7]!==c||s[8]!==t?(S=()=>{if(!e?.id)return;const r=ee.channel(`messages_realtime:${i||"global"}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},u=>{const w=u.new;i&&w.conversation_id===i&&(t.invalidateQueries({queryKey:["messages",i]}),w.sender_id!==e.id&&c(i)),t.invalidateQueries({queryKey:["conversations",e.id]}),w.sender_id!==e.id&&t.invalidateQueries({queryKey:["unread_messages_count",e.id]}),n(M=>({...M,[w.conversation_id]:!1}))}).on("postgres_changes",{event:"DELETE",schema:"public",table:"messages"},()=>{t.invalidateQueries({queryKey:["messages"]}),t.invalidateQueries({queryKey:["conversations",e.id]})}).on("postgres_changes",{event:"*",schema:"public",table:"message_reactions"},()=>{i&&t.invalidateQueries({queryKey:["reactions",i]})}).subscribe(),h=ee.channel("chat_typing_shared").on("broadcast",{event:"typing"},u=>{const{payload:w}=u,{conversationId:M,isTyping:$,userId:R}=w;R!==e.id&&(n(F=>({...F,[M]:$})),m.current[M]&&window.clearTimeout(m.current[M]),$&&(m.current[M]=window.setTimeout(()=>{n(F=>({...F,[M]:!1}))},5e3)))}).subscribe();_.current=h;const g=m.current;return()=>{ee.removeChannel(r),ee.removeChannel(h),Object.values(g).forEach(window.clearTimeout)}},s[5]=i,s[6]=e,s[7]=c,s[8]=t,s[9]=S):S=s[9];const b=e?.id;let p;s[10]!==i||s[11]!==c||s[12]!==t||s[13]!==b?(p=[b,t,i,c],s[10]=i,s[11]=c,s[12]=t,s[13]=b,s[14]=p):p=s[14],(0,E.useEffect)(S,p);let P;s[15]!==e?(P=(r,h)=>{_.current&&e&&_.current.send({type:"broadcast",event:"typing",payload:{conversationId:r,isTyping:h,userId:e.id}})},s[15]=e,s[16]=P):P=s[16];const o=P;let f;return s[17]!==c||s[18]!==o||s[19]!==l?(f={typingStatus:l,sendTypingStatus:o,markAsRead:c},s[17]=c,s[18]=o,s[19]=l,s[20]=f):f=s[20],f};var st=X();const it=(e,i)=>{const s=(0,st.c)(22),{conversations:t,unreadCount:a,isConvLoading:l,refetchConversations:n}=xe(e),{messages:_,isMsgLoading:d,refetchMessages:m,fetchNextMessages:y,hasMoreMessages:c,isFetchingMoreMessages:S,sendMessage:b,editMessage:p,isSending:P,isEditing:o,onToggleReaction:f,onDeleteMessage:r,conversationReactions:h,formatMessages:g}=Ie(e,i),{typingStatus:u,sendTypingStatus:w,markAsRead:M}=tt(e,i);let $;return s[0]!==h||s[1]!==t||s[2]!==p||s[3]!==y||s[4]!==g||s[5]!==c||s[6]!==l||s[7]!==o||s[8]!==S||s[9]!==d||s[10]!==P||s[11]!==M||s[12]!==_||s[13]!==r||s[14]!==f||s[15]!==n||s[16]!==m||s[17]!==b||s[18]!==w||s[19]!==u||s[20]!==a?($={conversations:t,unreadCount:a,isConvLoading:l,refetchConversations:n,refetchMessages:m,sendMessage:b,editMessage:p,sendTypingStatus:w,typingStatus:u,markAsRead:M,formatMessages:g,onToggleReaction:f,onDeleteMessage:r,conversationReactions:h,isSending:P,isEditing:o,messages:_,isMsgLoading:d,fetchNextMessages:y,hasMoreMessages:c,isFetchingMoreMessages:S},s[0]=h,s[1]=t,s[2]=p,s[3]=y,s[4]=g,s[5]=c,s[6]=l,s[7]=o,s[8]=S,s[9]=d,s[10]=P,s[11]=M,s[12]=_,s[13]=r,s[14]=f,s[15]=n,s[16]=m,s[17]=b,s[18]=w,s[19]=u,s[20]=a,s[21]=$):$=s[21],$};var nt=X();const It=(e,i,s)=>{const t=(0,nt.c)(85),a=ie(),{addToast:l}=ae();let n;t[0]!==i?(n=i||{comments:0,likes:0,mirrors:0,reposts:0},t[0]=i,t[1]=n):n=t[1];const[_,d]=(0,E.useState)(n),[m,y]=(0,E.useState)(i);i!==m&&(y(i),d(C=>({...C,...i})));const c=s?.id;let S;t[2]!==e||t[3]!==c?(S=["post",e,"liked",c],t[2]=e,t[3]=c,t[4]=S):S=t[4];let b,p;t[5]!==s||t[6]!==e?(b=()=>De(e,s.id),p=!!s&&U(e)&&U(s.id),t[5]=s,t[6]=e,t[7]=b,t[8]=p):(b=t[7],p=t[8]);let P;t[9]!==S||t[10]!==b||t[11]!==p?(P={queryKey:S,queryFn:b,enabled:p,staleTime:6e5},t[9]=S,t[10]=b,t[11]=p,t[12]=P):P=t[12];const{data:o}=ne(P),f=o===void 0?!1:o,r=s?.id;let h;t[13]!==e||t[14]!==r?(h=["post",e,"reposted",r],t[13]=e,t[14]=r,t[15]=h):h=t[15];let g,u;t[16]!==s||t[17]!==e?(u=()=>Pe(e,s.id),g=!!s&&U(e)&&U(s.id),t[16]=s,t[17]=e,t[18]=g,t[19]=u):(g=t[18],u=t[19]);let w;t[20]!==g||t[21]!==h||t[22]!==u?(w={queryKey:h,queryFn:u,enabled:g,staleTime:6e5},t[20]=g,t[21]=h,t[22]=u,t[23]=w):w=t[23];const{data:M}=ne(w),$=M===void 0?!1:M;let R;t[24]!==s||t[25]!==e?(R=()=>Ce(e,s.id),t[24]=s,t[25]=e,t[26]=R):R=t[26];let F;t[27]!==s||t[28]!==e||t[29]!==a?(F=async()=>{const C=s.id;await a.cancelQueries({queryKey:["post",e,"liked",C]});const J=a.getQueryData(["post",e,"liked",C]);return a.setQueryData(["post",e,"liked",C],!J),d(v=>({...v,likes:J?(v.likes||0)-1:(v.likes||0)+1})),{previousLiked:J}},t[27]=s,t[28]=e,t[29]=a,t[30]=F):F=t[30];let D;t[31]!==l||t[32]!==s||t[33]!==e||t[34]!==a?(D=(C,J,v)=>{v?.previousLiked!==void 0&&(a.setQueryData(["post",e,"liked",s.id],v.previousLiked),d(V=>({...V,likes:v.previousLiked?(V.likes||0)+1:(V.likes||0)-1}))),l("Failed to update like","error")},t[31]=l,t[32]=s,t[33]=e,t[34]=a,t[35]=D):D=t[35];let k;t[36]!==s?.id||t[37]!==e||t[38]!==a?(k=()=>{a.invalidateQueries({queryKey:["post",e,"liked",s?.id]})},t[36]=s?.id,t[37]=e,t[38]=a,t[39]=k):k=t[39];let Q;t[40]!==R||t[41]!==F||t[42]!==D||t[43]!==k?(Q={mutationFn:R,onMutate:F,onError:D,onSettled:k},t[40]=R,t[41]=F,t[42]=D,t[43]=k,t[44]=Q):Q=t[44];const q=te(Q);let N;t[45]!==s||t[46]!==e?(N=()=>ze(e,s.id),t[45]=s,t[46]=e,t[47]=N):N=t[47];let T;t[48]!==s||t[49]!==e||t[50]!==a?(T=async()=>{const C=s.id;await a.cancelQueries({queryKey:["post",e,"reposted",C]});const J=a.getQueryData(["post",e,"reposted",C]);return a.setQueryData(["post",e,"reposted",C],!J),d(v=>({...v,reposts:J?(v.reposts||0)-1:(v.reposts||0)+1,mirrors:J?(v.mirrors||0)-1:(v.mirrors||0)+1})),{previousReposted:J}},t[48]=s,t[49]=e,t[50]=a,t[51]=T):T=t[51];let A;t[52]!==l||t[53]!==s||t[54]!==e||t[55]!==a?(A=(C,J,v)=>{v?.previousReposted!==void 0&&(a.setQueryData(["post",e,"reposted",s.id],v.previousReposted),d(V=>({...V,reposts:v.previousReposted?(V.reposts||0)+1:(V.reposts||0)-1,mirrors:v.previousReposted?(V.mirrors||0)+1:(V.mirrors||0)-1}))),l("Failed to update repost","error")},t[52]=l,t[53]=s,t[54]=e,t[55]=a,t[56]=A):A=t[56];let O;t[57]!==s?.id||t[58]!==e||t[59]!==a?(O=()=>{a.invalidateQueries({queryKey:["post",e,"reposted",s?.id]})},t[57]=s?.id,t[58]=e,t[59]=a,t[60]=O):O=t[60];let j;t[61]!==l?(j=C=>{l(C?"Reposted!":"Removed repost")},t[61]=l,t[62]=j):j=t[62];let B;t[63]!==N||t[64]!==T||t[65]!==A||t[66]!==O||t[67]!==j?(B={mutationFn:N,onMutate:T,onError:A,onSettled:O,onSuccess:j},t[63]=N,t[64]=T,t[65]=A,t[66]=O,t[67]=j,t[68]=B):B=t[68];const G=te(B);let H;t[69]!==l||t[70]!==s||t[71]!==q||t[72]!==e?(H=async C=>{if(C&&C.stopPropagation(),!s)return l("Please login to like!","error");!U(e)||!U(s.id)||q.mutate()},t[69]=l,t[70]=s,t[71]=q,t[72]=e,t[73]=H):H=t[73];const z=H;let x;t[74]!==l||t[75]!==s||t[76]!==e||t[77]!==G?(x=async C=>{if(C&&C.stopPropagation(),!s)return l("Please login to repost!","error");!U(e)||!U(s.id)||G.mutate()},t[74]=l,t[75]=s,t[76]=e,t[77]=G,t[78]=x):x=t[78];const K=x;let L;return t[79]!==z||t[80]!==K||t[81]!==f||t[82]!==$||t[83]!==_?(L={liked:f,reposted:$,localStats:_,setLocalStats:d,handleLike:z,handleRepost:K},t[79]=z,t[80]=K,t[81]=f,t[82]=$,t[83]=_,t[84]=L):L=t[84],L};var at=X();const es=e=>{const i=(0,at.c)(5);let s;i[0]!==e?(s=()=>le(e),i[0]=e,i[1]=s):s=i[1];const[t,a]=(0,E.useState)(s);let l,n;return i[2]!==e?(l=()=>{if(!e)return;const _=setTimeout(()=>{a(le(e))},0),d=setInterval(()=>{a(le(e))},6e4);return()=>{clearTimeout(_),clearInterval(d)}},n=[e],i[2]=e,i[3]=l,i[4]=n):(l=i[3],n=i[4]),(0,E.useEffect)(l,n),t};var ot=X();const ts=()=>{const e=(0,ot.c)(30),[i,s]=(0,E.useState)(!1),[t,a]=(0,E.useState)(!1),[l,n]=(0,E.useState)(0),[_,d]=(0,E.useState)(null),[m,y]=(0,E.useState)(null),c=(0,E.useRef)(null),S=(0,E.useRef)(null);let b;e[0]===Symbol.for("react.memo_cache_sentinel")?(b=[],e[0]=b):b=e[0];const p=(0,E.useRef)(b);let P,o;e[1]!==m?(P=()=>()=>{S.current&&clearInterval(S.current),c.current&&c.current.state!=="inactive"&&(c.current.stop(),c.current.stream.getTracks().forEach(rt)),m&&URL.revokeObjectURL(m)},o=[m],e[1]=m,e[2]=P,e[3]=o):(P=e[2],o=e[3]),(0,E.useEffect)(P,o);let f;e[4]===Symbol.for("react.memo_cache_sentinel")?(f=()=>{S.current=window.setInterval(()=>{n(lt)},1e3)},e[4]=f):f=e[4];const r=f;let h;e[5]===Symbol.for("react.memo_cache_sentinel")?(h=()=>{S.current&&(clearInterval(S.current),S.current=null)},e[5]=h):h=e[5];const g=h;let u;e[6]===Symbol.for("react.memo_cache_sentinel")?(u=async()=>{try{const O=await navigator.mediaDevices.getUserMedia({audio:!0}),j=new MediaRecorder(O);c.current=j,p.current=[],j.ondataavailable=B=>{B.data.size>0&&p.current.push(B.data)},j.onstop=()=>{const B=new Blob(p.current,{type:"audio/webm;codecs=opus"}),G=URL.createObjectURL(B);d(B),y(G),O.getTracks().forEach(ct)},j.start(),s(!0),a(!1),n(0),r()}catch(O){const j=O;throw console.error("Error accessing microphone:",j),j}},e[6]=u):u=e[6];const w=u;let M;e[7]!==i?(M=()=>{c.current&&i&&(c.current.stop(),s(!1),a(!1),g())},e[7]=i,e[8]=M):M=e[8];const $=M;let R;e[9]!==t||e[10]!==i?(R=()=>{c.current&&i&&!t&&(c.current.pause(),a(!0),g())},e[9]=t,e[10]=i,e[11]=R):R=e[11];const F=R;let D;e[12]!==t||e[13]!==i?(D=()=>{c.current&&i&&t&&(c.current.resume(),a(!1),r())},e[12]=t,e[13]=i,e[14]=D):D=e[14];const k=D;let Q;e[15]!==i?(Q=()=>{c.current&&i&&(c.current.stop(),c.current.onstop=null,s(!1),a(!1),g(),n(0),c.current.stream&&c.current.stream.getTracks().forEach(ut))},e[15]=i,e[16]=Q):Q=e[16];const q=Q;let N;e[17]!==m?(N=()=>{m&&URL.revokeObjectURL(m),d(null),y(null),n(0)},e[17]=m,e[18]=N):N=e[18];const T=N;let A;return e[19]!==_||e[20]!==m||e[21]!==q||e[22]!==T||e[23]!==t||e[24]!==i||e[25]!==F||e[26]!==l||e[27]!==k||e[28]!==$?(A={isRecording:i,isPaused:t,recordingTime:l,startRecording:w,stopRecording:$,pauseRecording:F,resumeRecording:k,cancelRecording:q,audioBlob:_,audioUrl:m,clearAudio:T},e[19]=_,e[20]=m,e[21]=q,e[22]=T,e[23]=t,e[24]=i,e[25]=F,e[26]=l,e[27]=k,e[28]=$,e[29]=A):A=e[29],A};function rt(e){return e.stop()}function lt(e){return e+1}function ct(e){return e.stop()}function ut(e){return e.stop()}var mt=X();const ss=(e,i,s)=>{const t=(0,mt.c)(39),a=ie(),{currentUser:l}=I();let n,_;t[0]!==s||t[1]!==e?(n=["comments",e,s],_=F=>{const{pageParam:D}=F;return je(e,D,10,s)},t[0]=s,t[1]=e,t[2]=n,t[3]=_):(n=t[2],_=t[3]);let d;t[4]!==i?(d=i?{pages:[i],pageParams:[null]}:void 0,t[4]=i,t[5]=d):d=t[5];const m=!!e;let y;t[6]!==n||t[7]!==_||t[8]!==d||t[9]!==m?(y={queryKey:n,queryFn:_,initialPageParam:null,getNextPageParam:ft,initialData:d,enabled:m},t[6]=n,t[7]=_,t[8]=d,t[9]=m,t[10]=y):y=t[10];const{data:c,fetchNextPage:S,hasNextPage:b,isFetchingNextPage:p,isLoading:P,refetch:o}=Z(y);let f;t[11]!==c?.pages?(f=c?.pages.flatMap(dt)||[],t[11]=c?.pages,t[12]=f):f=t[12];const r=f;let h;t[13]!==e?(h=F=>{const{userId:D,content:k,media:Q,replyToId:q}=F;return Te(e,D,k,Q,q)},t[13]=e,t[14]=h):h=t[14];let g;t[15]!==l||t[16]!==s||t[17]!==e||t[18]!==a?(g=async F=>{const D=["comments",e,s];await a.cancelQueries({queryKey:D});const k=a.getQueryData(D);if(k&&l){const Q={id:`temp-${Date.now()}`,post_id:e,user_id:l.id,content:F.content,media:F.media||null,created_at:new Date().toISOString(),parent_id:F.replyToId||s||null,stats:{likes:0,comments:0},user:l,timeAgo:"just now"};a.setQueryData(D,q=>q&&{...q,pages:[[Q,...q.pages[0]],...q.pages.slice(1)]})}return{previousComments:k}},t[15]=l,t[16]=s,t[17]=e,t[18]=a,t[19]=g):g=t[19];let u,w;t[20]!==s||t[21]!==e||t[22]!==a?(u=(F,D,k)=>{const Q=["comments",e,s];k?.previousComments&&a.setQueryData(Q,k.previousComments)},w=()=>{a.invalidateQueries({queryKey:["comments",e]}),s&&a.invalidateQueries({queryKey:["comments",e,s]})},t[20]=s,t[21]=e,t[22]=a,t[23]=u,t[24]=w):(u=t[23],w=t[24]);let M;t[25]!==h||t[26]!==g||t[27]!==u||t[28]!==w?(M={mutationFn:h,onMutate:g,onError:u,onSuccess:w},t[25]=h,t[26]=g,t[27]=u,t[28]=w,t[29]=M):M=t[29];const $=te(M);let R;return t[30]!==$.isPending||t[31]!==$.mutateAsync||t[32]!==r||t[33]!==S||t[34]!==b||t[35]!==p||t[36]!==P||t[37]!==o?(R={comments:r,fetchNextPage:S,hasNextPage:b,isFetchingNextPage:p,isLoading:P,refetch:o,addComment:$.mutateAsync,isSubmitting:$.isPending},t[30]=$.isPending,t[31]=$.mutateAsync,t[32]=r,t[33]=S,t[34]=b,t[35]=p,t[36]=P,t[37]=o,t[38]=R):R=t[38],R};function ft(e){if(!(!e||e.length<10))return e[e.length-1].created_at}function dt(e){return e}var gt=X();const is=()=>{const e=(0,gt.c)(53),{handle:i}=re(),s=se(),{currentUser:t}=I(),{addToast:a}=ae();let l,n;e[0]!==i?(l=["profile",i],n=()=>Ke(i),e[0]=i,e[1]=l,e[2]=n):(l=e[1],n=e[2]);const _=!!i;let d;e[3]!==l||e[4]!==n||e[5]!==_?(d={queryKey:l,queryFn:n,enabled:_,staleTime:3e5},e[3]=l,e[4]=n,e[5]=_,e[6]=d):d=e[6];const{data:m,isLoading:y}=ne(d),[c,S]=(0,E.useState)("feed"),b=m?.id;let p;e[7]!==b?(p=["posts","user",b],e[7]=b,e[8]=p):p=e[8];let P;e[9]!==m?(P=v=>{const{pageParam:V}=v;return Le(m.id,V,20)},e[9]=m,e[10]=P):P=e[10];const o=!!m?.id;let f;e[11]!==p||e[12]!==P||e[13]!==o?(f={queryKey:p,queryFn:P,enabled:o,initialPageParam:null,getNextPageParam:yt},e[11]=p,e[12]=P,e[13]=o,e[14]=f):f=e[14];const{data:r,fetchNextPage:h,hasNextPage:g,isFetchingNextPage:u,isLoading:w}=Z(f);let M;e[15]!==r?.pages?(M=r?.pages.flatMap(ht)||[],e[15]=r?.pages,e[16]=M):M=e[16];const $=M,[R,F]=(0,E.useState)(!1),[D,k]=(0,E.useState)("Followers"),{followList:Q,fetchNextPage:q,hasNextPage:N,isFetchingNextPage:T,isLoading:A}=Ye(m?.id,D,R);let O;e[17]===Symbol.for("react.memo_cache_sentinel")?(O=v=>{k(v),F(!0)},e[17]=O):O=e[17];const j=O;let B;e:{if(c==="feed"){let v;e[18]!==$?(v=$.filter(pt),e[18]=$,e[19]=v):v=e[19],B=v;break e}if(c==="media"){let v;e[20]!==$?(v=$.filter(_t),e[20]=$,e[21]=v):v=e[21],B=v;break e}if(c==="collections"){let v;e[22]===Symbol.for("react.memo_cache_sentinel")?(v=[],e[22]=v):v=e[22],B=v;break e}B=$}const G=B;let H;e[23]!==s?(H=v=>{s(`/p/${v}`)},e[23]=s,e[24]=H):H=e[24];const z=H;let x;e[25]!==i||e[26]!==s?(x=v=>{v!==i&&s(`/u/${v}`)},e[25]=i,e[26]=s,e[27]=x):x=e[27];const K=x;let L;e[28]!==h?(L=()=>{h()},e[28]=h,e[29]=L):L=e[29];const C=L;let J;return e[30]!==c||e[31]!==a||e[32]!==t||e[33]!==q||e[34]!==G||e[35]!==Q||e[36]!==D||e[37]!==i||e[38]!==z||e[39]!==K||e[40]!==N||e[41]!==g||e[42]!==T||e[43]!==u||e[44]!==R||e[45]!==A||e[46]!==C||e[47]!==w||e[48]!==y||e[49]!==s||e[50]!==m||e[51]!==$?(J={handle:i,profile:m,loading:y,userPosts:$,setUserPosts:Pt,activeProfileTab:c,setActiveProfileTab:S,loadingPosts:w,isFetchingMorePosts:u,hasMorePosts:g,filteredPosts:G,isFollowModalOpen:R,setIsFollowModalOpen:F,followModalType:D,followListData:Q,isListLoading:A,isFetchingMoreFollows:T,hasMoreFollows:N,openFollowModal:j,fetchNextFollows:q,handlePostClick:z,handleUserClick:K,loadUserPosts:C,currentUser:t,addToast:a,navigate:s},e[30]=c,e[31]=a,e[32]=t,e[33]=q,e[34]=G,e[35]=Q,e[36]=D,e[37]=i,e[38]=z,e[39]=K,e[40]=N,e[41]=g,e[42]=T,e[43]=u,e[44]=R,e[45]=A,e[46]=C,e[47]=w,e[48]=y,e[49]=s,e[50]=m,e[51]=$,e[52]=J):J=e[52],J};function yt(e){if(!(!e||e.length<20))return e[e.length-1].sort_timestamp||e[e.length-1].created_at}function ht(e){return e}function pt(e){return e.community_id===null&&e.parent_id===null}function _t(e){return e.community_id===null&&e.parent_id===null&&(e.type==="video"||e.type==="image"||e.media&&e.media.length>0)}function Pt(){return console.warn("setUserPosts is deprecated")}var wt=X();const ns=()=>{const e=(0,wt.c)(75),{handle:i}=re(),s=se(),{currentUser:t}=I(),{addToast:a}=ae(),l=ie();let n,_;e[0]!==i?(n=["community",i],_=()=>pe(i),e[0]=i,e[1]=n,e[2]=_):(n=e[1],_=e[2]);const d=!!i;let m;e[3]!==n||e[4]!==_||e[5]!==d?(m={queryKey:n,queryFn:_,enabled:d,staleTime:6e5},e[3]=n,e[4]=_,e[5]=d,e[6]=m):m=e[6];const{data:y,isLoading:c,refetch:S}=ne(m),b=y?.id,p=t?.id;let P;e[7]!==b||e[8]!==p?(P=["community",b,"membership",p],e[7]=b,e[8]=p,e[9]=P):P=e[9];let o;e[10]!==y||e[11]!==t?(o=()=>Ve(y.id,t.id),e[10]=y,e[11]=t,e[12]=o):o=e[12];const f=!!y?.id&&!!t?.id;let r;e[13]!==P||e[14]!==o||e[15]!==f?(r={queryKey:P,queryFn:o,enabled:f,staleTime:3e5},e[13]=P,e[14]=o,e[15]=f,e[16]=r):r=e[16];const{data:h}=ne(r),g=!!h,u=h?.role||null,w=y?.id;let M;e[17]!==w?(M=["posts","community",w],e[17]=w,e[18]=M):M=e[18];let $;e[19]!==y?($=J=>{const{pageParam:v}=J;return he(y.id,v,10)},e[19]=y,e[20]=$):$=e[20];const R=!!y?.id;let F;e[21]!==M||e[22]!==$||e[23]!==R?(F={queryKey:M,queryFn:$,enabled:R,initialPageParam:null,getNextPageParam:Mt},e[21]=M,e[22]=$,e[23]=R,e[24]=F):F=e[24];const{data:D,fetchNextPage:k,hasNextPage:Q,isFetchingNextPage:q,isLoading:N}=Z(F);let T;e[25]!==D?.pages?(T=D?.pages.flatMap(bt)||[],e[25]=D?.pages,e[26]=T):T=e[26];const A=T;let O;e[27]!==y||e[28]!==t?(O=()=>Ae(y.id,t.id),e[27]=y,e[28]=t,e[29]=O):O=e[29];let j;e[30]!==y||e[31]!==t||e[32]!==i||e[33]!==l?(j=async()=>{const J=y.id,v=t.id;await l.cancelQueries({queryKey:["community",J,"membership",v]}),await l.cancelQueries({queryKey:["community",i]});const V=l.getQueryData(["community",J,"membership",v]),oe=l.getQueryData(["community",i]);return l.setQueryData(["community",J,"membership",v],V?null:{role:"member"}),l.setQueryData(["community",i],W=>W&&{...W,membersCount:V?W.membersCount-1:W.membersCount+1}),{previousMembership:V,previousCommunity:oe}},e[30]=y,e[31]=t,e[32]=i,e[33]=l,e[34]=j):j=e[34];let B;e[35]!==a||e[36]!==y||e[37]!==t||e[38]!==i||e[39]!==l?(B=(J,v,V)=>{V?.previousMembership!==void 0&&l.setQueryData(["community",y.id,"membership",t.id],V.previousMembership),V?.previousCommunity&&l.setQueryData(["community",i],V.previousCommunity),a("Failed to update membership","error")},e[35]=a,e[36]=y,e[37]=t,e[38]=i,e[39]=l,e[40]=B):B=e[40];let G;e[41]!==y?.id||e[42]!==t?.id||e[43]!==i||e[44]!==l?(G=()=>{l.invalidateQueries({queryKey:["community",y?.id,"membership",t?.id]}),l.invalidateQueries({queryKey:["community",i]})},e[41]=y?.id,e[42]=t?.id,e[43]=i,e[44]=l,e[45]=G):G=e[45];let H;e[46]!==a||e[47]!==y?(H=J=>{y&&a(J?`Joined ${y.name}`:`Left ${y.name}`)},e[46]=a,e[47]=y,e[48]=H):H=e[48];let z;e[49]!==O||e[50]!==j||e[51]!==B||e[52]!==G||e[53]!==H?(z={mutationFn:O,onMutate:j,onError:B,onSettled:G,onSuccess:H},e[49]=O,e[50]=j,e[51]=B,e[52]=G,e[53]=H,e[54]=z):z=e[54];const x=te(z);let K;e[55]!==a||e[56]!==t||e[57]!==x?(K=async()=>{if(!t)return a("Please login to join communities","error");x.mutate()},e[55]=a,e[56]=t,e[57]=x,e[58]=K):K=e[58];const L=K;let C;return e[59]!==a||e[60]!==y||e[61]!==A||e[62]!==t||e[63]!==k||e[64]!==L||e[65]!==Q||e[66]!==q||e[67]!==g||e[68]!==x.isPending||e[69]!==c||e[70]!==N||e[71]!==s||e[72]!==S||e[73]!==u?(C={community:y,loading:c,isMember:g,userRole:u,isJoining:x.isPending,communityPosts:A,loadingPosts:N,isFetchingMorePosts:q,hasMorePosts:Q,handleJoinToggle:L,loadCommunityPosts:k,refetchCommunity:S,currentUser:t,addToast:a,navigate:s},e[59]=a,e[60]=y,e[61]=A,e[62]=t,e[63]=k,e[64]=L,e[65]=Q,e[66]=q,e[67]=g,e[68]=x.isPending,e[69]=c,e[70]=N,e[71]=s,e[72]=S,e[73]=u,e[74]=C):C=e[74],C};function Mt(e){if(!(!e||e.length<10))return e[e.length-1].sort_timestamp}function bt(e){return e}var St=X();const as=()=>{const e=(0,St.c)(48),{currentUser:i}=I(),s=se(),[t,a]=me();let l;e[0]!==t?(l=t.get("q")||"",e[0]=t,e[1]=l):l=e[1];const n=l;let _;e[2]!==t||e[3]!==n?(_=t.get("tab")||(n?"posts":"communities"),e[2]=t,e[3]=n,e[4]=_):_=e[4];const d=_,[m,y]=(0,E.useState)(!1);let c;e[5]===Symbol.for("react.memo_cache_sentinel")?(c=["explore","communities"],e[5]=c):c=e[5];let S;e[6]===Symbol.for("react.memo_cache_sentinel")?(S={queryKey:c,queryFn:vt,initialPageParam:null,getNextPageParam:$t},e[6]=S):S=e[6];const{data:b,fetchNextPage:p,hasNextPage:P,isFetchingNextPage:o,isLoading:f}=Z(S);let r;e[7]!==b?.pages?(r=b?.pages.flatMap(Rt)||[],e[7]=b?.pages,e[8]=r):r=e[8];const h=r;let g,u;e[9]!==n?(g=["explore","posts",n],u=z=>{const{pageParam:x}=z;return n?ge(n,x,20,!0):Me(x,20)},e[9]=n,e[10]=g,e[11]=u):(g=e[10],u=e[11]);let w;e[12]!==g||e[13]!==u?(w={queryKey:g,queryFn:u,initialPageParam:null,getNextPageParam:qt},e[12]=g,e[13]=u,e[14]=w):w=e[14];const{data:M,fetchNextPage:$,hasNextPage:R,isFetchingNextPage:F,isLoading:D}=Z(w);let k;e[15]!==M?.pages?(k=M?.pages.flatMap(Tt)||[],e[15]=M?.pages,e[16]=k):k=e[16];const Q=k;let q=h;if(n){let z;if(e[17]!==q||e[18]!==n){let x;e[20]!==n?(x=K=>K.name?.toLowerCase().includes(n.toLowerCase())||K.handle?.toLowerCase().includes(n.toLowerCase()),e[20]=n,e[21]=x):x=e[21],z=q.filter(x),e[17]=q,e[18]=n,e[19]=z}else z=e[19];q=z}const N=q;let T;e[22]!==s?(T=z=>{s(`/c/${z}`)},e[22]=s,e[23]=T):T=e[23];const A=T;let O;e[24]!==a?(O=z=>{a(x=>(z?x.set("q",z):x.delete("q"),x),{replace:!0})},e[24]=a,e[25]=O):O=e[25];const j=O;let B;e[26]!==a?(B=z=>{a(x=>(x.set("tab",z),x),{replace:!0})},e[26]=a,e[27]=B):B=e[27];const G=B;let H;return e[28]!==d||e[29]!==h||e[30]!==i||e[31]!==p||e[32]!==$||e[33]!==N||e[34]!==A||e[35]!==j||e[36]!==G||e[37]!==P||e[38]!==R||e[39]!==f||e[40]!==m||e[41]!==o||e[42]!==F||e[43]!==D||e[44]!==s||e[45]!==Q||e[46]!==n?(H={currentUser:i,searchQuery:n,setSearchQuery:j,activeTab:d,setActiveTab:G,isCreateModalOpen:m,setIsCreateModalOpen:y,communitiesData:h,isCommunitiesLoading:f,isFetchingMoreCommunities:o,hasMoreCommunities:P,postsData:Q,isPostsLoading:D,isFetchingMorePosts:F,hasMorePosts:R,filteredCommunities:N,handleCommunityClick:A,loadCommunities:p,loadPosts:$,navigate:s},e[28]=d,e[29]=h,e[30]=i,e[31]=p,e[32]=$,e[33]=N,e[34]=A,e[35]=j,e[36]=G,e[37]=P,e[38]=R,e[39]=f,e[40]=m,e[41]=o,e[42]=F,e[43]=D,e[44]=s,e[45]=Q,e[46]=n,e[47]=H):H=e[47],H};function vt(e){const{pageParam:i}=e;return qe(i,10)}function $t(e){if(!(!e||e.length<10))return e[e.length-1].createdAt}function Rt(e){return e}function qt(e){if(!(!e||e.length<20))return e[e.length-1].sort_timestamp}function Tt(e){return e}var Ft=X();const os=()=>{const e=(0,Ft.c)(21),{currentUser:i}=I(),{posts:s,loading:t,hasMore:a,isFetchingNextPage:l,fetchNextPage:n,refreshPosts:_}=He(),{addToast:d}=ae(),m=se();let y;e[0]===Symbol.for("react.memo_cache_sentinel")?(y=["stories"],e[0]=y):y=e[0];let c;e[1]===Symbol.for("react.memo_cache_sentinel")?(c={queryKey:y,queryFn:Dt,initialPageParam:null,getNextPageParam:Lt,refetchInterval:6e4},e[1]=c):c=e[1];const{data:S,isLoading:b}=Z(c);let p;if(e[2]!==S?.pages){const u=S?.pages.flatMap(kt)||[],w=JSON.parse(localStorage.getItem("seenStories")||"[]");p=u.reduce(Qt,[]).map(M=>({...M,isSeen:w.includes(M.user.id)})),e[2]=S?.pages,e[3]=p}else p=e[3];const P=p;let o;e[4]!==m?(o=u=>{m(`/p/${u}`)},e[4]=m,e[5]=o):o=e[5];const f=o;let r;e[6]!==m?(r=u=>{m(`/u/${u}`)},e[6]=m,e[7]=r):r=e[7];const h=r;let g;return e[8]!==d||e[9]!==i||e[10]!==n||e[11]!==P||e[12]!==f||e[13]!==h||e[14]!==a||e[15]!==s||e[16]!==l||e[17]!==t||e[18]!==b||e[19]!==_?(g={currentUser:i,homePosts:s,groupedStories:P,isPostsLoading:t,isStoriesLoading:b,hasMore:a,isFetchingNextPage:l,fetchNextPage:n,refreshPosts:_,addToast:d,handlePostClick:f,handleUserClick:h},e[8]=d,e[9]=i,e[10]=n,e[11]=P,e[12]=f,e[13]=h,e[14]=a,e[15]=s,e[16]=l,e[17]=t,e[18]=b,e[19]=_,e[20]=g):g=e[20],g};function Dt(e){const{pageParam:i}=e;return Ee(i,10)}function Lt(e){if(!(!e||e.length<10))return e[e.length-1].created_at}function kt(e){return e}function Qt(e,i){const s=e.find(t=>t.user.id===i.user_id);return s?s.stories.push(i):e.push({user:i.user,stories:[i],isSeen:!1}),e}var Nt=X();const rs=()=>{const e=(0,Nt.c)(62),{id:i}=re(),s=se(),{currentUser:t}=I(),{onlineUsers:a}=Ge(),l=ie(),[n,_]=(0,E.useState)("");let d;e[0]===Symbol.for("react.memo_cache_sentinel")?(d=[],e[0]=d):d=e[0];const[m,y]=(0,E.useState)(d),{conversations:c,isConvLoading:S,refetchConversations:b,refetchMessages:p,sendMessage:P,editMessage:o,sendTypingStatus:f,typingStatus:r,markAsRead:h,formatMessages:g,onDeleteMessage:u,onToggleReaction:w,conversationReactions:M,messages:$,isMsgLoading:R,fetchNextMessages:F,hasMoreMessages:D,isFetchingMoreMessages:k}=it(t,i);let Q;e:{if(!i||c.length===0){Q=null;break e}let W;e[1]!==c||e[2]!==i?(W=c.find(Y=>Y.id===i)||null,e[1]=c,e[2]=i,e[3]=W):W=e[3],Q=W}const q=Q;let N,T;e[4]!==i||e[5]!==h?(N=()=>{i&&h(i)},T=[i,h],e[4]=i,e[5]=h,e[6]=N,e[7]=T):(N=e[6],T=e[7]),(0,E.useEffect)(N,T);let A;e[8]!==c||e[9]!==t?.id||e[10]!==n?(A=()=>{const W=setTimeout(async()=>{if(n.length>1){const Y=await Oe(n),ce=c.map(xt);y(Y.filter(ue=>ue.id!==t?.id&&!ce.includes(ue.id)))}else y([])},300);return()=>clearTimeout(W)},e[8]=c,e[9]=t?.id,e[10]=n,e[11]=A):A=e[11];const O=t?.id;let j;e[12]!==c||e[13]!==n||e[14]!==O?(j=[n,c,O],e[12]=c,e[13]=n,e[14]=O,e[15]=j):j=e[15],(0,E.useEffect)(A,j);let B;e[16]!==t||e[17]!==s||e[18]!==l?(B=async W=>{if(t)try{const Y=await We(t.id,W.id);l.invalidateQueries({queryKey:["conversations",t.id]}),_(""),s(`/m/${Y}`)}catch(Y){console.error("Failed to start conversation:",Y)}},e[16]=t,e[17]=s,e[18]=l,e[19]=B):B=e[19];const G=B;let H;e[20]!==s?(H=W=>{s(`/m/${W.id}`)},e[20]=s,e[21]=H):H=e[21];const z=H;let x;e[22]!==M||e[23]!==g||e[24]!==$?(x=g($,M),e[22]=M,e[23]=g,e[24]=$,e[25]=x):x=e[25];const K=x;let L;if(e[26]!==c||e[27]!==n){let W;e[29]!==n?(W=Y=>Y.user?.name?.toLowerCase().includes(n.toLowerCase())||Y.user?.handle?.toLowerCase().includes(n.toLowerCase())||Y.lastMessage?.toLowerCase().includes(n.toLowerCase()),e[29]=n,e[30]=W):W=e[30],L=c.filter(W),e[26]=c,e[27]=n,e[28]=L}else L=e[28];const C=L,J=q&&r[q.id];let v;e[31]!==a||e[32]!==q?(v=q&&q.user?.id&&a.has(q.user.id),e[31]=a,e[32]=q,e[33]=v):v=e[33];const V=v;let oe;return e[34]!==c||e[35]!==J||e[36]!==t||e[37]!==o||e[38]!==F||e[39]!==C||e[40]!==z||e[41]!==G||e[42]!==D||e[43]!==i||e[44]!==S||e[45]!==k||e[46]!==R||e[47]!==K||e[48]!==n||e[49]!==s||e[50]!==u||e[51]!==w||e[52]!==a||e[53]!==V||e[54]!==b||e[55]!==p||e[56]!==q||e[57]!==P||e[58]!==f||e[59]!==r||e[60]!==m?(oe={id:i,currentUser:t,onlineUsers:a,msgSearchQuery:n,setMsgSearchQuery:_,userSearchResults:m,conversations:c,filteredConversations:C,selectedConversation:q,localMessages:K,isConvLoading:S,isMsgLoading:R,currentIsTyping:J,otherUserIsOnline:V,handleStartConversation:G,handleSelectConversation:z,refetchConversations:b,refetchMessages:p,sendMessage:P,editMessage:o,onDeleteMessage:u,sendTypingStatus:f,typingStatus:r,onToggleReaction:w,navigate:s,fetchNextMessages:F,hasMoreMessages:D,isFetchingMoreMessages:k},e[34]=c,e[35]=J,e[36]=t,e[37]=o,e[38]=F,e[39]=C,e[40]=z,e[41]=G,e[42]=D,e[43]=i,e[44]=S,e[45]=k,e[46]=R,e[47]=K,e[48]=n,e[49]=s,e[50]=u,e[51]=w,e[52]=a,e[53]=V,e[54]=b,e[55]=p,e[56]=q,e[57]=P,e[58]=f,e[59]=r,e[60]=m,e[61]=oe):oe=e[61],oe};function xt(e){return e.user?.id}var Kt=X();const ls=()=>{const e=(0,Kt.c)(48),{currentUser:i}=I(),s=se(),t=ie(),a=i?.id;let l;e[0]!==a?(l=["notifications",a],e[0]=a,e[1]=l):l=e[1];let n;e[2]!==i?(n=T=>{const{pageParam:A}=T;return Se(i.id,A,10)},e[2]=i,e[3]=n):n=e[3];const _=!!i?.id;let d;e[4]!==l||e[5]!==n||e[6]!==_?(d={queryKey:l,queryFn:n,enabled:_,initialPageParam:null,getNextPageParam:Ct},e[4]=l,e[5]=n,e[6]=_,e[7]=d):d=e[7];const{data:m,fetchNextPage:y,hasNextPage:c,isFetchingNextPage:S,isLoading:b,refetch:p}=Z(d);let P;e[8]!==m?.pages?(P=m?.pages.flatMap(Et)||[],e[8]=m?.pages,e[9]=P):P=e[9];const o=P;let f;e[10]!==i||e[11]!==t?(f=()=>{if(!i?.id)return;const T=i.id,A=ee.channel(`user_notifications:${T}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`recipient_id=eq.${T}`},()=>{t.invalidateQueries({queryKey:["notifications",T]})}).subscribe();return()=>{ee.removeChannel(A)}},e[10]=i,e[11]=t,e[12]=f):f=e[12];const r=i?.id;let h;e[13]!==t||e[14]!==r?(h=[r,t],e[13]=t,e[14]=r,e[15]=h):h=e[15],(0,E.useEffect)(f,h);let g;e[16]!==i?(g=()=>i?ve(i.id):Promise.resolve(),e[16]=i,e[17]=g):g=e[17];let u,w,M;e[18]!==i?.id||e[19]!==t?(u=async()=>{const T=i?.id;await t.cancelQueries({queryKey:["notifications",T]});const A=t.getQueryData(["notifications",T]);return t.setQueryData(["notifications",T],Bt),{previousNotifications:A}},w=(T,A,O)=>{O?.previousNotifications&&t.setQueryData(["notifications",i?.id],O.previousNotifications)},M=()=>{t.invalidateQueries({queryKey:["notifications",i?.id]})},e[18]=i?.id,e[19]=t,e[20]=u,e[21]=w,e[22]=M):(u=e[20],w=e[21],M=e[22]);let $;e[23]!==u||e[24]!==w||e[25]!==M||e[26]!==g?($={mutationFn:g,onMutate:u,onError:w,onSettled:M},e[23]=u,e[24]=w,e[25]=M,e[26]=g,e[27]=$):$=e[27];const R=te($);let F;e[28]!==s?(F=T=>{T.type==="follow"?s(`/u/${T.user}`):T.post_id&&s(`/p/${T.post_id}`)},e[28]=s,e[29]=F):F=e[29];const D=F;let k;e[30]!==i?.id||e[31]!==R||e[32]!==o?(k=()=>{i?.id&&o.some(jt)&&R.mutate()},e[30]=i?.id,e[31]=R,e[32]=o,e[33]=k):k=e[33];const Q=i?.id;let q;e[34]!==R||e[35]!==o||e[36]!==Q?(q=[Q,o,R],e[34]=R,e[35]=o,e[36]=Q,e[37]=q):q=e[37],(0,E.useEffect)(k,q);let N;return e[38]!==i||e[39]!==y||e[40]!==D||e[41]!==c||e[42]!==S||e[43]!==b||e[44]!==s||e[45]!==o||e[46]!==p?(N={currentUser:i,notifications:o,isLoading:b,isFetchingMore:S,hasMore:c,loadNotifications:y,refreshNotifications:p,handleNotificationClick:D,navigate:s},e[38]=i,e[39]=y,e[40]=D,e[41]=c,e[42]=S,e[43]=b,e[44]=s,e[45]=o,e[46]=p,e[47]=N):N=e[47],N};function Ct(e){if(!(!e||e.length<10))return e[e.length-1].created_at}function Et(e){return e}function At(e){return{...e,is_read:!0}}function Ot(e){return e.map(At)}function Bt(e){return e&&{...e,pages:e.pages.map(Ot)}}function jt(e){return!e.is_read}var Jt=X();const cs=()=>{const e=(0,Jt.c)(23),{id:i}=re(),s=se(),{currentUser:t}=I(),{addToast:a}=ae(),l=ie();let n,_;e[0]!==i?(n=["post",i],_=async()=>{if(!i||!U(i))throw new Error("Invalid post ID");return ke(i)},e[0]=i,e[1]=n,e[2]=_):(n=e[1],_=e[2]);const d=!!i;let m;e[3]!==n||e[4]!==_||e[5]!==d?(m={queryKey:n,queryFn:_,enabled:d,retry:!1},e[3]=n,e[4]=_,e[5]=d,e[6]=m):m=e[6];const{data:y,isLoading:c,isError:S}=ne(m);let b;e[7]!==s?(b=g=>{s(`/u/${g}`)},e[7]=s,e[8]=b):b=e[8];const p=b;let P;e[9]!==s?(P=()=>{s(-1)},e[9]=s,e[10]=P):P=e[10];const o=P;let f;e[11]!==l?(f=(g,u,w)=>{l.setQueryData(["post",g],M=>M&&{...M,content:u,media:w})},e[11]=l,e[12]=f):f=e[12];const r=f;let h;return e[13]!==a||e[14]!==t||e[15]!==o||e[16]!==r||e[17]!==p||e[18]!==S||e[19]!==c||e[20]!==s||e[21]!==y?(h={post:y,isLoading:c,isError:S,currentUser:t,addToast:a,navigate:s,handleUserClick:p,handleDelete:o,handleUpdate:r},e[13]=a,e[14]=t,e[15]=o,e[16]=r,e[17]=p,e[18]=S,e[19]=c,e[20]=s,e[21]=y,e[22]=h):h=e[22],h};var zt=X();const us=()=>{const e=(0,zt.c)(44),i=se(),{id:s}=re(),[t]=me();let a;e[0]!==s||e[1]!==t?(a=s||t.get("id"),e[0]=s,e[1]=t,e[2]=a):a=e[2];const l=a,n=(0,E.useRef)(null);let _;e[3]===Symbol.for("react.memo_cache_sentinel")?(_=new Map,e[3]=_):_=e[3];const d=(0,E.useRef)(_),[m,y]=(0,E.useState)(null),[c,S]=(0,E.useState)(!0);let b;e[4]===Symbol.for("react.memo_cache_sentinel")?(b=["reels"],e[4]=b):b=e[4];let p;e[5]===Symbol.for("react.memo_cache_sentinel")?(p={queryKey:b,queryFn:Ht,initialPageParam:null,getNextPageParam:Vt},e[5]=p):p=e[5];const{data:P,fetchNextPage:o,hasNextPage:f,isFetchingNextPage:r,isLoading:h}=Z(p);let g;e[6]!==P?.pages?(g=P?.pages.flatMap(Gt)||[],e[6]=P?.pages,e[7]=g):g=e[7];const u=g,[w,M]=(0,E.useState)(0);u.length>0&&u.length!==w&&!m&&(M(u.length),l&&u.find(K=>K.id===l)?y(l):y(u[0].id));let $,R;e[8]!==u.length||e[9]!==l?($=()=>{if(u.length>0&&l){const K=d.current.get(l);K&&K.scrollIntoView({behavior:"instant"})}},R=[u.length,l],e[8]=u.length,e[9]=l,e[10]=$,e[11]=R):($=e[10],R=e[11]),(0,E.useEffect)($,R);let F;e[12]===Symbol.for("react.memo_cache_sentinel")?(F=()=>{S(Wt)},e[12]=F):F=e[12];const D=F;let k;e[13]!==m||e[14]!==u?(k=()=>{if(u.length===0)return;const K=u.findIndex(L=>L.id===m);if(K<u.length-1){const L=u[K+1];d.current.get(L.id)?.scrollIntoView({behavior:"smooth"})}},e[13]=m,e[14]=u,e[15]=k):k=e[15];const Q=k;let q;e[16]!==m||e[17]!==u?(q=()=>{if(u.length===0)return;const K=u.findIndex(L=>L.id===m);if(K>0){const L=u[K-1];d.current.get(L.id)?.scrollIntoView({behavior:"smooth"})}},e[16]=m,e[17]=u,e[18]=q):q=e[18];const N=q;let T,A;e[19]!==u.length?(T=()=>{if(u.length===0)return;const K={root:n.current,threshold:.6},L=J=>{J.forEach(v=>{if(v.isIntersecting){const V=v.target.getAttribute("data-id");V&&y(V)}})},C=new IntersectionObserver(L,K);return d.current.forEach(J=>C.observe(J)),()=>C.disconnect()},A=[u.length],e[19]=u.length,e[20]=T,e[21]=A):(T=e[20],A=e[21]),(0,E.useEffect)(T,A);let O,j;e[22]!==m||e[23]!==Q||e[24]!==N?(O=()=>{const K=L=>{const C=L.target;if(!(C.tagName==="INPUT"||C.tagName==="TEXTAREA"||C.isContentEditable)&&!(L.ctrlKey||L.altKey||L.metaKey))e:switch(L.key){case"ArrowUp":L.preventDefault(),N();break e;case"ArrowDown":L.preventDefault(),Q();break e;case"m":case"M":D();break e;case" ":{L.preventDefault();const J=d.current.get(m||"");if(J){const v=J.querySelector(".reel-item");v&&v.click()}}}};return window.addEventListener("keydown",K),()=>window.removeEventListener("keydown",K)},j=[m,Q,N,D],e[22]=m,e[23]=Q,e[24]=N,e[25]=O,e[26]=j):(O=e[25],j=e[26]),(0,E.useEffect)(O,j);let B;e[27]===Symbol.for("react.memo_cache_sentinel")?(B=(K,L)=>{L?d.current.set(K,L):d.current.delete(K)},e[27]=B):B=e[27];const G=B;let H,z;e[28]!==o||e[29]!==f||e[30]!==r?(H=()=>{const K=()=>{if(!n.current||r||!f)return;const{scrollTop:C,scrollHeight:J,clientHeight:v}=n.current;C+v>=J-800&&o()},L=n.current;if(L)return L.addEventListener("scroll",K),()=>L.removeEventListener("scroll",K)},z=[r,f,o],e[28]=o,e[29]=f,e[30]=r,e[31]=H,e[32]=z):(H=e[31],z=e[32]),(0,E.useEffect)(H,z);let x;return e[33]!==m||e[34]!==o||e[35]!==f||e[36]!==r||e[37]!==h||e[38]!==c||e[39]!==i||e[40]!==u||e[41]!==Q||e[42]!==N?(x={reels:u,loading:h,loadingMore:r,activeReelId:m,hasMore:f,isMuted:c,containerRef:n,setReelRef:G,navigate:i,toggleMute:D,scrollToNext:Q,scrollToPrev:N,loadReels:o},e[33]=m,e[34]=o,e[35]=f,e[36]=r,e[37]=h,e[38]=c,e[39]=i,e[40]=u,e[41]=Q,e[42]=N,e[43]=x):x=e[43],x};function Ht(e){const{pageParam:i}=e;return Qe(i,10)}function Vt(e){if(!(!e||e.length<10))return e[e.length-1].sort_timestamp||e[e.length-1].created_at}function Gt(e){return e}function Wt(e){return!e}const ms=()=>{const{currentUser:e,logout:i}=I(),{darkMode:s,toggleDarkMode:t,fontSize:a,setFontSize:l,dataSaver:n,setDataSaver:_}=Ne(),{addToast:d}=ae(),[m,y]=(0,E.useState)(!1),[c,S]=(0,E.useState)({newPassword:"",confirmPassword:""}),[b,p]=(0,E.useState)(!1),P=async()=>{try{await i(),d("Logged out successfully")}catch(w){console.error("Logout error:",w),d("Failed to logout")}};return{currentUser:e,darkMode:s,toggleDarkMode:t,fontSize:a,setFontSize:l,dataSaver:n,setDataSaver:_,isChangingPassword:m,setIsChangingPassword:y,passwordData:c,setPasswordData:S,loading:b,handleLogout:P,handlePasswordChange:async w=>{if(w.preventDefault(),c.newPassword!==c.confirmPassword){d("Passwords do not match","error");return}if(c.newPassword.length<6){d("Password must be at least 6 characters","error");return}p(!0);try{const{error:M}=await ee.auth.updateUser({password:c.newPassword});if(M)throw M;d("Password updated successfully!"),y(!1),S({newPassword:"",confirmPassword:""})}catch(M){console.error("Password update error:",M),d(M.message||"Failed to update password","error")}finally{p(!1)}},handlePasswordReset:async()=>{if(e?.email){p(!0);try{const{error:w}=await ee.auth.resetPasswordForEmail(e.email,{redirectTo:`${window.location.origin}/settings?type=recovery`});if(w)throw w;d("Password reset email sent!")}catch(w){console.error("Reset password error:",w),d(w.message||"Failed to send reset email","error")}finally{p(!1)}}},handleClearCache:()=>{["seenStories","font-size","data-saver","theme"].forEach(w=>localStorage.removeItem(w)),d("Cache cleared! Reloading..."),setTimeout(()=>window.location.reload(),1500)},handleDownloadData:async()=>{if(e){p(!0);try{const w={user:{id:e.id,handle:e.handle,name:e.name,email:e.email},exportDate:new Date().toISOString(),note:"This is a mock export of your Sysm data."},M=new Blob([JSON.stringify(w,null,2)],{type:"application/json"}),$=URL.createObjectURL(M),R=document.createElement("a");R.href=$,R.download=`sysm-data-${e.handle}.json`,R.click(),URL.revokeObjectURL($),d("Data export started!")}catch{d("Failed to export data","error")}finally{p(!1)}}},handleDeleteAccount:()=>{window.confirm("Are you absolutely sure? This will permanently delete your account and all associated data. This action is irreversible.")&&(d("Account deletion request submitted. Logging out..."),setTimeout(P,2e3))},handleReportBug:()=>{window.prompt("Please describe the bug you found:")&&d("Bug reported! Thank you for your feedback.")}}};export{rs as a,ns as c,ts as d,es as f,ls as i,is as l,us as n,os as o,It as p,cs as r,as as s,ms as t,ss as u};
