import{a as ue}from"./rolldown-runtime-BaZ8gS7u.js";import{E as de,S as ce,b as U,c as W,x as ae}from"./framework-CsA6nn9m.js";import{a as ee,n as ne,r as se,t as Y}from"./query-QyXblnmD.js";import{$t as fe,At as me,Bt as ge,Ct as he,Dt as ye,Et as pe,Ft as Pe,Gt as ve,Ht as we,It as _e,Jt as be,Kt as Me,Lt as Se,Mt as Re,Nt as $e,Ot as qe,Pt as Ce,Rt as Fe,St as ke,Tt as Le,Ut as Ne,Wt as Te,Xt as xe,Yt as De,_t as ie,bt as te,en as Qe,gt as Ke,kt as Ee,ln as Z,nn as Ae,s as Oe,sn as oe,tn as Be,un as I,vt as je,wt as Je,yt as ze,zt as He}from"./index-1GGj2WM6.js";var Ve=W(),q=ue(de(),1);const Ge=(e,i,s)=>{const t=(0,Ve.c)(16);let o,a;t[0]!==i||t[1]!==e?(o=["follows",i,e],a=h=>{const{pageParam:g}=h;return(i==="Followers"?fe:Qe)(e,g,10)},t[0]=i,t[1]=e,t[2]=o,t[3]=a):(o=t[2],a=t[3]);const n=!!e&&s;let y;t[4]!==o||t[5]!==a||t[6]!==n?(y={queryKey:o,queryFn:a,initialPageParam:null,getNextPageParam:We,enabled:n},t[4]=o,t[5]=a,t[6]=n,t[7]=y):y=t[7];const{data:m,fetchNextPage:f,hasNextPage:u,isFetchingNextPage:l,isLoading:v}=Y(y);let w;t[8]!==m?.pages?(w=m?.pages.flatMap(Xe)||[],t[8]=m?.pages,t[9]=w):w=t[9];const p=w;let r;return t[10]!==f||t[11]!==p||t[12]!==u||t[13]!==l||t[14]!==v?(r={followList:p,fetchNextPage:f,hasNextPage:u,isFetchingNextPage:l,isLoading:v},t[10]=f,t[11]=p,t[12]=u,t[13]=l,t[14]=v,t[15]=r):r=t[15],r};function We(e){if(!(!e||e.length<10))return e[e.length-1].followed_at}function Xe(e){return e}const Ye=(e,i)=>{const s=ee(),{addToast:t}=ie(),o=(0,q.useCallback)((r=[],h=[])=>r.map(g=>({id:g.id,sender:g.sender_id===e?.id?"me":"them",senderAvatar:g.sender?.avatar,senderName:g.sender?.name,text:g.content,type:g.type||"text",media:g.media?Array.isArray(g.media)?g.media:[g.media]:[],isRead:g.is_read,replyToId:g.reply_to_id,reactions:h.filter(b=>b.message_id===g.id),time:new Date(g.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})),[e?.id]),{data:a,fetchNextPage:n,hasNextPage:y,isFetchingNextPage:m,isLoading:f,refetch:u}=Y({queryKey:["messages",i],queryFn:({pageParam:r})=>Re(i,r,20),initialPageParam:null,getNextPageParam:r=>{if(!(!r||r.length<20))return r[r.length-1].created_at},enabled:!!i,refetchOnWindowFocus:!1}),{data:l=[]}=se({queryKey:["reactions",i],queryFn:()=>$e(i),enabled:!!i,staleTime:1e3*60*5}),v=ne({mutationFn:({convId:r,text:h,type:g="text",media:b=[],replyToId:M=null})=>_e(r,e.id,h,g,b,M),onSuccess:r=>{r&&(s.invalidateQueries({queryKey:["messages",r.conversation_id]}),s.invalidateQueries({queryKey:["conversations",e.id]}))},onError:()=>{t("Failed to send message","error")}}),w=async(r,h)=>{if(e?.id)try{await Se(r,e.id,h),s.invalidateQueries({queryKey:["reactions",i]})}catch(g){console.error("Failed to toggle reaction:",g),t("Failed to update reaction","error")}},p=async r=>{try{await me(r),s.invalidateQueries({queryKey:["messages",i]}),s.invalidateQueries({queryKey:["conversations",e?.id]})}catch(h){console.error("Failed to delete message:",h),t("Failed to delete message","error")}};return{messages:(0,q.useMemo)(()=>[...a?.pages.flatMap(r=>r)||[]].reverse(),[a]),isMsgLoading:f,refetchMessages:u,fetchNextMessages:n,hasMoreMessages:y,isFetchingMoreMessages:m,sendMessage:(r,h,g,b,M)=>v.mutate({convId:r,text:h,type:g,media:b,replyToId:M}),isSending:v.isPending,onToggleReaction:w,onDeleteMessage:p,conversationReactions:l,formatMessages:o}},Ze=(e,i)=>{const s=ee(),[t,o]=(0,q.useState)({}),a=(0,q.useRef)(null),n=(0,q.useCallback)(async m=>{if(!(!e?.id||!m))try{await Pe(m,e.id),s.invalidateQueries({queryKey:["unread_messages_count",e.id]}),s.invalidateQueries({queryKey:["conversations",e.id]})}catch(f){console.error("Failed to mark as read:",f)}},[e?.id,s]);return(0,q.useEffect)(()=>{if(!e?.id)return;const m=I.channel(`messages_realtime:${i||"global"}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},u=>{const l=u.new;i&&l.conversation_id===i&&(s.invalidateQueries({queryKey:["messages",i]}),l.sender_id!==e.id&&n(i)),s.invalidateQueries({queryKey:["conversations",e.id]}),l.sender_id!==e.id&&s.invalidateQueries({queryKey:["unread_messages_count",e.id]}),o(v=>({...v,[l.conversation_id]:!1}))}).on("postgres_changes",{event:"DELETE",schema:"public",table:"messages"},()=>{s.invalidateQueries({queryKey:["messages"]}),s.invalidateQueries({queryKey:["conversations",e.id]})}).on("postgres_changes",{event:"*",schema:"public",table:"message_reactions"},()=>{i&&s.invalidateQueries({queryKey:["reactions",i]})}).subscribe(),f=I.channel("chat_typing_shared").on("broadcast",{event:"typing"},({payload:u})=>{const{conversationId:l,isTyping:v,userId:w}=u;w!==e.id&&o(p=>({...p,[l]:v}))}).subscribe();return a.current=f,()=>{I.removeChannel(m),I.removeChannel(f)}},[e?.id,s,i,n]),{typingStatus:t,sendTypingStatus:(m,f)=>{a.current&&e&&a.current.send({type:"broadcast",event:"typing",payload:{conversationId:m,isTyping:f,userId:e.id}})},markAsRead:n}};var Ie=W();const Ue=(e,i)=>{const s=(0,Ie.c)(20),{conversations:t,unreadCount:o,isConvLoading:a,refetchConversations:n}=Oe(e),{messages:y,isMsgLoading:m,refetchMessages:f,fetchNextMessages:u,hasMoreMessages:l,isFetchingMoreMessages:v,sendMessage:w,isSending:p,onToggleReaction:r,onDeleteMessage:h,conversationReactions:g,formatMessages:b}=Ye(e,i),{typingStatus:M,sendTypingStatus:c,markAsRead:d}=Ze(e,i);let P;return s[0]!==g||s[1]!==t||s[2]!==u||s[3]!==b||s[4]!==l||s[5]!==a||s[6]!==v||s[7]!==m||s[8]!==p||s[9]!==d||s[10]!==y||s[11]!==h||s[12]!==r||s[13]!==n||s[14]!==f||s[15]!==w||s[16]!==c||s[17]!==M||s[18]!==o?(P={conversations:t,unreadCount:o,isConvLoading:a,refetchConversations:n,refetchMessages:f,sendMessage:w,sendTypingStatus:c,typingStatus:M,markAsRead:d,formatMessages:b,onToggleReaction:r,onDeleteMessage:h,conversationReactions:g,isSending:p,messages:y,isMsgLoading:m,fetchNextMessages:u,hasMoreMessages:l,isFetchingMoreMessages:v},s[0]=g,s[1]=t,s[2]=u,s[3]=b,s[4]=l,s[5]=a,s[6]=v,s[7]=m,s[8]=p,s[9]=d,s[10]=y,s[11]=h,s[12]=r,s[13]=n,s[14]=f,s[15]=w,s[16]=c,s[17]=M,s[18]=o,s[19]=P):P=s[19],P};var et=W();const zt=(e,i,s)=>{const t=(0,et.c)(92),o=ee(),{addToast:a}=ie();let n;t[0]!==i?(n=i||{comments:0,likes:0,mirrors:0,reposts:0},t[0]=i,t[1]=n):n=t[1];const[y,m]=(0,q.useState)(n);let f,u;t[2]!==i?(f=()=>{i&&m(x=>({...x,...i}))},u=[i],t[2]=i,t[3]=f,t[4]=u):(f=t[3],u=t[4]),(0,q.useEffect)(f,u);const l=s?.id;let v;t[5]!==e||t[6]!==l?(v=["post",e,"liked",l],t[5]=e,t[6]=l,t[7]=v):v=t[7];let w;t[8]!==s?.id||t[9]!==e?(w=()=>He(e,s?.id),t[8]=s?.id,t[9]=e,t[10]=w):w=t[10];let p;t[11]!==s||t[12]!==e?(p=!!s&&Z(e)&&Z(s.id),t[11]=s,t[12]=e,t[13]=p):p=t[13];let r;t[14]!==v||t[15]!==w||t[16]!==p?(r={queryKey:v,queryFn:w,enabled:p,staleTime:6e5},t[14]=v,t[15]=w,t[16]=p,t[17]=r):r=t[17];const{data:h}=se(r),g=h===void 0?!1:h,b=s?.id;let M;t[18]!==e||t[19]!==b?(M=["post",e,"reposted",b],t[18]=e,t[19]=b,t[20]=M):M=t[20];let c;t[21]!==s?.id||t[22]!==e?(c=()=>ge(e,s?.id),t[21]=s?.id,t[22]=e,t[23]=c):c=t[23];let d;t[24]!==s||t[25]!==e?(d=!!s&&Z(e)&&Z(s.id),t[24]=s,t[25]=e,t[26]=d):d=t[26];let P;t[27]!==M||t[28]!==c||t[29]!==d?(P={queryKey:M,queryFn:c,enabled:d,staleTime:6e5},t[27]=M,t[28]=c,t[29]=d,t[30]=P):P=t[30];const{data:_}=se(P),S=_===void 0?!1:_;let R;t[31]!==s?.id||t[32]!==e?(R=()=>De(e,s?.id),t[31]=s?.id,t[32]=e,t[33]=R):R=t[33];let D;t[34]!==s?.id||t[35]!==e||t[36]!==o?(D=async()=>{await o.cancelQueries({queryKey:["post",e,"liked",s?.id]});const x=o.getQueryData(["post",e,"liked",s?.id]);return o.setQueryData(["post",e,"liked",s?.id],!x),m(J=>({...J,likes:x?(J.likes||0)-1:(J.likes||0)+1})),{previousLiked:x}},t[34]=s?.id,t[35]=e,t[36]=o,t[37]=D):D=t[37];let T;t[38]!==a||t[39]!==s?.id||t[40]!==e||t[41]!==o?(T=(x,J,$)=>{$?.previousLiked!==void 0&&(o.setQueryData(["post",e,"liked",s?.id],$.previousLiked),m(F=>({...F,likes:$.previousLiked?(F.likes||0)+1:(F.likes||0)-1}))),a("Failed to update like","error")},t[38]=a,t[39]=s?.id,t[40]=e,t[41]=o,t[42]=T):T=t[42];let k;t[43]!==s?.id||t[44]!==e||t[45]!==o?(k=()=>{o.invalidateQueries({queryKey:["post",e,"liked",s?.id]})},t[43]=s?.id,t[44]=e,t[45]=o,t[46]=k):k=t[46];let B;t[47]!==R||t[48]!==D||t[49]!==T||t[50]!==k?(B={mutationFn:R,onMutate:D,onError:T,onSettled:k},t[47]=R,t[48]=D,t[49]=T,t[50]=k,t[51]=B):B=t[51];const E=ne(B);let Q;t[52]!==s?.id||t[53]!==e?(Q=()=>xe(e,s?.id),t[52]=s?.id,t[53]=e,t[54]=Q):Q=t[54];let C;t[55]!==s?.id||t[56]!==e||t[57]!==o?(C=async()=>{await o.cancelQueries({queryKey:["post",e,"reposted",s?.id]});const x=o.getQueryData(["post",e,"reposted",s?.id]);return o.setQueryData(["post",e,"reposted",s?.id],!x),m(J=>({...J,reposts:x?(J.reposts||0)-1:(J.reposts||0)+1,mirrors:x?(J.mirrors||0)-1:(J.mirrors||0)+1})),{previousReposted:x}},t[55]=s?.id,t[56]=e,t[57]=o,t[58]=C):C=t[58];let A;t[59]!==a||t[60]!==s?.id||t[61]!==e||t[62]!==o?(A=(x,J,$)=>{$?.previousReposted!==void 0&&(o.setQueryData(["post",e,"reposted",s?.id],$.previousReposted),m(F=>({...F,reposts:$.previousReposted?(F.reposts||0)+1:(F.reposts||0)-1,mirrors:$.previousReposted?(F.mirrors||0)+1:(F.mirrors||0)-1}))),a("Failed to update repost","error")},t[59]=a,t[60]=s?.id,t[61]=e,t[62]=o,t[63]=A):A=t[63];let L;t[64]!==s?.id||t[65]!==e||t[66]!==o?(L=()=>{o.invalidateQueries({queryKey:["post",e,"reposted",s?.id]})},t[64]=s?.id,t[65]=e,t[66]=o,t[67]=L):L=t[67];let O;t[68]!==a?(O=x=>{a(x?"Reposted!":"Removed repost")},t[68]=a,t[69]=O):O=t[69];let K;t[70]!==Q||t[71]!==C||t[72]!==A||t[73]!==L||t[74]!==O?(K={mutationFn:Q,onMutate:C,onError:A,onSettled:L,onSuccess:O},t[70]=Q,t[71]=C,t[72]=A,t[73]=L,t[74]=O,t[75]=K):K=t[75];const H=ne(K);let z;t[76]!==a||t[77]!==s||t[78]!==E||t[79]!==e?(z=async x=>{if(x&&x.stopPropagation(),!s)return a("Please login to like!","error");!Z(e)||!Z(s.id)||E.mutate()},t[76]=a,t[77]=s,t[78]=E,t[79]=e,t[80]=z):z=t[80];const j=z;let N;t[81]!==a||t[82]!==s||t[83]!==e||t[84]!==H?(N=async x=>{if(x&&x.stopPropagation(),!s)return a("Please login to repost!","error");!Z(e)||!Z(s.id)||H.mutate()},t[81]=a,t[82]=s,t[83]=e,t[84]=H,t[85]=N):N=t[85];const V=N;let G;return t[86]!==j||t[87]!==V||t[88]!==g||t[89]!==S||t[90]!==y?(G={liked:g,reposted:S,localStats:y,setLocalStats:m,handleLike:j,handleRepost:V},t[86]=j,t[87]=V,t[88]=g,t[89]=S,t[90]=y,t[91]=G):G=t[91],G};var tt=W();const Ht=e=>{const i=(0,tt.c)(5);let s;i[0]!==e?(s=()=>oe(e),i[0]=e,i[1]=s):s=i[1];const[t,o]=(0,q.useState)(s);let a,n;return i[2]!==e?(a=()=>{if(!e)return;const y=setTimeout(()=>{o(oe(e))},0),m=setInterval(()=>{o(oe(e))},6e4);return()=>{clearTimeout(y),clearInterval(m)}},n=[e],i[2]=e,i[3]=a,i[4]=n):(a=i[3],n=i[4]),(0,q.useEffect)(a,n),t};var st=W();const Vt=()=>{const e=(0,st.c)(30),[i,s]=(0,q.useState)(!1),[t,o]=(0,q.useState)(!1),[a,n]=(0,q.useState)(0),[y,m]=(0,q.useState)(null),[f,u]=(0,q.useState)(null),l=(0,q.useRef)(null),v=(0,q.useRef)(null);let w;e[0]===Symbol.for("react.memo_cache_sentinel")?(w=[],e[0]=w):w=e[0];const p=(0,q.useRef)(w);let r,h;e[1]!==f?(r=()=>()=>{v.current&&clearInterval(v.current),l.current&&l.current.state!=="inactive"&&(l.current.stop(),l.current.stream.getTracks().forEach(it)),f&&URL.revokeObjectURL(f)},h=[f],e[1]=f,e[2]=r,e[3]=h):(r=e[2],h=e[3]),(0,q.useEffect)(r,h);let g;e[4]===Symbol.for("react.memo_cache_sentinel")?(g=()=>{v.current=window.setInterval(()=>{n(nt)},1e3)},e[4]=g):g=e[4];const b=g;let M;e[5]===Symbol.for("react.memo_cache_sentinel")?(M=()=>{v.current&&(clearInterval(v.current),v.current=null)},e[5]=M):M=e[5];const c=M;let d;e[6]===Symbol.for("react.memo_cache_sentinel")?(d=async()=>{try{const L=await navigator.mediaDevices.getUserMedia({audio:!0}),O=new MediaRecorder(L);l.current=O,p.current=[],O.ondataavailable=K=>{K.data.size>0&&p.current.push(K.data)},O.onstop=()=>{const K=new Blob(p.current,{type:"audio/webm;codecs=opus"}),H=URL.createObjectURL(K);m(K),u(H),L.getTracks().forEach(at)},O.start(),s(!0),o(!1),n(0),b()}catch(L){const O=L;throw console.error("Error accessing microphone:",O),O}},e[6]=d):d=e[6];const P=d;let _;e[7]!==i?(_=()=>{l.current&&i&&(l.current.stop(),s(!1),o(!1),c())},e[7]=i,e[8]=_):_=e[8];const S=_;let R;e[9]!==t||e[10]!==i?(R=()=>{l.current&&i&&!t&&(l.current.pause(),o(!0),c())},e[9]=t,e[10]=i,e[11]=R):R=e[11];const D=R;let T;e[12]!==t||e[13]!==i?(T=()=>{l.current&&i&&t&&(l.current.resume(),o(!1),b())},e[12]=t,e[13]=i,e[14]=T):T=e[14];const k=T;let B;e[15]!==i?(B=()=>{l.current&&i&&(l.current.stop(),l.current.onstop=null,s(!1),o(!1),c(),n(0),l.current.stream&&l.current.stream.getTracks().forEach(ot))},e[15]=i,e[16]=B):B=e[16];const E=B;let Q;e[17]!==f?(Q=()=>{f&&URL.revokeObjectURL(f),m(null),u(null),n(0)},e[17]=f,e[18]=Q):Q=e[18];const C=Q;let A;return e[19]!==y||e[20]!==f||e[21]!==E||e[22]!==C||e[23]!==t||e[24]!==i||e[25]!==D||e[26]!==a||e[27]!==k||e[28]!==S?(A={isRecording:i,isPaused:t,recordingTime:a,startRecording:P,stopRecording:S,pauseRecording:D,resumeRecording:k,cancelRecording:E,audioBlob:y,audioUrl:f,clearAudio:C},e[19]=y,e[20]=f,e[21]=E,e[22]=C,e[23]=t,e[24]=i,e[25]=D,e[26]=a,e[27]=k,e[28]=S,e[29]=A):A=e[29],A};function it(e){return e.stop()}function nt(e){return e+1}function at(e){return e.stop()}function ot(e){return e.stop()}var rt=W();const Gt=(e,i,s)=>{const t=(0,rt.c)(31),o=ee();let a,n;t[0]!==s||t[1]!==e?(a=["comments",e,s],n=_=>{const{pageParam:S}=_;return we(e,S,10,s)},t[0]=s,t[1]=e,t[2]=a,t[3]=n):(a=t[2],n=t[3]);let y;t[4]!==i?(y=i?{pages:[i],pageParams:[null]}:void 0,t[4]=i,t[5]=y):y=t[5];const m=!!e;let f;t[6]!==a||t[7]!==n||t[8]!==y||t[9]!==m?(f={queryKey:a,queryFn:n,initialPageParam:null,getNextPageParam:lt,initialData:y,enabled:m},t[6]=a,t[7]=n,t[8]=y,t[9]=m,t[10]=f):f=t[10];const{data:u,fetchNextPage:l,hasNextPage:v,isFetchingNextPage:w,isLoading:p,refetch:r}=Y(f);let h;t[11]!==u?.pages?(h=u?.pages.flatMap(ct)||[],t[11]=u?.pages,t[12]=h):h=t[12];const g=h;let b;t[13]!==e?(b=_=>{const{userId:S,content:R,media:D,replyToId:T}=_;return Fe(e,S,R,D,T)},t[13]=e,t[14]=b):b=t[14];let M;t[15]!==s||t[16]!==e||t[17]!==o?(M=()=>{o.invalidateQueries({queryKey:["comments",e]}),s&&o.invalidateQueries({queryKey:["comments",e,s]})},t[15]=s,t[16]=e,t[17]=o,t[18]=M):M=t[18];let c;t[19]!==b||t[20]!==M?(c={mutationFn:b,onSuccess:M},t[19]=b,t[20]=M,t[21]=c):c=t[21];const d=ne(c);let P;return t[22]!==d.isPending||t[23]!==d.mutateAsync||t[24]!==g||t[25]!==l||t[26]!==v||t[27]!==w||t[28]!==p||t[29]!==r?(P={comments:g,fetchNextPage:l,hasNextPage:v,isFetchingNextPage:w,isLoading:p,refetch:r,addComment:d.mutateAsync,isSubmitting:d.isPending},t[22]=d.isPending,t[23]=d.mutateAsync,t[24]=g,t[25]=l,t[26]=v,t[27]=w,t[28]=p,t[29]=r,t[30]=P):P=t[30],P};function lt(e){if(!(!e||e.length<10))return e[e.length-1].created_at}function ct(e){return e}var ut=W();const Wt=()=>{const e=(0,ut.c)(53),{handle:i}=ae(),s=U(),{currentUser:t}=te(),{addToast:o}=ie();let a,n;e[0]!==i?(a=["profile",i],n=()=>Be(i),e[0]=i,e[1]=a,e[2]=n):(a=e[1],n=e[2]);const y=!!i;let m;e[3]!==a||e[4]!==n||e[5]!==y?(m={queryKey:a,queryFn:n,enabled:y,staleTime:3e5},e[3]=a,e[4]=n,e[5]=y,e[6]=m):m=e[6];const{data:f,isLoading:u}=se(m),[l,v]=(0,q.useState)("feed"),w=f?.id;let p;e[7]!==w?(p=["posts","user",w],e[7]=w,e[8]=p):p=e[8];let r;e[9]!==f?.id?(r=$=>{const{pageParam:F}=$;return ve(f?.id,F,10)},e[9]=f?.id,e[10]=r):r=e[10];const h=!!f?.id;let g;e[11]!==p||e[12]!==r||e[13]!==h?(g={queryKey:p,queryFn:r,enabled:h,initialPageParam:null,getNextPageParam:dt},e[11]=p,e[12]=r,e[13]=h,e[14]=g):g=e[14];const{data:b,fetchNextPage:M,hasNextPage:c,isFetchingNextPage:d,isLoading:P}=Y(g);let _;e[15]!==b?.pages?(_=b?.pages.flatMap(ft)||[],e[15]=b?.pages,e[16]=_):_=e[16];const S=_,[R,D]=(0,q.useState)(!1),[T,k]=(0,q.useState)("Followers"),{followList:B,fetchNextPage:E,hasNextPage:Q,isFetchingNextPage:C,isLoading:A}=Ge(f?.id,T,R);let L;e[17]===Symbol.for("react.memo_cache_sentinel")?(L=$=>{k($),D(!0)},e[17]=L):L=e[17];const O=L;let K;e:{if(l==="feed"){let $;e[18]!==S?($=S.filter(mt),e[18]=S,e[19]=$):$=e[19],K=$;break e}if(l==="media"){let $;e[20]!==S?($=S.filter(gt),e[20]=S,e[21]=$):$=e[21],K=$;break e}if(l==="collections"){let $;e[22]===Symbol.for("react.memo_cache_sentinel")?($=[],e[22]=$):$=e[22],K=$;break e}K=S}const H=K;let z;e[23]!==s?(z=$=>{s(`/post/${$}`)},e[23]=s,e[24]=z):z=e[24];const j=z;let N;e[25]!==i||e[26]!==s?(N=$=>{$!==i&&s(`/u/${$}`)},e[25]=i,e[26]=s,e[27]=N):N=e[27];const V=N;let G;e[28]!==M?(G=$=>{M()},e[28]=M,e[29]=G):G=e[29];const x=G;let J;return e[30]!==l||e[31]!==o||e[32]!==t||e[33]!==E||e[34]!==H||e[35]!==B||e[36]!==T||e[37]!==i||e[38]!==j||e[39]!==V||e[40]!==Q||e[41]!==c||e[42]!==C||e[43]!==d||e[44]!==R||e[45]!==A||e[46]!==x||e[47]!==P||e[48]!==u||e[49]!==s||e[50]!==f||e[51]!==S?(J={handle:i,profile:f,loading:u,userPosts:S,setUserPosts:ht,activeProfileTab:l,setActiveProfileTab:v,loadingPosts:P,isFetchingMorePosts:d,hasMorePosts:c,filteredPosts:H,isFollowModalOpen:R,setIsFollowModalOpen:D,followModalType:T,followListData:B,isListLoading:A,isFetchingMoreFollows:C,hasMoreFollows:Q,openFollowModal:O,fetchNextFollows:E,handlePostClick:j,handleUserClick:V,loadUserPosts:x,currentUser:t,addToast:o,navigate:s},e[30]=l,e[31]=o,e[32]=t,e[33]=E,e[34]=H,e[35]=B,e[36]=T,e[37]=i,e[38]=j,e[39]=V,e[40]=Q,e[41]=c,e[42]=C,e[43]=d,e[44]=R,e[45]=A,e[46]=x,e[47]=P,e[48]=u,e[49]=s,e[50]=f,e[51]=S,e[52]=J):J=e[52],J};function dt(e){if(!(!e||e.length<10))return e[e.length-1].sort_timestamp||e[e.length-1].created_at}function ft(e){return e}function mt(e){return e.community_id===null&&e.parent_id===null}function gt(e){return e.community_id===null&&e.parent_id===null&&(e.type==="video"||e.type==="image"||e.media&&e.media.length>0)}function ht(){return console.warn("setUserPosts is deprecated")}var yt=W();const Xt=()=>{const e=(0,yt.c)(75),{handle:i}=ae(),s=U(),{currentUser:t}=te(),{addToast:o}=ie(),a=ee();let n,y;e[0]!==i?(n=["community",i],y=()=>Je(i),e[0]=i,e[1]=n,e[2]=y):(n=e[1],y=e[2]);const m=!!i;let f;e[3]!==n||e[4]!==y||e[5]!==m?(f={queryKey:n,queryFn:y,enabled:m,staleTime:6e5},e[3]=n,e[4]=y,e[5]=m,e[6]=f):f=e[6];const{data:u,isLoading:l,refetch:v}=se(f),w=u?.id,p=t?.id;let r;e[7]!==w||e[8]!==p?(r=["community",w,"membership",p],e[7]=w,e[8]=p,e[9]=r):r=e[9];let h;e[10]!==u?.id||e[11]!==t?.id?(h=()=>ke(u?.id,t?.id),e[10]=u?.id,e[11]=t?.id,e[12]=h):h=e[12];const g=!!u?.id&&!!t?.id;let b;e[13]!==r||e[14]!==h||e[15]!==g?(b={queryKey:r,queryFn:h,enabled:g,staleTime:3e5},e[13]=r,e[14]=h,e[15]=g,e[16]=b):b=e[16];const{data:M}=se(b),c=!!M,d=M?.role||null,P=u?.id;let _;e[17]!==P?(_=["posts","community",P],e[17]=P,e[18]=_):_=e[18];let S;e[19]!==u?.id?(S=J=>{const{pageParam:$}=J;return Le(u?.id,$,10)},e[19]=u?.id,e[20]=S):S=e[20];const R=!!u?.id;let D;e[21]!==_||e[22]!==S||e[23]!==R?(D={queryKey:_,queryFn:S,enabled:R,initialPageParam:null,getNextPageParam:pt},e[21]=_,e[22]=S,e[23]=R,e[24]=D):D=e[24];const{data:T,fetchNextPage:k,hasNextPage:B,isFetchingNextPage:E,isLoading:Q}=Y(D);let C;e[25]!==T?.pages?(C=T?.pages.flatMap(Pt)||[],e[25]=T?.pages,e[26]=C):C=e[26];const A=C;let L;e[27]!==u?.id||e[28]!==t?.id?(L=()=>pe(u?.id,t?.id),e[27]=u?.id,e[28]=t?.id,e[29]=L):L=e[29];let O;e[30]!==u?.id||e[31]!==t?.id||e[32]!==i||e[33]!==a?(O=async()=>{await a.cancelQueries({queryKey:["community",u?.id,"membership",t?.id]}),await a.cancelQueries({queryKey:["community",i]});const J=a.getQueryData(["community",u?.id,"membership",t?.id]),$=a.getQueryData(["community",i]);return a.setQueryData(["community",u?.id,"membership",t?.id],J?null:{role:"member"}),a.setQueryData(["community",i],F=>F&&{...F,membersCount:J?F.membersCount-1:F.membersCount+1}),{previousMembership:J,previousCommunity:$}},e[30]=u?.id,e[31]=t?.id,e[32]=i,e[33]=a,e[34]=O):O=e[34];let K;e[35]!==o||e[36]!==u?.id||e[37]!==t?.id||e[38]!==i||e[39]!==a?(K=(J,$,F)=>{F?.previousMembership!==void 0&&a.setQueryData(["community",u?.id,"membership",t?.id],F.previousMembership),F?.previousCommunity&&a.setQueryData(["community",i],F.previousCommunity),o("Failed to update membership","error")},e[35]=o,e[36]=u?.id,e[37]=t?.id,e[38]=i,e[39]=a,e[40]=K):K=e[40];let H;e[41]!==u?.id||e[42]!==t?.id||e[43]!==i||e[44]!==a?(H=()=>{a.invalidateQueries({queryKey:["community",u?.id,"membership",t?.id]}),a.invalidateQueries({queryKey:["community",i]})},e[41]=u?.id,e[42]=t?.id,e[43]=i,e[44]=a,e[45]=H):H=e[45];let z;e[46]!==o||e[47]!==u?(z=J=>{u&&o(J?`Joined ${u.name}`:`Left ${u.name}`)},e[46]=o,e[47]=u,e[48]=z):z=e[48];let j;e[49]!==L||e[50]!==O||e[51]!==K||e[52]!==H||e[53]!==z?(j={mutationFn:L,onMutate:O,onError:K,onSettled:H,onSuccess:z},e[49]=L,e[50]=O,e[51]=K,e[52]=H,e[53]=z,e[54]=j):j=e[54];const N=ne(j);let V;e[55]!==o||e[56]!==t||e[57]!==N?(V=async()=>{if(!t)return o("Please login to join communities","error");N.mutate()},e[55]=o,e[56]=t,e[57]=N,e[58]=V):V=e[58];const G=V;let x;return e[59]!==o||e[60]!==u||e[61]!==A||e[62]!==t||e[63]!==k||e[64]!==G||e[65]!==B||e[66]!==E||e[67]!==c||e[68]!==N.isPending||e[69]!==l||e[70]!==Q||e[71]!==s||e[72]!==v||e[73]!==d?(x={community:u,loading:l,isMember:c,userRole:d,isJoining:N.isPending,communityPosts:A,loadingPosts:Q,isFetchingMorePosts:E,hasMorePosts:B,handleJoinToggle:G,loadCommunityPosts:k,refetchCommunity:v,currentUser:t,addToast:o,navigate:s},e[59]=o,e[60]=u,e[61]=A,e[62]=t,e[63]=k,e[64]=G,e[65]=B,e[66]=E,e[67]=c,e[68]=N.isPending,e[69]=l,e[70]=Q,e[71]=s,e[72]=v,e[73]=d,e[74]=x):x=e[74],x};function pt(e){if(!(!e||e.length<10))return e[e.length-1].sort_timestamp}function Pt(e){return e}var vt=W();const Yt=()=>{const e=(0,vt.c)(48),{currentUser:i}=te(),s=U(),[t,o]=ce();let a;e[0]!==t?(a=t.get("q")||"",e[0]=t,e[1]=a):a=e[1];const n=a;let y;e[2]!==t||e[3]!==n?(y=t.get("tab")||(n?"posts":"communities"),e[2]=t,e[3]=n,e[4]=y):y=e[4];const m=y,[f,u]=(0,q.useState)(!1);let l;e[5]===Symbol.for("react.memo_cache_sentinel")?(l=["explore","communities"],e[5]=l):l=e[5];let v;e[6]===Symbol.for("react.memo_cache_sentinel")?(v={queryKey:l,queryFn:wt,initialPageParam:null,getNextPageParam:_t},e[6]=v):v=e[6];const{data:w,fetchNextPage:p,hasNextPage:r,isFetchingNextPage:h,isLoading:g}=Y(v);let b;e[7]!==w?.pages?(b=w?.pages.flatMap(bt)||[],e[7]=w?.pages,e[8]=b):b=e[8];const M=b;let c,d;e[9]!==n?(c=["explore","posts",n],d=j=>{const{pageParam:N}=j;return n?be(n,N,10,!0):Ne(N,10)},e[9]=n,e[10]=c,e[11]=d):(c=e[10],d=e[11]);let P;e[12]!==c||e[13]!==d?(P={queryKey:c,queryFn:d,initialPageParam:null,getNextPageParam:Mt},e[12]=c,e[13]=d,e[14]=P):P=e[14];const{data:_,fetchNextPage:S,hasNextPage:R,isFetchingNextPage:D,isLoading:T}=Y(P);let k;e[15]!==_?.pages?(k=_?.pages.flatMap(St)||[],e[15]=_?.pages,e[16]=k):k=e[16];const B=k;let E=M;if(n){let j;if(e[17]!==E||e[18]!==n){let N;e[20]!==n?(N=V=>V.name?.toLowerCase().includes(n.toLowerCase())||V.handle?.toLowerCase().includes(n.toLowerCase()),e[20]=n,e[21]=N):N=e[21],j=E.filter(N),e[17]=E,e[18]=n,e[19]=j}else j=e[19];E=j}const Q=E;let C;e[22]!==s?(C=j=>{s(`/c/${j}`)},e[22]=s,e[23]=C):C=e[23];const A=C;let L;e[24]!==o?(L=j=>{o(N=>(j?N.set("q",j):N.delete("q"),N),{replace:!0})},e[24]=o,e[25]=L):L=e[25];const O=L;let K;e[26]!==o?(K=j=>{o(N=>(N.set("tab",j),N),{replace:!0})},e[26]=o,e[27]=K):K=e[27];const H=K;let z;return e[28]!==m||e[29]!==M||e[30]!==i||e[31]!==p||e[32]!==S||e[33]!==Q||e[34]!==A||e[35]!==O||e[36]!==H||e[37]!==r||e[38]!==R||e[39]!==g||e[40]!==f||e[41]!==h||e[42]!==D||e[43]!==T||e[44]!==s||e[45]!==B||e[46]!==n?(z={currentUser:i,searchQuery:n,setSearchQuery:O,activeTab:m,setActiveTab:H,isCreateModalOpen:f,setIsCreateModalOpen:u,communitiesData:M,isCommunitiesLoading:g,isFetchingMoreCommunities:h,hasMoreCommunities:r,postsData:B,isPostsLoading:T,isFetchingMorePosts:D,hasMorePosts:R,filteredCommunities:Q,handleCommunityClick:A,loadCommunities:p,loadPosts:S,navigate:s},e[28]=m,e[29]=M,e[30]=i,e[31]=p,e[32]=S,e[33]=Q,e[34]=A,e[35]=O,e[36]=H,e[37]=r,e[38]=R,e[39]=g,e[40]=f,e[41]=h,e[42]=D,e[43]=T,e[44]=s,e[45]=B,e[46]=n,e[47]=z):z=e[47],z};function wt(e){const{pageParam:i}=e;return he(i,10)}function _t(e){if(!(!e||e.length<10))return e[e.length-1].createdAt}function bt(e){return e}function Mt(e){if(!(!e||e.length<10))return e[e.length-1].sort_timestamp}function St(e){return e}var Rt=W();const Zt=()=>{const e=(0,Rt.c)(21),{currentUser:i}=te(),{posts:s,loading:t,hasMore:o,isFetchingNextPage:a,fetchNextPage:n,refreshPosts:y}=Ke(),{addToast:m}=ie(),f=U();let u;e[0]===Symbol.for("react.memo_cache_sentinel")?(u=["stories"],e[0]=u):u=e[0];let l;e[1]===Symbol.for("react.memo_cache_sentinel")?(l={queryKey:u,queryFn:$t,initialPageParam:null,getNextPageParam:qt,refetchInterval:6e4},e[1]=l):l=e[1];const{data:v,isLoading:w}=Y(l);let p;if(e[2]!==v?.pages){const d=v?.pages.flatMap(Ct)||[],P=JSON.parse(localStorage.getItem("seenStories")||"[]");p=d.reduce(Ft,[]).map(_=>({..._,isSeen:P.includes(_.user.id)})),e[2]=v?.pages,e[3]=p}else p=e[3];const r=p;let h;e[4]!==f?(h=d=>{f(`/post/${d}`)},e[4]=f,e[5]=h):h=e[5];const g=h;let b;e[6]!==f?(b=d=>{f(`/u/${d}`)},e[6]=f,e[7]=b):b=e[7];const M=b;let c;return e[8]!==m||e[9]!==i||e[10]!==n||e[11]!==r||e[12]!==g||e[13]!==M||e[14]!==o||e[15]!==s||e[16]!==a||e[17]!==t||e[18]!==w||e[19]!==y?(c={currentUser:i,homePosts:s,groupedStories:r,isPostsLoading:t,isStoriesLoading:w,hasMore:o,isFetchingNextPage:a,fetchNextPage:n,refreshPosts:y,addToast:m,handlePostClick:g,handleUserClick:M},e[8]=m,e[9]=i,e[10]=n,e[11]=r,e[12]=g,e[13]=M,e[14]=o,e[15]=s,e[16]=a,e[17]=t,e[18]=w,e[19]=y,e[20]=c):c=e[20],c};function $t(e){const{pageParam:i}=e;return ye(i,10)}function qt(e){if(!(!e||e.length<10))return e[e.length-1].created_at}function Ct(e){return e}function Ft(e,i){const s=e.find(t=>t.user.id===i.user_id);return s?s.stories.push(i):e.push({user:i.user,stories:[i],isSeen:!1}),e}var kt=W();const It=()=>{const e=(0,kt.c)(59),{id:i}=ae(),s=U(),{currentUser:t}=te(),{onlineUsers:o}=ze(),a=ee(),[n,y]=(0,q.useState)("");let m;e[0]===Symbol.for("react.memo_cache_sentinel")?(m=[],e[0]=m):m=e[0];const[f,u]=(0,q.useState)(m),{conversations:l,isConvLoading:v,refetchConversations:w,refetchMessages:p,sendMessage:r,sendTypingStatus:h,typingStatus:g,markAsRead:b,formatMessages:M,onDeleteMessage:c,conversationReactions:d,messages:P,isMsgLoading:_,fetchNextMessages:S,hasMoreMessages:R,isFetchingMoreMessages:D}=Ue(t,i);let T;e:{if(!i||l.length===0){T=null;break e}let F;e[1]!==l||e[2]!==i?(F=l.find(X=>X.id===i)||null,e[1]=l,e[2]=i,e[3]=F):F=e[3],T=F}const k=T;let B,E;e[4]!==i||e[5]!==b?(B=()=>{i&&b(i)},E=[i,b],e[4]=i,e[5]=b,e[6]=B,e[7]=E):(B=e[6],E=e[7]),(0,q.useEffect)(B,E);let Q;e[8]!==l||e[9]!==t?.id||e[10]!==n?(Q=()=>{const F=setTimeout(async()=>{if(n.length>1){const X=await Ae(n),re=l.map(Lt);u(X.filter(le=>le.id!==t?.id&&!re.includes(le.id)))}else u([])},300);return()=>clearTimeout(F)},e[8]=l,e[9]=t?.id,e[10]=n,e[11]=Q):Q=e[11];const C=t?.id;let A;e[12]!==l||e[13]!==n||e[14]!==C?(A=[n,l,C],e[12]=l,e[13]=n,e[14]=C,e[15]=A):A=e[15],(0,q.useEffect)(Q,A);let L;e[16]!==t||e[17]!==s||e[18]!==a?(L=async F=>{if(t)try{const X=await Ce(t.id,F.id);a.invalidateQueries({queryKey:["conversations",t.id]}),y(""),s(`/messages/${X}`)}catch(X){console.error("Failed to start conversation:",X)}},e[16]=t,e[17]=s,e[18]=a,e[19]=L):L=e[19];const O=L;let K;e[20]!==s?(K=F=>{s(`/messages/${F.id}`)},e[20]=s,e[21]=K):K=e[21];const H=K;let z;e[22]!==d||e[23]!==M||e[24]!==P?(z=M(P,d),e[22]=d,e[23]=M,e[24]=P,e[25]=z):z=e[25];const j=z;let N;if(e[26]!==l||e[27]!==n){let F;e[29]!==n?(F=X=>X.user?.name?.toLowerCase().includes(n.toLowerCase())||X.user?.handle?.toLowerCase().includes(n.toLowerCase())||X.lastMessage?.toLowerCase().includes(n.toLowerCase()),e[29]=n,e[30]=F):F=e[30],N=l.filter(F),e[26]=l,e[27]=n,e[28]=N}else N=e[28];const V=N,G=k&&g[k.id];let x;e[31]!==o||e[32]!==k?(x=k&&k.user?.id&&o.has(k.user.id),e[31]=o,e[32]=k,e[33]=x):x=e[33];const J=x;let $;return e[34]!==l||e[35]!==G||e[36]!==t||e[37]!==S||e[38]!==V||e[39]!==H||e[40]!==O||e[41]!==R||e[42]!==i||e[43]!==v||e[44]!==D||e[45]!==_||e[46]!==j||e[47]!==n||e[48]!==s||e[49]!==c||e[50]!==o||e[51]!==J||e[52]!==w||e[53]!==p||e[54]!==k||e[55]!==r||e[56]!==h||e[57]!==f?($={id:i,currentUser:t,onlineUsers:o,msgSearchQuery:n,setMsgSearchQuery:y,userSearchResults:f,conversations:l,filteredConversations:V,selectedConversation:k,localMessages:j,isConvLoading:v,isMsgLoading:_,currentIsTyping:G,otherUserIsOnline:J,handleStartConversation:O,handleSelectConversation:H,refetchConversations:w,refetchMessages:p,sendMessage:r,onDeleteMessage:c,sendTypingStatus:h,navigate:s,fetchNextMessages:S,hasMoreMessages:R,isFetchingMoreMessages:D},e[34]=l,e[35]=G,e[36]=t,e[37]=S,e[38]=V,e[39]=H,e[40]=O,e[41]=R,e[42]=i,e[43]=v,e[44]=D,e[45]=_,e[46]=j,e[47]=n,e[48]=s,e[49]=c,e[50]=o,e[51]=J,e[52]=w,e[53]=p,e[54]=k,e[55]=r,e[56]=h,e[57]=f,e[58]=$):$=e[58],$};function Lt(e){return e.user?.id}var Nt=W();const Ut=()=>{const e=(0,Nt.c)(48),{currentUser:i}=te(),s=U(),t=ee(),o=i?.id;let a;e[0]!==o?(a=["notifications",o],e[0]=o,e[1]=a):a=e[1];let n;e[2]!==i?.id?(n=C=>{const{pageParam:A}=C;return qe(i?.id,A,10)},e[2]=i?.id,e[3]=n):n=e[3];const y=!!i?.id;let m;e[4]!==a||e[5]!==n||e[6]!==y?(m={queryKey:a,queryFn:n,enabled:y,initialPageParam:null,getNextPageParam:Tt},e[4]=a,e[5]=n,e[6]=y,e[7]=m):m=e[7];const{data:f,fetchNextPage:u,hasNextPage:l,isFetchingNextPage:v,isLoading:w,refetch:p}=Y(m);let r;e[8]!==f?.pages?(r=f?.pages.flatMap(xt)||[],e[8]=f?.pages,e[9]=r):r=e[9];const h=r;let g;e[10]!==i||e[11]!==t?(g=()=>{if(!i?.id)return;const C=I.channel(`user_notifications:${i.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`recipient_id=eq.${i.id}`},()=>{t.invalidateQueries({queryKey:["notifications",i.id]})}).subscribe();return()=>{I.removeChannel(C)}},e[10]=i,e[11]=t,e[12]=g):g=e[12];const b=i?.id;let M;e[13]!==t||e[14]!==b?(M=[b,t],e[13]=t,e[14]=b,e[15]=M):M=e[15],(0,q.useEffect)(g,M);let c;e[16]!==i?(c=()=>i?Ee(i.id):Promise.resolve(),e[16]=i,e[17]=c):c=e[17];let d,P,_;e[18]!==i?.id||e[19]!==t?(d=async()=>{await t.cancelQueries({queryKey:["notifications",i?.id]});const C=t.getQueryData(["notifications",i?.id]);return t.setQueryData(["notifications",i?.id],Kt),{previousNotifications:C}},P=(C,A,L)=>{L?.previousNotifications&&t.setQueryData(["notifications",i?.id],L.previousNotifications)},_=()=>{t.invalidateQueries({queryKey:["notifications",i?.id]})},e[18]=i?.id,e[19]=t,e[20]=d,e[21]=P,e[22]=_):(d=e[20],P=e[21],_=e[22]);let S;e[23]!==d||e[24]!==P||e[25]!==_||e[26]!==c?(S={mutationFn:c,onMutate:d,onError:P,onSettled:_},e[23]=d,e[24]=P,e[25]=_,e[26]=c,e[27]=S):S=e[27];const R=ne(S);let D;e[28]!==s?(D=C=>{C.type==="follow"?s(`/u/${C.user}`):C.post_id&&s(`/post/${C.post_id}`)},e[28]=s,e[29]=D):D=e[29];const T=D;let k;e[30]!==i?.id||e[31]!==R||e[32]!==h?(k=()=>{i?.id&&h.some(Et)&&R.mutate()},e[30]=i?.id,e[31]=R,e[32]=h,e[33]=k):k=e[33];const B=i?.id;let E;e[34]!==R||e[35]!==h.length||e[36]!==B?(E=[B,h.length,R],e[34]=R,e[35]=h.length,e[36]=B,e[37]=E):E=e[37],(0,q.useEffect)(k,E);let Q;return e[38]!==i||e[39]!==u||e[40]!==T||e[41]!==l||e[42]!==v||e[43]!==w||e[44]!==s||e[45]!==h||e[46]!==p?(Q={currentUser:i,notifications:h,isLoading:w,isFetchingMore:v,hasMore:l,loadNotifications:u,refreshNotifications:p,handleNotificationClick:T,navigate:s},e[38]=i,e[39]=u,e[40]=T,e[41]=l,e[42]=v,e[43]=w,e[44]=s,e[45]=h,e[46]=p,e[47]=Q):Q=e[47],Q};function Tt(e){if(!(!e||e.length<10))return e[e.length-1].created_at}function xt(e){return e}function Dt(e){return{...e,is_read:!0}}function Qt(e){return e.map(Dt)}function Kt(e){return e&&{...e,pages:e.pages.map(Qt)}}function Et(e){return!e.is_read}var At=W();const es=()=>{const e=(0,At.c)(23),{id:i}=ae(),s=U(),{currentUser:t}=te(),{addToast:o}=ie(),a=ee();let n,y;e[0]!==i?(n=["post",i],y=async()=>{if(!i||!Z(i))throw new Error("Invalid post ID");return Te(i)},e[0]=i,e[1]=n,e[2]=y):(n=e[1],y=e[2]);const m=!!i;let f;e[3]!==n||e[4]!==y||e[5]!==m?(f={queryKey:n,queryFn:y,enabled:m,retry:!1},e[3]=n,e[4]=y,e[5]=m,e[6]=f):f=e[6];const{data:u,isLoading:l,isError:v}=se(f);let w;e[7]!==s?(w=c=>{s(`/u/${c}`)},e[7]=s,e[8]=w):w=e[8];const p=w;let r;e[9]!==s?(r=()=>{s(-1)},e[9]=s,e[10]=r):r=e[10];const h=r;let g;e[11]!==a?(g=(c,d,P)=>{a.setQueryData(["post",c],_=>_&&{..._,content:d,media:P})},e[11]=a,e[12]=g):g=e[12];const b=g;let M;return e[13]!==o||e[14]!==t||e[15]!==h||e[16]!==b||e[17]!==p||e[18]!==v||e[19]!==l||e[20]!==s||e[21]!==u?(M={post:u,isLoading:l,isError:v,currentUser:t,addToast:o,navigate:s,handleUserClick:p,handleDelete:h,handleUpdate:b},e[13]=o,e[14]=t,e[15]=h,e[16]=b,e[17]=p,e[18]=v,e[19]=l,e[20]=s,e[21]=u,e[22]=M):M=e[22],M},ts=()=>{const e=U(),{id:i}=ae(),[s]=ce(),t=i||s.get("id"),o=(0,q.useRef)(null),a=(0,q.useRef)(new Map),[n,y]=(0,q.useState)(null),[m,f]=(0,q.useState)(!0),{data:u,fetchNextPage:l,hasNextPage:v,isFetchingNextPage:w,isLoading:p}=Y({queryKey:["reels"],queryFn:({pageParam:c})=>Me(c,10),initialPageParam:null,getNextPageParam:c=>{if(!(!c||c.length<10))return c[c.length-1].sort_timestamp||c[c.length-1].created_at}}),r=(0,q.useMemo)(()=>u?.pages.flatMap(c=>c)||[],[u]);(0,q.useEffect)(()=>{if(r.length>0)if(t)if(r.find(c=>c.id===t)){y(t);const c=a.current.get(t);c&&c.scrollIntoView({behavior:"instant"})}else n||y(r[0].id);else n||y(r[0].id)},[r,t,n]),(0,q.useEffect)(()=>{if(r.length===0)return;const c={root:o.current,threshold:.6},d=_=>{_.forEach(S=>{if(S.isIntersecting){const R=S.target.getAttribute("data-id");R&&y(R)}})},P=new IntersectionObserver(d,c);return a.current.forEach(_=>P.observe(_)),()=>P.disconnect()},[r.length]);const h=()=>{f(!m)};(0,q.useEffect)(()=>{const c=d=>{const P=d.target;if(!(P.tagName==="INPUT"||P.tagName==="TEXTAREA"||P.isContentEditable)&&!(d.ctrlKey||d.altKey||d.metaKey))switch(d.key){case"ArrowUp":d.preventDefault(),b();break;case"ArrowDown":d.preventDefault(),g();break;case"m":case"M":h();break;case" ":d.preventDefault();const _=a.current.get(n||"");if(_){const S=_.querySelector(".reel-item");S&&S.click()}break}};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[n,r,m]);const g=()=>{if(r.length===0)return;const c=r.findIndex(d=>d.id===n);if(c<r.length-1){const d=r[c+1];a.current.get(d.id)?.scrollIntoView({behavior:"smooth"})}},b=()=>{if(r.length===0)return;const c=r.findIndex(d=>d.id===n);if(c>0){const d=r[c-1];a.current.get(d.id)?.scrollIntoView({behavior:"smooth"})}},M=(c,d)=>{d?a.current.set(c,d):a.current.delete(c)};return(0,q.useEffect)(()=>{const c=()=>{if(!o.current||w||!v)return;const{scrollTop:P,scrollHeight:_,clientHeight:S}=o.current;P+S>=_-800&&l()},d=o.current;if(d)return d.addEventListener("scroll",c),()=>d.removeEventListener("scroll",c)},[w,v,l]),{reels:r,loading:p,loadingMore:w,activeReelId:n,hasMore:v,isMuted:m,containerRef:o,setReelRef:M,navigate:e,toggleMute:h,scrollToNext:g,scrollToPrev:b,loadReels:l}},ss=()=>{const{currentUser:e,logout:i}=te(),{darkMode:s,toggleDarkMode:t,fontSize:o,setFontSize:a,dataSaver:n,setDataSaver:y}=je(),{addToast:m}=ie(),[f,u]=(0,q.useState)(!1),[l,v]=(0,q.useState)({newPassword:"",confirmPassword:""}),[w,p]=(0,q.useState)(!1),r=async()=>{try{await i(),m("Logged out successfully")}catch(P){console.error("Logout error:",P),m("Failed to logout")}};return{currentUser:e,darkMode:s,toggleDarkMode:t,fontSize:o,setFontSize:a,dataSaver:n,setDataSaver:y,isChangingPassword:f,setIsChangingPassword:u,passwordData:l,setPasswordData:v,loading:w,handleLogout:r,handlePasswordChange:async P=>{if(P.preventDefault(),l.newPassword!==l.confirmPassword){m("Passwords do not match","error");return}if(l.newPassword.length<6){m("Password must be at least 6 characters","error");return}p(!0);try{const{error:_}=await I.auth.updateUser({password:l.newPassword});if(_)throw _;m("Password updated successfully!"),u(!1),v({newPassword:"",confirmPassword:""})}catch(_){console.error("Password update error:",_),m(_.message||"Failed to update password","error")}finally{p(!1)}},handlePasswordReset:async()=>{if(e?.email){p(!0);try{const{error:P}=await I.auth.resetPasswordForEmail(e.email,{redirectTo:`${window.location.origin}/settings?type=recovery`});if(P)throw P;m("Password reset email sent!")}catch(P){console.error("Reset password error:",P),m(P.message||"Failed to send reset email","error")}finally{p(!1)}}},handleClearCache:()=>{["seenStories","font-size","data-saver","theme"].forEach(P=>localStorage.removeItem(P)),m("Cache cleared! Reloading..."),setTimeout(()=>window.location.reload(),1500)},handleDownloadData:async()=>{if(e){p(!0);try{const P={user:{id:e.id,handle:e.handle,name:e.name,email:e.email},exportDate:new Date().toISOString(),note:"This is a mock export of your Sysm data."},_=new Blob([JSON.stringify(P,null,2)],{type:"application/json"}),S=URL.createObjectURL(_),R=document.createElement("a");R.href=S,R.download=`sysm-data-${e.handle}.json`,R.click(),URL.revokeObjectURL(S),m("Data export started!")}catch{m("Failed to export data","error")}finally{p(!1)}}},handleDeleteAccount:()=>{window.confirm("Are you absolutely sure? This will permanently delete your account and all associated data. This action is irreversible.")&&(m("Account deletion request submitted. Logging out..."),setTimeout(r,2e3))},handleReportBug:()=>{window.prompt("Please describe the bug you found:")&&m("Bug reported! Thank you for your feedback.")}}};export{It as a,Xt as c,Vt as d,Ht as f,Ut as i,Wt as l,ts as n,Zt as o,zt as p,es as r,Yt as s,ss as t,Gt as u};
