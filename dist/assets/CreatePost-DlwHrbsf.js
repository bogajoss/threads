import{a as K}from"./rolldown-runtime-BaZ8gS7u.js";import{o as fe,s as je}from"./animations-DnIvWaa_.js";import{_ as ve,g as ye}from"./framework-qAfQIUpw.js";import{r as Ne}from"./query-gr-7CPJN.js";import"./database-CdmW3A7f.js";import{Bn as we,Hn as ke,Ht as Ce,Lt as Se,Mn as Pe,Mt as ze,Nn as Ae,On as Re,Qt as Ie,Rn as Te,Vt as Fe,bn as Le,kn as Oe,kt as E,vn as Ue}from"./ui-libs-lxLEvj1Y.js";import"./media-libs-BYH8vgqC.js";import{Ct as $,G as We,H as q,Lt as Me,Mn as De,Nn as y,Pt as Ve,Rt as He,St as G,U as p,V as B,Vt as Ee,W as Q,it as $e,on as qe,s as Ge,wt as X}from"./index-C9BsG0eP.js";import{n as N,t as Be}from"./actionsheet-DjOSXiwB.js";import{t as Qe}from"./useAutoResizeTextArea-BBIEBn4G.js";import{t as Xe}from"./CircularProgress-BRwgxxRf.js";var o=K(je(),1),e=K(fe(),1),g=500,Ke=()=>{const b=ve(),J=ye(),{currentUser:i}=Ee(),{addPost:Y}=Me(),{addToast:x}=He(),Z=J.state?.initialCommunity,[c,_]=(0,o.useState)(""),[f,ee]=(0,o.useState)(""),[u,w]=(0,o.useState)([]),[z,te]=(0,o.useState)({}),[j,A]=(0,o.useState)({}),[v,se]=(0,o.useState)(!1),[d,k]=(0,o.useState)({options:["",""],duration:"1 day"}),[R,I]=(0,o.useState)(!1),[T,ae]=(0,o.useState)(Z||null),[h,ne]=(0,o.useState)("anyone"),[C,F]=(0,o.useState)(null),[L,O]=(0,o.useState)(null),[U,W]=(0,o.useState)(null),[oe,m]=(0,o.useState)(!1),le=Qe(c,44,400),M=(0,o.useRef)(null),D=(0,o.useRef)(null),{data:S=[]}=Ne({queryKey:["user-communities",i?.id],queryFn:()=>qe(i.id),enabled:!!i?.id}),re=t=>new Promise(a=>{const s=document.createElement("video");s.preload="auto",s.src=URL.createObjectURL(t),s.muted=!0,s.playsInline=!0,s.onloadeddata=()=>{s.currentTime=Math.min(1,s.duration/2)},s.onseeked=()=>{setTimeout(()=>{try{const n=document.createElement("canvas");n.width=s.videoWidth,n.height=s.videoHeight,n.getContext("2d")?.drawImage(s,0,0,n.width,n.height),a(n.toDataURL("image/jpeg",.7))}catch(n){console.error("Error capturing thumbnail:",n),a("")}finally{s.remove()}},150)},s.onerror=()=>{a("")}}),ie=async t=>{if(!t.target.files)return;const a=Array.from(t.target.files).map(s=>({id:Math.random().toString(36).substring(2,11),file:s}));w(s=>[...s,...a]);for(const s of a)if(s.file.type.startsWith("video/"))try{const n=await re(s.file);n&&te(l=>({...l,[s.id]:n}))}catch(n){console.error("Thumbnail generation failed",n)}},ce=t=>{if(!t.target.files||!U)return;const a=t.target.files[0];A(s=>({...s,[U]:a})),W(null)},de=t=>{w(a=>a.filter(s=>s.id!==t)),A(a=>{const s={...a};return delete s[t],s})},ue=()=>{d.options.length<4&&k(t=>({...t,options:[...t.options,""]}))},me=t=>{k(a=>({...a,options:a.options.filter((s,n)=>n!==t)}))},xe=(t,a)=>{const s=[...d.options];s[t]=a,k(n=>({...n,options:s}))},he=t=>{const a=new File([t],`cropped-${Date.now()}.jpg`,{type:"image/jpeg"});L&&w(s=>s.map(n=>n.id===L?{...n,file:a}:n)),F(null),O(null)},pe=async()=>{if(i&&!(!c.trim()&&u.length===0)&&!(c.length>g)){I(!0);try{const t=[];for(let l=0;l<u.length;l++){const r=u[l],ge=j[r.id]||null,be=await De(r.file,"media",ge);t.push(be)}let a=null;v&&d.options.some(l=>l.trim())&&(a={options:d.options.filter(l=>l.trim()).map((l,r)=>({id:r+1,text:l,votes:0})),ends_at:new Date(Date.now()+1440*60*1e3).toISOString()});let s=c;if(f.trim()){const l=f.split(",").map(r=>r.trim()).filter(r=>r.length>0).map(r=>r.startsWith("#")?r:`#${r}`).join(" ");s+=`

${l}`}let n="text";t.length>0?n=t[0].type==="video"?"video":"image":a&&(n="poll"),await Y({content:s,media:t,poll:a,type:n,userId:i.id,communityId:T?.id||null}),x("Post published!"),b("/feed")}catch(t){console.error("Failed to create post:",t),x("Failed to publish content.","error")}finally{I(!1)}}};if(!i)return b("/login"),null;const V=!c.trim()&&u.length===0||R||c.length>g,P=g-c.length,H=c.length>g-20;return(0,e.jsx)(Ge,{children:(0,e.jsxs)("div",{className:"flex flex-col min-h-screen bg-[--background] text-[--foreground] md:max-w-xl md:mx-auto border-x border-[--border] shadow-2xl",children:[(0,e.jsxs)("div",{className:"flex items-center justify-between px-6 py-4 sticky top-0 bg-[--background]/90 backdrop-blur-xl z-20 border-b border-[--border]",children:[(0,e.jsx)("button",{onClick:()=>b(-1),className:"text-[15px] font-medium text-neutral-500 hover:text-[--foreground] transition-colors",children:"Cancel"}),(0,e.jsx)("h1",{className:"text-[17px] font-bold tracking-tight",children:"New thread"}),(0,e.jsx)("button",{onClick:()=>m(!0),className:"text-[--foreground] p-1.5 hover:bg-neutral-100 dark:hover:bg-neutral-800 rounded-full transition-all",children:(0,e.jsx)(ke,{size:22})})]}),(0,e.jsx)("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:(0,e.jsxs)("div",{className:"flex px-6 pt-6 pb-20",children:[(0,e.jsxs)("div",{className:"flex flex-col items-center mr-4 pt-1",children:[(0,e.jsxs)(G,{className:"w-10 h-10 border-[3px] border-[--background] ring-1 ring-[--border]",children:[(0,e.jsx)(X,{src:i.avatar,className:"object-cover"}),(0,e.jsx)($,{children:i.name?.[0].toUpperCase()})]}),(0,e.jsx)("div",{className:"w-[2px] flex-1 bg-neutral-200 dark:bg-neutral-800 my-2 rounded-full min-h-[80px]"}),(0,e.jsx)("div",{className:"relative",children:(0,e.jsxs)(G,{className:"w-5 h-5 opacity-40 grayscale hover:opacity-100 hover:grayscale-0 transition-all cursor-pointer",children:[(0,e.jsx)(X,{src:i.avatar,className:"object-cover"}),(0,e.jsx)($,{className:"text-[7px]",children:i.name?.[0]})]})})]}),(0,e.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,e.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,e.jsx)("span",{className:"font-bold text-[15px] tracking-tight hover:underline cursor-pointer",children:i.name}),S.length>0&&(0,e.jsxs)(B,{onValueChange:t=>{ae(S.find(a=>a.id===t)||null)},value:T?.id||"none",children:[(0,e.jsxs)(Q,{className:"h-7 px-3 py-0 border-none bg-neutral-100 dark:bg-neutral-900 text-[12px] font-bold rounded-full w-auto gap-1.5 focus:ring-0 hover:bg-neutral-200 dark:hover:bg-neutral-800 transition-colors",children:[(0,e.jsx)(ze,{size:12,className:"text-neutral-500"}),(0,e.jsx)(We,{placeholder:"Anyone"})]}),(0,e.jsxs)(q,{align:"end",className:"bg-[--background] border-[--border] shadow-xl rounded-xl",children:[(0,e.jsx)(p,{value:"none",className:"text-xs font-medium py-2.5",children:"Public (Anyone)"}),S.map(t=>(0,e.jsx)(p,{value:t.id,className:"text-xs font-medium py-2.5",children:t.name},t.id))]})]})]}),(0,e.jsxs)("div",{className:"relative",children:[(0,e.jsx)("textarea",{ref:le,placeholder:"What's new?",value:c,onChange:t=>_(t.target.value),className:y("w-full bg-transparent text-[--foreground] placeholder-neutral-500 outline-none resize-none text-[16px] leading-relaxed min-h-[44px] mb-1 transition-colors",P<0&&"text-rose-500")}),c.length>0&&(0,e.jsxs)("div",{className:"absolute right-0 bottom-2 flex items-center gap-3",children:[(0,e.jsx)(Xe,{current:c.length,max:g,size:22,strokeWidth:2.5,isWarning:H}),H&&(0,e.jsx)("span",{className:y("text-[11px] font-bold",P<0?"text-rose-500":"text-neutral-500"),children:P})]})]}),u.length>0&&(0,e.jsxs)("div",{className:"flex overflow-x-auto gap-3.5 mb-5 mt-2 pb-1 scrollbar-hide snap-x",children:[u.map(t=>(0,e.jsxs)("div",{className:"relative shrink-0 w-[260px] h-[340px] rounded-2xl overflow-hidden border border-[--border] bg-neutral-100 dark:bg-neutral-900 snap-start shadow-md group",children:[t.file.type.startsWith("video/")?(0,e.jsxs)(e.Fragment,{children:[j[t.id]||z[t.id]?(0,e.jsx)("img",{src:j[t.id]?URL.createObjectURL(j[t.id]):z[t.id],className:"w-full h-full object-cover",alt:"Video thumbnail"}):(0,e.jsx)("video",{src:URL.createObjectURL(t.file),className:"w-full h-full object-cover",muted:!0,playsInline:!0}),(0,e.jsx)("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent flex flex-col justify-end p-4 transition-all duration-300",children:(0,e.jsx)("div",{className:"flex items-center justify-start",children:(0,e.jsxs)("button",{type:"button",onClick:a=>{a.stopPropagation(),W(t.id),M.current?.click()},className:"text-[11px] font-bold text-white bg-black/60 backdrop-blur-xl px-3 py-2 rounded-full flex items-center gap-2 hover:bg-black/80 transition-colors shadow-lg border border-white/10",children:[(0,e.jsx)(Oe,{size:14}),(0,e.jsx)("span",{children:"Change Cover"})]})})})]}):(0,e.jsx)("img",{src:URL.createObjectURL(t.file),alt:"preview",className:"w-full h-full object-cover"}),(0,e.jsx)("button",{onClick:()=>de(t.id),className:"absolute top-3.5 right-3.5 bg-black/50 backdrop-blur-lg text-white rounded-full p-2 hover:bg-rose-500 transition-all z-10 shadow-xl group-hover:scale-110 active:scale-90",children:(0,e.jsx)(E,{size:18})})]},t.id)),(0,e.jsx)("input",{type:"file",ref:M,className:"hidden",accept:"image/*",onChange:ce})]}),v&&(0,e.jsxs)("div",{className:"space-y-2.5 mb-5 mt-2 bg-neutral-50 dark:bg-neutral-900/40 p-4 rounded-3xl border border-[--border]",children:[d.options.map((t,a)=>(0,e.jsxs)("div",{className:"flex gap-2",children:[(0,e.jsx)("input",{className:"w-full rounded-2xl border border-[--border] bg-[--background] px-4 py-3 text-[14px] font-medium outline-none focus:ring-2 focus:ring-[--primary]/20 transition-all placeholder:text-neutral-400",placeholder:`Option ${a+1}`,value:t,onChange:s=>xe(a,s.target.value)}),d.options.length>2&&(0,e.jsx)("button",{onClick:()=>me(a),className:"text-neutral-400 hover:text-rose-500 transition-all px-1.5",children:(0,e.jsx)(E,{size:22})})]},a)),d.options.length<4&&(0,e.jsx)("button",{onClick:ue,className:"text-[13px] font-black text-neutral-400 hover:text-[--primary] transition-colors ml-1.5 mt-1",children:"+ Add option"})]}),(0,e.jsxs)("div",{className:"flex items-center gap-7 mt-3 text-neutral-400",children:[(0,e.jsx)("button",{onClick:()=>D.current?.click(),className:"hover:text-[--foreground] transition-all p-1 hover:scale-110 active:scale-90",title:"Add Image/Video",children:(0,e.jsx)(Re,{size:22,strokeWidth:2.2})}),(0,e.jsx)("button",{onClick:()=>se(!v),className:y("hover:text-[--foreground] transition-all p-1 hover:scale-110 active:scale-90",v&&"text-[--primary]"),title:"Add Poll",children:(0,e.jsx)(Ce,{size:22,strokeWidth:2.2})}),(0,e.jsx)("button",{className:"hover:text-[--foreground] transition-all p-1 hover:scale-110 active:scale-90",onClick:()=>{const t=prompt("Add a hashtag");t&&ee(a=>a?`${a}, ${t}`:t)},title:"Add Hashtag",children:(0,e.jsx)(Pe,{size:22,strokeWidth:2.2})}),(0,e.jsx)("button",{className:"hover:text-[--foreground] transition-all p-1 opacity-30 cursor-not-allowed",title:"Location",children:(0,e.jsx)(Ue,{size:22,strokeWidth:2.2})})]}),f&&(0,e.jsx)("div",{className:"mt-4 flex flex-wrap gap-2.5",children:f.split(",").map((t,a)=>(0,e.jsxs)("span",{className:"text-[13px] font-bold text-blue-500 bg-blue-500/10 px-3 py-1 rounded-full border border-blue-500/20",children:["#",t.trim().replace(/^#/,"")]},a))})]})]})}),(0,e.jsxs)("div",{className:"flex items-center justify-between px-6 py-5 bg-[--background] border-t border-[--border] sticky bottom-0 z-20",children:[(0,e.jsxs)(B,{value:h,onValueChange:ne,children:[(0,e.jsxs)(Q,{className:"border-none bg-transparent p-0 h-auto w-auto text-neutral-500 text-[14px] font-semibold hover:text-[--foreground] transition-colors gap-1.5 focus:ring-0",children:[h==="anyone"&&(0,e.jsx)(Ae,{size:14}),h==="following"&&(0,e.jsx)(Se,{size:14}),h==="mentioned"&&(0,e.jsx)(Le,{size:14}),(0,e.jsxs)("span",{className:"capitalize",children:[h.replace("-"," ")," can reply"]})]}),(0,e.jsxs)(q,{align:"start",className:"bg-[--background] border-[--border] shadow-2xl rounded-2xl p-1.5",children:[(0,e.jsx)(p,{value:"anyone",className:"rounded-xl py-3 px-4 font-bold",children:"Anyone"}),(0,e.jsx)(p,{value:"following",className:"rounded-xl py-3 px-4 font-bold",children:"Profiles you follow"}),(0,e.jsx)(p,{value:"mentioned",className:"rounded-xl py-3 px-4 font-bold",children:"Mentioned only"})]})]}),(0,e.jsx)("div",{className:"flex items-center gap-3",children:(0,e.jsx)(Ve,{onClick:pe,disabled:V,loading:R,className:y("min-w-[90px] h-11 shadow-xl transition-all active:scale-95 text-[15px]",V?"bg-neutral-100 text-neutral-400 dark:bg-neutral-900 dark:text-neutral-600 shadow-none":"shadow-[--primary]/20 bg-black text-white dark:bg-white dark:text-black"),children:"Post"})})]}),(0,e.jsx)("input",{type:"file",ref:D,onChange:ie,multiple:!0,className:"hidden",accept:"image/*,video/*"}),C&&(0,e.jsx)($e,{src:C,isOpen:!!C,onClose:()=>{F(null),O(null)},onCropComplete:he}),(0,e.jsxs)(Be,{isOpen:oe,onClose:()=>m(!1),title:"Post Options",children:[(0,e.jsx)(N,{icon:(0,e.jsx)(Te,{size:20}),onClick:()=>{x("Draft saved (Simulated)"),m(!1)},children:"Save as draft"}),(0,e.jsx)(N,{icon:(0,e.jsx)(Ie,{size:20}),onClick:()=>{x("Settings coming soon"),m(!1)},children:"Post settings"}),(0,e.jsx)(N,{icon:(0,e.jsx)(we,{size:20}),onClick:()=>{x("Visibility settings coming soon"),m(!1)},children:"Who can see this"}),(0,e.jsx)("div",{className:"h-px bg-[--border] my-1 mx-6"}),(0,e.jsx)(N,{variant:"destructive",icon:(0,e.jsx)(Fe,{size:20}),onClick:()=>{confirm("Discard this post?")&&b(-1),m(!1)},children:"Discard post"})]})]})})},rt=Ke;export{rt as default};
